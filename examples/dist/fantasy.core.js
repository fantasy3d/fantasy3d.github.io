/*!
 * @fantasy3d/core latest@2024-2-25 18:38
 * Copyright Â© yisky 2024-2024 all right reserved
 */
import{WebGLRenderTarget as e,DepthTexture as t,DepthStencilFormat as r,DepthFormat as n,UnsignedInt248Type as i,UnsignedIntType as s,NearestFilter as o,BufferGeometry as a,Float32BufferAttribute as c,AudioLoader as d,FileLoader as l,CubeTextureLoader as h,Texture as p,Cache as u,ShaderMaterial as g,ImageBitmapLoader as m,TextureLoader as f,ShaderChunk as _,Uniform as v,Vector4 as x,Vector2 as y,Matrix4 as w,Clock as z,ColorManagement as P,SRGBColorSpace as b,WebGLRenderer as M,Color as S,NoToneMapping as D,PCFShadowMap as E,Object3D as T,MathUtils as R,Vector3 as A,Raycaster as C,OrthographicCamera as j,PerspectiveCamera as I,Scene as O,FogExp2 as U,Fog as k,EquirectangularReflectionMapping as L,AnimationMixer as B,AnimationClip as F,AmbientLight as N,DirectionalLight as W,HemisphereLight as q,PointLight as K,SpotLight as G,RectAreaLight as H,Box3 as V,NoBlending as Y,HalfFloatType as Q,LinearFilter as $,CubeCamera as Z,WebGLCubeRenderTarget as X,Camera as J,Mesh as ee,Group as te,Plane as re,LinearSRGBColorSpace as ne,UniformsUtils as ie}from"three";import{DRACOLoader as se}from"three/examples/jsm/loaders/DRACOLoader.js";import{EXRLoader as oe}from"three/examples/jsm/loaders/EXRLoader.js";import{GLTFLoader as ae}from"three/examples/jsm/loaders/GLTFLoader.js";import{HDRCubeTextureLoader as ce}from"three/examples/jsm/loaders/HDRCubeTextureLoader.js";import{KTX2Loader as de}from"three/examples/jsm/loaders/KTX2Loader.js";import{MeshoptDecoder as le}from"three/examples/jsm/libs/meshopt_decoder.module.js";import{RGBELoader as he}from"three/examples/jsm/loaders/RGBELoader.js";import{RectAreaLightUniformsLib as pe}from"three/examples/jsm/lights/RectAreaLightUniformsLib.js";import*as ue from"three/examples/jsm/utils/SkeletonUtils.js";var ge,me,fe,_e,ve,xe,ye,we,ze;function Pe(a={}){const{width:c=512,height:d=512,createDepthTexture:l=!1,renderTargetOptions:h}=a,p=new e(c,d,h);if(l){const e=new t(c,d);e.format=p.stencilBuffer?r:n,e.type=p.stencilBuffer?i:s,e.minFilter=o,e.magFilter=o,Me(p.depthTexture)&&(p.depthTexture.dispose(),p.depthTexture=null),p.depthTexture=e}return p}function be(){const e=new a;return e.setAttribute("position",new c([-1,3,0,-1,-1,0,3,-1,0],3)),e.setAttribute("uv",new c([0,2,0,0,2,0],2)),e}function Me(e){return null!=e}function Se(e,t){return Me(e)?e:t}function De(e,t){const r=e.indexOf(t);if(!~r)return!1;const n=e.length-1;if(r!==n){const t=e[n];e[r]=t}return e.length--,!0}!function(e){e[e.NONE=-1]="NONE",e[e.ROTATE=0]="ROTATE",e[e.ZOOM=1]="ZOOM",e[e.PAN=2]="PAN",e[e.TOUCH_ROTATE=3]="TOUCH_ROTATE",e[e.TOUCH_PAN=4]="TOUCH_PAN",e[e.TOUCH_ZOOM_PAN=5]="TOUCH_ZOOM_PAN",e[e.TOUCH_ZOOM_ROTATE=6]="TOUCH_ZOOM_ROTATE"}(ge||(ge={})),function(e){e.ATTRIBUTE_CHANGED="attribute_changed",e.BEFORE_FRAME_LOOP="before_frame_loop",e.AFTER_FRAME_LOOP="after_frame_loop",e.BEFORE_SCENES_RENDER="before_scenes_render",e.AFTER_SCENES_RENDER="after_scenes_render",e.BEFORE_SCENE_RENDER="before_scene_render",e.AFTER_SCENE_RENDER="after_scene_render",e.BEFORE_CAMERA_RENDER="before_camera_render",e.AFTER_CAMERA_RENDER="after_camera_render",e.BEFORE_CAMERA_DEPTH_RENDER="before_camera_depth_render",e.AFTER_CAMERA_DEPTH_RENDER="after_camera_depth_render",e.CAMERA_CHANGED="camera_changed"}(me||(me={})),function(e){e[e.SILENT=0]="SILENT",e[e.LOG=2]="LOG",e[e.WARN=4]="WARN",e[e.ERROR=8]="ERROR"}(fe||(fe={})),function(e){e[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT"}(_e||(_e={})),function(e){e[e.LOW=0]="LOW",e[e.NORMAL=50]="NORMAL",e[e.HIGH=100]="HIGH"}(ve||(ve={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.DEFAULT=50]="DEFAULT",e[e.OVERLAY=100]="OVERLAY"}(xe||(xe={})),function(e){e[e.ROTATE=0]="ROTATE",e[e.PAN=1]="PAN",e[e.ZOOM_PAN=2]="ZOOM_PAN",e[e.ZOOM_ROTATE=3]="ZOOM_ROTATE"}(ye||(ye={}));class Ee{constructor(){this._subscribers=new Map}on(e,t,r={}){const{_subscribers:n}=this;n.has(e)||n.set(e,[]);const i=n.get(e),{priority:s=ve.NORMAL,target:o=null}=r;i.push({priority:s,target:o,callback:t}),i.sort(((e,t)=>t.priority-e.priority))}off(e,t){const{_subscribers:r}=this,n=r.get(e);if(Me(n)){if(!Me(t))return n.length=0,void r.delete(e);for(let e=0,r=n.length;e<r;e++)if(n[e].callback===t)return void n.splice(e,1)}}once(e,t,r={}){const n=r=>{const i=t.call(r);return this.off(e,n),i};this.on(e,n,r)}emit(e){const{_subscribers:t}=this;let r=t.get(e.type);if(Me(r)){r=r.slice(0);for(let t=0,n=r.length;t<n;t++){const{callback:n,target:i}=r[t];if(n.call(i,e))break}}}dispose(){const{_subscribers:e}=this;for(const t of e.values())t.length=0;e.clear()}}fe.SILENT;class Te extends Ee{constructor(e){super(),this.engine=e}}class Re{constructor(e){this.promise=new Promise(((t,r)=>{e(t,r)}))}}class Ae{get refCount(){return this._refCount}get destroyed(){return this._destroyed}constructor(e){this.engine=e,this.instanceId=Ae._instanceIdCounter++,this._refCount=0,this._destroyed=!1,e.resourceManager._addReferResource(this)}reference(){return this._refCount++,this}dispose(e=!1){this._destroyed||(this._refCount--,(e||this._refCount<=0)&&(this._dispose(),this._destroyed=!0,this.engine.resourceManager._removeReferResource(this)))}}Ae._instanceIdCounter=0;class Ce extends Ae{get texture(){return this._texture}constructor(e,t){super(e);const{userData:r}=t;if(Me(r.instanceId))throw new Error(`This texture already belongs to a refere resource with id ${r.instancedId}`);r.instanceId=this.instanceId,this._texture=t}reference(){return super.reference()}_dispose(){const{image:e}=this._texture;e instanceof ImageBitmap&&e.close(),this._texture.dispose(),this._texture=null}}class je extends Ae{get glTF(){return this._glTF}get nodes(){return this._nodes}get materials(){return this._materials}constructor(e,t){super(e),this._nodes={},this._materials={};const{userData:r}=t;if(Me(r.instanceId))throw new Error(`The glTF already belongs to a refer resource with id ${r.instanceID} `);r.instanceId=this.instanceId,this._glTF=t;const{scene:n}=t,{_nodes:i,_materials:s}=this;n.traverse((e=>{const{name:t,material:r}=e;if(Me(t)&&(i[t]=e),Me(r))if(Array.isArray(r))for(let e=0,t=r.length;e<t;e++){const{name:t}=r[e];Me(s[t])||(s[t]=r[e])}else{const{name:e}=r;Me(s[e])||(s[e]=r)}}))}reference(){return super.reference()}_dispose(){const{engine:e,_glTF:t,_materials:r}=this,{scene:n}=t;n.traverse((t=>{const{type:n}=t;if("Mesh"===n||"SkinnedMesh"===n){const{material:i,geometry:s}=t;if(Me(s.boundsTree)&&(s.boundsTree=null),s.dispose(),Array.isArray(i))for(let t=0,n=i.length;t<n;t++)delete r[i[t].name],e.resourceManager.disposeMaterial(i[t]);else delete r[i.name],e.resourceManager.disposeMaterial(i);if("SkinnedMesh"===n){const{skeleton:e}=t;Me(e)&&e.dispose()}}})),n.clear(),Object.values(r).forEach((t=>{e.resourceManager.disposeMaterial(t)})),this._glTF=null,this._nodes=null,this._materials=null}}class Ie extends Te{constructor(e){super(e),this.audioLoader=new d,this.fileLoader=new l,this.glTFLoader=new ae,this.textureLoader=function(){if("undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)){const e=new m;return e.setOptions({imageOrientation:"flipY",premultiplyAlpha:"none"}),e}return new f}(),this.exrLoader=new oe,this.rgbeLoader=new he,this.cubeTextureLoader=new h,this.hdrCubeTextureLoader=new ce,this._resources=new Map,this._resourcePool=new Map,this._resourceUrlPool=new Map,this._resourcesPromises=new Map}setDRACOLoader(e,t=1){const{glTFLoader:r}=this,n=new se;n.setDecoderPath(e.endsWith("/")?e:`${e}/`),n.setWorkerLimit(t),r.setDRACOLoader(n)}setKTX2Loader(e,t=1){const{engine:r,glTFLoader:n}=this,{gl:i}=r,s=new de;s.detectSupport(i),s.setTranscoderPath(e.endsWith("/")?e:`${e}/`),s.setWorkerLimit(t),n.setKTX2Loader(s)}setMeshoptDecoder(){this.glTFLoader.setMeshoptDecoder(le)}loadAudio(e,t){return this.audioLoader.loadAsync(e,t)}loadFile(e,t){return this.fileLoader.loadAsync(e,t)}loadGLTF(e,t){const{engine:r,glTFLoader:n,_resourcePool:i,_resourceUrlPool:s,_resourcesPromises:o}=this,a=s.get(e);if(Me(a))return new Re((e=>{e(a)})).promise;const c=o.get(e);if(Me(c))return new Re(((e,t)=>{c.promise.then((t=>{e(t)}),(e=>{t(e)}))})).promise;const d=new Re(((a,c)=>{n.loadAsync(e,t).then((t=>{o.delete(e);const n=new je(r,t);i.set(n.instanceId,e),s.set(e,n),a(n)}),(t=>{o.delete(e),c(t)}))}));return o.set(e,d),d.promise}loadTexture(e,t){const{engine:r,textureLoader:n,_resourcePool:i,_resourceUrlPool:s,_resourcesPromises:o}=this,a=s.get(e);if(Me(a))return new Re((e=>{e(a)})).promise;const c=o.get(e);if(Me(c))return new Re(((e,t)=>{c.promise.then((t=>{e(t)}),(e=>{t(e)}))})).promise;const d=new Re(((a,c)=>{n.loadAsync(e,t).then((t=>{o.delete(e),t instanceof ImageBitmap&&((t=new p(t)).needsUpdate=!0,u.enabled&&u.remove(e));const n=new Ce(r,t);i.set(n.instanceId,e),s.set(e,n),a(n)}),(t=>{o.delete(e),c(t)}))}));return o.set(e,d),d.promise}loadEXRTexture(e,t){const{engine:r,exrLoader:n,_resourcePool:i,_resourceUrlPool:s,_resourcesPromises:o}=this,a=s.get(e);if(Me(a))return new Re((e=>{e(a)})).promise;const c=o.get(e);if(Me(c))return new Re(((e,t)=>{c.promise.then((t=>{e(t)}),(e=>{t(e)}))})).promise;const d=new Re(((a,c)=>{n.loadAsync(e,t).then((t=>{o.delete(e);const n=new Ce(r,t);i.set(n.instanceId,e),s.set(e,n),a(n)}),(t=>{o.delete(e),c(t)}))}));return o.set(e,d),d.promise}loadHDRTexture(e,t){const{engine:r,rgbeLoader:n,_resourcePool:i,_resourceUrlPool:s,_resourcesPromises:o}=this,a=s.get(e);if(Me(a))return new Re((e=>{e(a)})).promise;const c=o.get(e);if(Me(c))return new Re(((e,t)=>{c.promise.then((t=>{e(t)}),(e=>{t(e)}))})).promise;const d=new Re(((a,c)=>{n.loadAsync(e,t).then((t=>{o.delete(e);const n=new Ce(r,t);i.set(n.instanceId,e),s.set(e,n),a(n)}),(t=>{o.delete(e),c(t)}))}));return o.set(e,d),d.promise}loadCubeTexture(e,t){const{engine:r,cubeTextureLoader:n,_resourcePool:i,_resourceUrlPool:s,_resourcesPromises:o}=this,a=s.get(e[0]);if(Me(a))return new Re((e=>{e(a)})).promise;const c=o.get(e[0]);if(Me(c))return new Re(((e,t)=>{c.promise.then((t=>{e(t)}),(e=>{t(e)}))})).promise;const d=new Re(((a,c)=>{n.loadAsync(e,t).then((t=>{o.delete(e[0]);const n=new Ce(r,t);i.set(n.instanceId,e[0]),s.set(e[0],n),a(n)}),(t=>{o.delete(e[0]),c(t)}))}));return o.set(e[0],d),d.promise}loadHDRCubeTexture(e,t){const{engine:r,hdrCubeTextureLoader:n,_resourcePool:i,_resourceUrlPool:s,_resourcesPromises:o}=this,a=s.get(e[0]);if(Me(a))return new Re((e=>{e(a)})).promise;const c=o.get(e[0]);if(Me(c))return new Re(((e,t)=>{c.promise.then((t=>{e(t)}),(e=>{t(e)}))})).promise;const d=new Re(((a,c)=>{n.loadAsync(e,t).then((t=>{o.delete(e[0]);const n=new Ce(r,t);i.set(n.instanceId,e[0]),s.set(e[0],n),a(n)}),(t=>{o.delete(e[0]),c(t)}))}));return o.set(e[0],d),d.promise}dispose(){super.dispose();const e=[...this._resources.values()];for(let t=0,r=e.length;t<r;t++)e[t].dispose();e.length=0}disposeTexture(e){const{_resources:t}=this,{userData:r}=e,{instancedId:n}=r;if(Me(n)){const e=t.get(n);Me(e)&&e.dispose()}else{const{image:t}=e;t instanceof ImageBitmap&&t.close(),e.dispose()}}disposeMaterial(e,t=!0){if(t)if(e instanceof g){const{uniforms:t}=e;for(const e in t){const{value:r}=t[e];r instanceof p&&this.disposeTexture(r)}}else for(const t in e){const r=e[t];r instanceof p&&this.disposeTexture(r)}e.dispose()}_addReferResource(e){if(this._resources.has(e.instanceId))throw new Error(`Refer resource with id ${e.instanceId} already exists.`);this._resources.set(e.instanceId,e)}_removeReferResource(e){const{_resources:t,_resourcePool:r,_resourceUrlPool:n}=this,{instanceId:i}=e,s=r.get(i);t.delete(i),r.delete(i),n.delete(s)}}class Oe{static enable(e,t,r){this._enabled||(_.shadowmap_pars_fragment=_.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP","#ifdef USE_SHADOWMAP\n"+this._pcss(r,t,e)).replace("#if defined( SHADOWMAP_TYPE_PCF )","\nreturn PCSS(shadowMap, shadowCoord);\n#if defined( SHADOWMAP_TYPE_PCF )"),this._enabled=!0)}static _pcss(e,t,r){return`\n        #define PENUMBRA_FILTER_SIZE float(${e})\n        #define RGB_NOISE_FUNCTION(uv) (randRGB(uv))\n        vec3 randRGB(vec2 uv) {\n            return vec3(\n                fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),\n                fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),\n                fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)\n            );\n        }\n        \n        vec3 lowPassRandRGB(vec2 uv) {\n            // 3x3 convolution (average)\n            // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9\n            vec3 result = vec3(0);\n            result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));\n            result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));\n            result *= 0.111111111; // 1.0 / 9.0\n            return result;\n        }\n        vec3 highPassRandRGB(vec2 uv) {\n            // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal\n            // hp(x) = x - lp(x)\n            return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;\n        }\n        \n        \n        vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {\n            const float goldenAngle = 2.399963f; // radians\n            float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));\n            float theta = float(sampleIndex) * goldenAngle + angle;\n            float sine = sin(theta);\n            float cosine = cos(theta);\n            return vec2(cosine, sine) * r;\n        }\n        float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation\n            return (zReceiver - zBlocker) / zBlocker;\n        }\n        float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {\n            float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);\n            float blockerDepthSum = float(${r});\n            float blockers = 0.0;\n            \n            int j = 0;\n            vec2 offset = vec2(0.);\n            float depth = 0.;\n        \n            #pragma unroll_loop_start\n            for(int i = 0; i < ${t}; i ++) {\n                offset = (vogelDiskSample(j, ${t}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;\n                depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));\n                if (depth < compare) {\n                blockerDepthSum += depth;\n                blockers++;\n                }\n                j++;\n            }\n            #pragma unroll_loop_end\n        \n            if (blockers > 0.0) {\n                return blockerDepthSum / blockers;\n            }\n            return -1.0;\n        }\n        \n                \n        float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {\n            float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);\n            float shadow = 0.0f;\n            int j = 0;\n            vec2 vogelSample = vec2(0.0);\n            vec2 offset = vec2(0.0);\n            #pragma unroll_loop_start\n            for (int i = 0; i < ${t}; i++) {\n                vogelSample = vogelDiskSample(j, ${t}, angle) * texelSize;\n                offset = vogelSample * (1.0 + filterRadius * float(${e}));\n                shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );\n                j++;\n            }\n            #pragma unroll_loop_end\n            return shadow * 1.0 / ${t}.0;\n        }\n        \n        float PCSS (sampler2D shadowMap, vec4 coords) {\n            vec2 uv = coords.xy;\n            float zReceiver = coords.z; // Assumed to be eye-space z in this code\n            float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;\n            float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);\n            if (avgBlockerDepth == -1.0) {\n                return 1.0;\n            }\n            float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);\n            return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);\n        }`}}Oe._enabled=!1;class Ue{static initialize(){this._initialized&&(this.inject("perlin_classic_noise_2d","#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}float perlin_classic_noise_2d(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}"),this.inject("perlin_classic_noise_3d","#define GLSLIFY 1\nvec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}float perlin_classic_noise_3d(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}"),this.inject("perlin_classic_noise_4d","#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}float perlin_classic_noise_4d(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}"),this.inject("perlin_periodic_noise_2d","#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}float perlin_periodic_noise_2d(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}"),this.inject("perlin_periodic_noise_3d","#define GLSLIFY 1\nvec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}float perlin_periodic_noise_3d(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}"),this.inject("perlin_periodic_noise_4d","#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}float perlin_periodic_noise_4d(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}"),this.inject("simplex_noise_2d","#define GLSLIFY 1\nvec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 permute(vec3 x){return mod289(((x*34.0)+1.0)*x);}float simplex_noise_2d(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}"),this.inject("simplex_noise_3d","#define GLSLIFY 1\nvec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float simplex_noise_3d(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}"),this.inject("simplex_noise_4d","#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}\n#define F4 0.309016994374947451\nfloat simplex_noise_4d(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}"),this.inject("voronoi_noise_2d","#define GLSLIFY 1\nconst mat2 myt=mat2(.12121212,.13131313,-.13131313,.12121212);const vec2 mys=vec2(1e4,1e6);vec2 rhash(vec2 uv){uv*=myt;uv*=mys;return fract(fract(uv/mys)*uv);}vec3 hash(vec3 p){return fract(sin(vec3(dot(p,vec3(1.0,57.0,113.0)),dot(p,vec3(57.0,113.0,1.0)),dot(p,vec3(113.0,1.0,57.0))))*43758.5453);}float voronoi_noise_2d(const in vec2 point){vec2 p=floor(point);vec2 f=fract(point);float res=0.0;for(int j=-1;j<=1;j++){for(int i=-1;i<=1;i++){vec2 b=vec2(i,j);vec2 r=vec2(b)-f+rhash(p+b);res+=1./pow(dot(r,r),8.);}}return pow(1./res,0.0625);}"),this.inject("voronoi_noise_3d","#define GLSLIFY 1\nconst mat2 myt=mat2(.12121212,.13131313,-.13131313,.12121212);const vec2 mys=vec2(1e4,1e6);vec2 rhash(vec2 uv){uv*=myt;uv*=mys;return fract(fract(uv/mys)*uv);}vec3 hash(vec3 p){return fract(sin(vec3(dot(p,vec3(1.0,57.0,113.0)),dot(p,vec3(57.0,113.0,1.0)),dot(p,vec3(113.0,1.0,57.0))))*43758.5453);}vec3 voronoi_noise_3d(const in vec3 x){vec3 p=floor(x);vec3 f=fract(x);float id=0.0;vec2 res=vec2(100.0);for(int k=-1;k<=1;k++){for(int j=-1;j<=1;j++){for(int i=-1;i<=1;i++){vec3 b=vec3(float(i),float(j),float(k));vec3 r=vec3(b)-f+hash(p+b);float d=dot(r,r);float cond=max(sign(res.x-d),0.0);float nCond=1.0-cond;float cond2=nCond*max(sign(res.y-d),0.0);float nCond2=1.0-cond2;id=(dot(p+b,vec3(1.0,57.0,113.0))*cond)+(id*nCond);res=vec2(d,res.x)*cond+res*nCond;res.y=cond2*d+nCond2*res.y;}}}return vec3(sqrt(res),abs(id));}"),this.inject("worley_noise_2d","#define GLSLIFY 1\nvec3 permute(vec3 x){return mod((34.0*x+1.0)*x,289.0);}vec3 dist(vec3 x,vec3 y,bool manhattanDistance){return manhattanDistance ? abs(x)+abs(y):(x*x+y*y);}vec2 worley_noise_2d(vec2 P,float jitter,bool manhattanDistance){float K=0.142857142857;float Ko=0.428571428571;vec2 Pi=mod(floor(P),289.0);vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod(floor(p*K),7.0)*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dist(dx,dy,manhattanDistance);p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod(floor(p*K),7.0)*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dist(dx,dy,manhattanDistance);p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod(floor(p*K),7.0)*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dist(dx,dy,manhattanDistance);vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}"),this.inject("worley_noise_3d","#define GLSLIFY 1\nvec3 permute(vec3 x){return mod((34.0*x+1.0)*x,289.0);}vec3 dist(vec3 x,vec3 y,vec3 z,bool manhattanDistance){return manhattanDistance ? abs(x)+abs(y)+abs(z):(x*x+y*y+z*z);}vec2 worley_noise_3d(vec3 P,float jitter,bool manhattanDistance){float K=0.142857142857;float Ko=0.428571428571;float K2=0.020408163265306;float Kz=0.166666666667;float Kzo=0.416666666667;vec3 Pi=mod(floor(P),289.0);vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod(floor(p11*K),7.0)*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod(floor(p12*K),7.0)*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod(floor(p13*K),7.0)*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod(floor(p21*K),7.0)*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod(floor(p22*K),7.0)*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod(floor(p23*K),7.0)*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod(floor(p31*K),7.0)*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod(floor(p32*K),7.0)*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod(floor(p33*K),7.0)*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dist(dx11,dy11,dz11,manhattanDistance);vec3 d12=dist(dx12,dy12,dz12,manhattanDistance);vec3 d13=dist(dx13,dy13,dz13,manhattanDistance);vec3 d21=dist(dx21,dy21,dz21,manhattanDistance);vec3 d22=dist(dx22,dy22,dz22,manhattanDistance);vec3 d23=dist(dx23,dy23,dz23,manhattanDistance);vec3 d31=dist(dx31,dy31,dz31,manhattanDistance);vec3 d32=dist(dx32,dy32,dz32,manhattanDistance);vec3 d33=dist(dx33,dy33,dz33,manhattanDistance);vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}"),this._initialized=!0)}static inject(e,t){_[e]=t}}Ue._initialized=!1;class ke{constructor(){this.time=new v(new x),this.viewport=new v(new x),this.resolution=new v(new y),this.cameraType=new v(0),this.cameraNearFar=new v(new y),this.cameraWorldMatrix=new v(new w),this.cameraWorldMatrixInverse=new v(new w),this.cameraProjectionMatrix=new v(new w),this.cameraProjectionMatrixInverse=new v(new w),this.cameraDepthTexture=new v(null)}static initRectAreaLightUniforms(){ke._isRectAreaLightUniformsInit&&(pe.init(),ke._isRectAreaLightUniformsInit=!0)}update(e,t){this.time.value.set(t,Math.sin(t),Math.cos(t),e)}}ke._isRectAreaLightUniformsInit=!1;class Le extends Ee{get gl(){return this._gl}get viewport(){return this._viewport}constructor(e={}){super(),this.resourceManager=new Ie(this),this.uniformsLib=new ke,this._clock=new z,this._limitClock=new z,this._limitDelta=0,this._limitInterval=0,this._scenes=[],this._sceneRenderers=[],this._deviceEventHandler=this._deviceEventSubscriber.bind(this),this._resizeEventHandler=this._resizeEventSubscriber.bind(this);const{fps:t=60,logLevel:r=fe.SILENT,gl:n={}}=e;this._limitInterval=1/t,u.enabled=!0,Ue.initialize(),this._initializeGL(n),this._subscribeEvent()}dispose(){const{_gl:e,resourceManager:t,_scenes:r,_sceneRenderers:n}=this;super.dispose(),this._unsubscribeEvent();for(let e=r.length-1;e>=0;e--)r[e].dispose();for(let e=n.length-1;e>=0;e--)n[e].dispose();t.dispose(),e.domElement.remove(),e.setAnimationLoop(null),e.dispose(),e.forceContextLoss()}_addScene(e){const{_scenes:t}=this;if(t.includes(e))throw new Error("Can't add the same scene twice!");t.push(e)}_removeScene(e){const{_scenes:t}=this,r=t.indexOf(e);~r&&t.splice(r,1)}_addSceneRenderer(e){const{_sceneRenderers:t}=this;if(t.includes(e))throw new Error("Can't add the same scene renderer twice!");t.push(e)}_removeSceneRenderer(e){const{_sceneRenderers:t}=this,r=t.indexOf(e);~r&&t.splice(r,1)}_initializeGL(e){e.antialias=Se(e.antialias,!0),e.powerPreference=Se(e.powerPreference,"high-performance");const{clearColor:t="#f0fff0",clearAlpha:r=1,outputColorSpace:n=b,toneMapping:i=D,toneMappingExposure:s=1,shadowMap:o={},localClippingEnabled:a=!1,pixelRatio:c=window.devicePixelRatio,viewport:d=document.body}=e,{enabled:l=!1,autoUpdate:h=!0,needsUpdate:p=!1,softShadow:u,type:g=E}=o;P.enabled=n===b,this._viewport=d;const m=this._gl=new M(e);if(m.outputColorSpace=n,m.toneMapping=i,m.toneMappingExposure=s,m.localClippingEnabled=a,m.shadowMap.enabled=l,m.shadowMap.autoUpdate=h,m.shadowMap.needsUpdate=p,m.shadowMap.type=g,Me(u)){const{size:e=25,samples:t=10,focus:r=0}=u;Oe.enable(e,t,r)}m.debug.checkShaderErrors=!1,m.setClearColor(new S(t),r),m.setPixelRatio(c),m.setSize(d.clientWidth,d.clientHeight),m.setAnimationLoop(this._animationLoop.bind(this)),-1===m.domElement.tabIndex&&(m.domElement.tabIndex=-1),d.style.touchAction="none",d.appendChild(m.domElement)}_subscribeEvent(){const{_viewport:e,_deviceEventHandler:t,_resizeEventHandler:r}=this;e.addEventListener("contextmenu",t,!1),e.addEventListener("pointerdown",t,!1),e.addEventListener("pointerup",t,!1),e.addEventListener("pointermove",t,!1),e.addEventListener("pointercancel",t,!1),e.addEventListener("click",t,!1),e.addEventListener("dblclick",t,!1),e.addEventListener("wheel",t,!1),window.addEventListener("keydown",t,!1),window.addEventListener("keyup",t,!1),window.addEventListener("resize",r,!1)}_unsubscribeEvent(){const{_viewport:e,_deviceEventHandler:t,_resizeEventHandler:r}=this;e.removeEventListener("contextmenu",t,!1),e.removeEventListener("pointerdown",t,!1),e.removeEventListener("pointerup",t,!1),e.removeEventListener("pointermove",t,!1),e.removeEventListener("pointercancel",t,!1),e.removeEventListener("click",t,!1),e.removeEventListener("dblclick",t,!1),e.removeEventListener("wheel",t,!1),window.removeEventListener("keydown",t,!1),window.removeEventListener("keyup",t,!1),window.removeEventListener("resize",r,!1)}_deviceEventSubscriber(e){const{_scenes:t}=this;for(let r=0,n=t.length;r<n;r++){const n=t[r];n.isActive&&n.emit(e)}}_resizeEventSubscriber(e){const{gl:t,_scenes:r,_sceneRenderers:n,_viewport:i}=this,s=e.width=i.clientWidth,o=e.height=i.clientHeight;t.setSize(s,o);for(let e=0,t=n.length;e<t;e++)n[e].setSize(s,o);for(let t=0,n=r.length;t<n;t++){const n=r[t],{activeCameras:i}=n;for(let e=0,t=i.length;e<t;e++)i[e].resize(s,o);n.isActive&&n.emit(e)}}_animationLoop(e,t){const{_scenes:r,_clock:n,_limitClock:i,_limitInterval:s,uniformsLib:o,customRenderScenes:a}=this;if(this._limitDelta+=i.getDelta(),this._limitDelta>s){const i=n.elapsedTime,c=n.getDelta();this.emit({type:me.BEFORE_FRAME_LOOP,timeSinceLastFrame:c,totalTime:i}),o.update(c,i);const d=r.length;for(let e=0;e<d;e++){const t=r[e];t.isActive&&(t._camerasNeedSorting&&t._sortCameras(),t._componentsManager.callScriptOnStart())}for(let e=0;e<d;e++){const t=r[e];t.isActive&&t._componentsManager.callScriptOnUpdate(c,i)}for(let e=0;e<d;e++){const t=r[e];t.isActive&&t._componentsManager.callAnimationUpdate(c)}for(let e=0;e<d;e++){const t=r[e];t.isActive&&t._componentsManager.callScriptOnLateUpdate(c,i)}for(let e=0;e<d;e++){const t=r[e];t.isActive&&t._componentsManager.callRendererUpdate(c,i)}this.emit({type:me.BEFORE_SCENES_RENDER,timeSinceLastFrame:c,totalTime:i});const l={timeSinceLastFrame:c,totalTime:i,timeStamp:e,frame:t};Me(a)?a(r,l):this._renderScenes(r,l),this.emit({type:me.AFTER_SCENES_RENDER,timeSinceLastFrame:c,totalTime:i}),this.emit({type:me.AFTER_FRAME_LOOP,timeSinceLastFrame:c,totalTime:i}),this._limitDelta=s>0?this._limitDelta%s:0}}_renderScenes(e,t={}){for(let r=0,n=e.length;r<n;r++){const n=e[r];n.isActive&&n.render(t)}}}class Be{get length(){return this._length}constructor(e=0){this._length=0,this._isLooping=!1,this._blankCount=0,this._elements=new Array(e)}add(e){this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++}set(e,t){if(e>=this._length)throw new Error("Index is out of range");this._elements[e]=t}get(e){if(e>=this._length)throw new Error("Index is out of range");return this._elements[e]}delete(e){const t=this._elements.indexOf(e);this.deleteByIndex(t)}deleteByIndex(e){let t;if(this._isLooping)this._elements[e]=null,this._blankCount++;else{const r=this._length-1;e!==r&&(t=this._elements[r],this._elements[e]=t),this._elements[r]=null,this._length--}return t}foreach(e,t){this._startLoop();for(let t=0,r=this._elements.length;t<r;t++){const r=this._elements[t];r&&e(r)}this._endLoop(t)}foreachAndClear(e){this._startLoop();for(let t=0,r=this._elements.length;t<r;t++){const r=this._elements[t];r&&e(r)}this._endLoopAndClear()}garbageCollection(){this._elements.length=this._length}clear(){this._elements.length=0,this._length=0,this._blankCount=0,this._isLooping=!1}_startLoop(){this._isLooping=!0}_endLoop(e){if(this._isLooping=!1,this._blankCount>0){let t=0,r=this._length-1;e:do{for(;this._elements[t];)if(++t>=r)break e;for(;!this._elements[r];)if(t>=--r)break e;const n=this._elements[r];e(n,t),this._elements[t++]=n,this._elements[r--]=null}while(t<r);this._length-=this._blankCount,this._blankCount=0}}_endLoopAndClear(){this._isLooping=!1,this._length=0,this._blankCount=0}}class Fe{constructor(e){this.scene=e,this._onStartScripts=new Be,this._onUpdateScripts=new Be,this._onLateUpdateScripts=new Be,this._onPhysicsUpdateScripts=new Be,this._onUpdateAnimators=new Be,this._onUpdateRenderers=new Be}addOnStartScript(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)}removeOnStartScript(e){const t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1}addOnUpdateScript(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)}removeOnUpdateScript(e){const t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1}addOnLateUpdateScript(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)}removeOnLateUpdateScript(e){const t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1}addOnPhysicsUpdateScript(e){e._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(e)}removeOnPhysicsUpdateScript(e){const t=this._onPhysicsUpdateScripts.deleteByIndex(e._onPhysicsUpdateIndex);t&&(t._onPhysicsUpdateIndex=e._onPhysicsUpdateIndex),e._onPhysicsUpdateIndex=-1}addOnUpdateAnimator(e){e._onUpdateIndex=this._onUpdateAnimators.length,this._onUpdateAnimators.add(e)}removeOnUpdateAnimator(e){const t=this._onUpdateAnimators.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1}addOnUpdateRenderer(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)}removeOnUpdateRenderer(e){const t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1}callScriptOnStart(){const{_onStartScripts:e}=this;e.length>0&&e.foreachAndClear((e=>{e._started=!0,this.removeOnStartScript(e),e.onStart()}))}callScriptOnUpdate(e,t){const{_onUpdateScripts:r}=this;r.foreach((r=>{r._started&&r.onUpdate(e,t)}),((e,t)=>{e._onUpdateIndex=t}))}callScriptOnLateUpdate(e,t){const{_onLateUpdateScripts:r}=this;r.foreach((r=>{r._started&&r.onLateUpdate(e,t)}),((e,t)=>{e._onLateUpdateIndex=t}))}callScriptOnPhysicsUpdate(){const{_onPhysicsUpdateScripts:e}=this;e.foreach((e=>{e._started&&e.onPhysicsUpdate()}),((e,t)=>{e._onPhysicsUpdateIndex=t}))}callAnimationUpdate(e){const{_onUpdateAnimators:t}=this;t.foreach((t=>{t.update(e)}),((e,t)=>{e._onUpdateIndex=t}))}callRendererUpdate(e,t){const{_onUpdateRenderers:r}=this;r.foreach((r=>{r.update(e,t)}),((e,t)=>{e._onUpdateIndex=t}))}dispose(){this._onStartScripts.clear(),this._onUpdateScripts.clear(),this._onLateUpdateScripts.clear(),this._onPhysicsUpdateScripts.clear(),this._onUpdateAnimators.clear(),this._onUpdateRenderers.clear()}}class Ne extends Ee{get scene(){return this.entity.scene}set enabled(e){e!==this._enabled&&(this._enabled=e,this._enabled?this._onEnable():this._onDisable())}get enabled(){return this._enabled}constructor(e,t={}){super(),this.entity=e,this._awoken=!1,this._enabled=!1,this.userData=Se(t.userData,{})}setActive(e){e?(this._awoken||(this._awoken=!0,this._onAwake()),this._enabled||(this._enabled=!0,this._onEnable())):(this._enabled=!1,this._onDisable())}setActiveInScene(e){e?this._onEnableInScene():this._onDisableInScene()}desrtoy(){this._awoken&&(this._awoken=!1,this._enabled&&(this._enabled=!1,this._onDisable())),this._onDestroy(),this.dispose()}_onAwake(){}_onEnable(){}_onDisable(){}_onEnableInScene(){}_onDisableInScene(){}_onDestroy(){}}!function(e){e[e.AND=0]="AND",e[e.OR=1]="OR"}(we||(we={}));class We{static addCheck(e,t){const{_dependenciesMap:r}=We;for(;t!==Ne;){const n=r.get(t);if(n){const{mode:r,components:i}=n;switch(r){case we.AND:for(let r=0,n=i.length;r<n;r++)if(!e.hasComponent(i[r]))throw new Error(`Should add ${i[r].name} before adding ${t.name}`);break;case we.OR:const r=[];let n=!0;for(let t=0,s=i.length;t<s;t++)e.hasComponent(i[t])&&(n=!1),r.push(i[t].name);if(n)throw new Error(`Should add one of {${r}} before adding ${t.name}`)}}t=Object.getPrototypeOf(t)}}static removeCheck(e,t){const{_inverseDependenciesMap:r}=We;for(;t!==Ne;){const n=r.get(t);if(n)for(let r=0,i=n.length;r<i;r++)if(e.hasComponent(n[r]))throw new Error(`Should remove ${n[r].name} before removing ${t.name}`);t=Object.getPrototypeOf(t)}}static addDependency(e,t){const{_dependenciesMap:r}=We;r.set(e,t)}static addInverseDependency(e,t){const{_inverseDependenciesMap:r}=We,n=r.get(e);n?n.includes(t)||n.push(t):r.set(e,[t])}}function qe(e,t=we.AND){const r=Array.isArray(e)?e:[e];return function(e){We.addDependency(e,{mode:t,components:r}),r.forEach((t=>We.addInverseDependency(t,e)))}}We._dependenciesMap=new Map,We._inverseDependenciesMap=new Map;class Ke{constructor(){this._items={},this._head=0,this._tail=0}get size(){return this._tail-this._head}get empty(){return 0===this.size}enqueue(e){this._items[this._tail++]=e}dequeue(){if(this.empty)return null;const e=this._items[this._head];return delete this._items[this._head++],e}peek(){return this.empty?null:this._items[this._head]}clear(){this._items={},this._head=0,this._tail=0}}class Ge{constructor(){this._updateFlags=[],this._listeners=[]}createFlag(e){const t=new e;return this.addFlag(t),t}addFlag(e){this._updateFlags.push(e),e._flagManagers.push(this)}removeFlag(e){De(this._updateFlags,e)&&De(e._flagManagers,this)}addListener(e){this._listeners.push(e)}removeListener(e){De(this._listeners,e)}dispatch(e,t){const{_updateFlags:r,_listeners:n}=this;for(let n=r.length-1;n>=0;n--)r[n].dispatch(e,t);for(let r=n.length-1;r>=0;r--)n[r](e,t)}}class He extends Ne{set parent(e){e.addChild(this)}get parent(){return this._parent}get children(){return this._children}get isRoot(){return this.object3D.isScene}get isCamera(){return this.object3D.isCamera}get updateFlagManager(){return this._updateFlagManager}set matrix(e){this.object3D.matrix.copy(e),this.object3D.matrix.decompose(this.object3D.position,this.object3D.quaternion,this.object3D.scale);const{matrixAutoUpdate:t}=this.object3D;this.object3D.matrixAutoUpdate=!1,this.object3D.updateMatrixWorld(!0),this.object3D.matrixAutoUpdate=t,He._traverseDispatchUpdateFlag(this)}set position(e){this.setTransformation({position:e})}get position(){return this.object3D.position}set scale(e){this.setTransformation({scale:e})}get scale(){return this.object3D.scale}set rotation(e){this.setTransformation({rotation:e})}get rotation(){return this.object3D.rotation}set quaternion(e){this.setTransformation({quaternion:e})}get quaternion(){return this.object3D.quaternion}constructor(e,t){super(e,t),this._children=[],this._updateFlagManager=new Ge;const{object3D:r=new T,position:n,scale:i,lookAt:s,rotation:o,quaternion:a}=t;this.object3D=r,Me(n)&&this.object3D.position.copy(n),Me(i)&&this.object3D.scale.copy(i),Me(s)&&this.object3D.lookAt(s),Me(o)&&this.object3D.rotation.copy(o),Me(a)&&this.object3D.quaternion.copy(a)}getWorldPosition(e){return this.object3D.getWorldPosition(e)}getWorldScale(e){return this.object3D.getWorldScale(e)}getWorldQuaternion(e){return this.object3D.getWorldQuaternion(e)}getWorldDirection(e){return this.object3D.getWorldDirection(e)}setTransformation(e){let t=!1;const{position:r,scale:n,rotation:i,quaternion:s}=e;Me(r)&&(this.object3D.position.copy(r),t=!0),Me(n)&&(this.object3D.scale.copy(n),t=!0),Me(i)&&(this.object3D.rotation.copy(i),t=!0),Me(s)&&(this.object3D.quaternion.copy(s),t=!0),t&&this.updateWorldMatrix()}lookAt(e){this.object3D.lookAt(e),this.updateWorldMatrix()}translateX(e){this.object3D.translateX(e),this.updateWorldMatrix()}translateY(e){this.object3D.translateY(e),this.updateWorldMatrix()}translateZ(e){this.object3D.translateZ(e),this.updateWorldMatrix()}translateOnAxis(e,t){this.object3D.translateOnAxis(e,t),this.updateWorldMatrix()}rotateX(e){this.object3D.rotateX(e),this.updateWorldMatrix()}rotateY(e){this.object3D.rotateY(e),this.updateWorldMatrix()}rotateZ(e){this.object3D.rotateZ(e),this.updateWorldMatrix()}rotateOnAxis(e,t){this.object3D.rotateOnAxis(e,t),this.updateWorldMatrix()}rotateOnWorldAxis(e,t){this.object3D.rotateOnWorldAxis(e,t),this.updateWorldMatrix()}localToWorld(e){return this.object3D.localToWorld(e)}worldToLocal(e){return this.object3D.worldToLocal(e)}addChild(e){const{_children:t}=this;if(!~t.indexOf(e)){if(e.isCamera)throw new Error("The camera can't add as child.");if(e.isRoot)throw new Error("The root can't add as child.");const{_parent:r}=e;Me(r)&&r.removeChild(e),t.push(e),e._parent=this,Me(e.object3D.parent)&&e.object3D.parent==this.object3D||this.object3D.add(e.object3D),e.updateWorldMatrix(),Ve._traverseSetOwnerScene(e.entity,this.entity.scene)}return this}removeChild(e){const{_children:t,object3D:r}=this,n=t.indexOf(e);return~n&&(t.splice(n,1),e._parent=null,r.remove(e.object3D),Ve._traverseSetOwnerScene(e.entity,null)),this}removeAllChildren(){const{_children:e,object3D:t}=this;for(let r=0,n=e.length;r<n;r++){const n=e[r];n._parent=null,t.remove(n.object3D),Ve._traverseSetOwnerScene(n.entity,null)}return e.length=0,this}removeFromParent(){const{_parent:e}=this;return Me(e)&&e.removeChild(this),this}updateWorldMatrix(){const{object3D:e}=this,{matrixAutoUpdate:t}=e;e.matrixAutoUpdate=!0,e.updateMatrixWorld(!0),e.matrixAutoUpdate=t,He._traverseDispatchUpdateFlag(this)}static _traverseDispatchUpdateFlag(e){e._updateFlagManager.dispatch();const{_children:t}=e;for(let e=0,r=t.length;e<r;e++)He._traverseDispatchUpdateFlag(t[e])}}class Ve extends Te{set visible(e){this.transform.object3D.visible=e}get scene(){return this._scene}get isRoot(){return"Scene"===this.transform.object3D.type}get children(){const{children:e}=this.transform,t=[];for(let r=0,n=e.length;r<n;r++)t.push(e[r].entity);return t}constructor(e,t={}){super(e),this._scene=null,this._components=new Map,this._scripts=new Be;const{guid:r=R.generateUUID(),name:n="",userData:i={},transform:s={}}=t;this.guid=r,this.name=n,this.userData=i,this.transform=this.addComponent(He,s)}static findByGUID(e,t){const{_tempQueue:r}=Ve;for(r.clear(),r.enqueue(e);!r.empty;){const e=r.dequeue();if(e.guid===t)return r.clear(),e;const{children:n}=e.transform;for(let e=0,t=n.length;e<t;e++)r.enqueue(n[e].entity)}return null}static findByName(e,t){const r=[],{_tempQueue:n}=Ve;for(n.clear(),n.enqueue(e);!n.empty;){const e=n.dequeue();e.name===t&&r.push(e);const{children:i}=e.transform;for(let e=0,t=i.length;e<t;e++)n.enqueue(i[e].entity)}return r}static findByCondition(e,t){const r=[],{_tempQueue:n}=Ve;for(n.clear(),n.enqueue(e);!n.empty;){const e=n.dequeue();t(e)&&r.push(e);const{children:i}=e.transform;for(let e=0,t=i.length;e<t;e++)n.enqueue(i[e].entity)}return r}static findByComponent(e,t){const r=[],{_tempQueue:n}=Ve;for(n.clear(),n.enqueue(e);!n.empty;){const e=n.dequeue();e.hasComponent(t)&&r.push(e);const{children:i}=e.transform;for(let e=0,t=i.length;e<t;e++)n.enqueue(i[e].entity)}return r}static traverse(e,t){const{_tempQueue:r}=Ve;for(r.clear(),r.enqueue(e);!r.empty;){const e=r.dequeue();t(e);const{children:n}=e.transform;for(let e=0,t=n.length;e<t;e++)r.enqueue(n[e].entity)}}addComponent(e,t){const{_components:r,_scene:n}=this;if(r.has(e))throw new Error(`Component of type ${e.name} already exists.`);We.addCheck(this,e);const i=new e(this,t);return i.setActive(!0),Me(n)&&i.setActiveInScene(!0),r.set(e,i),i}removeComponent(e){const{_components:t}=this,r=t.get(e);Me(r)&&(We.removeCheck(this,e),r.desrtoy(),t.delete(e))}removeAllComponents(){const{_components:e}=this,t=Array.from(e.values()).reverse();for(let e=0,r=t.length;e<r;e++)t[e].desrtoy();t.length=0,e.clear()}getComponent(e){return this._components.get(e)}getAllComponents(){return[...this._components.values()]}hasComponent(e){return this._components.has(e)}createChild(e={}){if(this.transform.isCamera)throw Error("The camera entity can't create child.");const t=new Ve(this.engine,e);return this.addChild(t),t}addChild(e){const{transform:t}=e;this.transform.addChild(t)}removeChild(e){const{transform:t}=e;this.transform.removeChild(t)}removeAllChildren(){this.transform.removeAllChildren()}removeFromParent(){this.transform.removeFromParent()}destroy(){Ve._destroy(this)}getWorldBounds(e,t=!1){return e.makeEmpty(),Ve._traverseGetWorldBounds(this,e,t),e}_addScript(e){const{_scripts:t}=this;e._entityScriptsIndex=t.length,t.add(e)}_removeScript(e){const{_scripts:t}=this;if(e._entityScriptsIndex>=0){const r=t.deleteByIndex(e._entityScriptsIndex);Me(r)&&(r._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1}}static _traverseSetOwnerScene(e,t){const{_tempQueue:r}=Ve;for(r.clear(),r.enqueue(e);!r.empty;){const e=r.dequeue();e._scene=t;const n=e.getAllComponents();for(let e=0,r=n.length;e<r;e++)n[e].setActiveInScene(Me(t));const{children:i}=e.transform;for(let e=0,t=i.length;e<t;e++)r.enqueue(i[e].entity)}}static _traverseGetWorldBounds(e,t,r){const n=e.getAllComponents();for(let e=0,r=n.length;e<r;e++){const r=n[e];r.isRenderer&&t.union(r.worldBounds)}if(r){const{children:n}=e.transform;for(let e=0,i=n.length;e<i;e++)Ve._traverseGetWorldBounds(n[e].entity,t,r)}}static _destroy(e){const{_tempQueue:t}=Ve;for(t.clear(),t.enqueue(e);!t.empty;){const e=t.dequeue(),{transform:r}=e,{children:n}=r;for(let e=0,r=n.length;e<r;e++)t.enqueue(n[e].entity);e.removeAllComponents()}}}function Ye(e,t,r,n){var i,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(s<3?i(o):s>3?i(t,r,o):i(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o}function Qe(){return function(e,t,r){const n={get:r.get,set:r.set};Me(n.set)&&(r.set=function(e){n.set.call(this,e),Me(this.emit)&&this.emit({type:me.ATTRIBUTE_CHANGED,name:t,value:e})})}}Ve._tempQueue=new Ke,"function"==typeof SuppressedError&&SuppressedError,function(e){e[e.Mask0=1]="Mask0",e[e.Mask1=2]="Mask1",e[e.Mask2=4]="Mask2",e[e.Mask3=8]="Mask3",e[e.Mask4=16]="Mask4",e[e.Mask5=32]="Mask5",e[e.Mask6=64]="Mask6",e[e.Mask7=128]="Mask7",e[e.Mask8=256]="Mask8",e[e.Mask9=512]="Mask9",e[e.Mask10=1024]="Mask10",e[e.Mask11=2048]="Mask11",e[e.Mask12=4096]="Mask12",e[e.Mask13=8192]="Mask13",e[e.Mask14=16384]="Mask14",e[e.Mask15=32768]="Mask15",e[e.Mask16=65536]="Mask16",e[e.Mask17=131072]="Mask17",e[e.Mask18=262144]="Mask18",e[e.Mask19=524288]="Mask19",e[e.Mask20=1048576]="Mask20",e[e.Mask21=2097152]="Mask21",e[e.Mask22=4194304]="Mask22",e[e.Mask23=8388608]="Mask23",e[e.Mask24=16777216]="Mask24",e[e.Mask25=33554432]="Mask25",e[e.Mask26=67108864]="Mask26",e[e.Mask27=134217728]="Mask27",e[e.Mask28=268435456]="Mask28",e[e.Mask29=536870912]="Mask29",e[e.Mask30=1073741824]="Mask30",e[e.Mask31=2147483648]="Mask31",e[e.Everything=4294967295]="Everything",e[e.Nothing=0]="Nothing"}(ze||(ze={}));class $e{}$e.tempVec2=new y,$e.tempvec3=new A,$e.tempVec4=new x,$e.tempRaycaster=new C;class Ze extends Ne{set priority(e){this._priority=e,this.scene._camerasNeedSorting=!0}get priority(){return this._priority}get renderTarget(){return this._renderTarget}set viewport(e){this._viewport.equals(e)||(this._viewport.copy(e),this._upatePixelViewport())}get viewport(){return this._viewport}get pixelViewport(){return this._pixelViewport}set enableDepth(r){if(r){if(!Me(this._depthTarget)){const{entity:r,_viewport:n}=this,{engine:i}=r,s=i.gl.getPixelRatio(),o=Math.floor(n.width*i.viewport.clientWidth*s),a=Math.floor(n.height*i.viewport.clientHeight*s);this._depthTarget=new e(o,a,{samples:4,depthBuffer:!0,depthTexture:new t(o,a)})}}else Me(this._depthTarget)&&(this._depthTarget.dispose(),this._depthTarget=null)}get enableDepth(){return Me(this._depthTarget)}get depthTexture(){return Me(this._depthTarget)?this._depthTarget.depthTexture:null}get updateFlagManager(){return this._updateFlagManager}get native(){return this.entity.transform.object3D}constructor(e,t={}){super(e,t),this.isCamera=!0,this._priority=0,this._viewport=new x,this._pixelViewport=new x,this._renderTarget=null,this._depthTarget=null,this._updateFlagManager=new Ge;const{priority:r=0,viewport:n=new x(0,0,1,1),renderTarget:i=null,enableDepth:s=!1}=t;this._priority=r,this._renderTarget=i,this._viewport.copy(n),this.enableDepth=s,this._upatePixelViewport(),this._notifyCameraChanged=this._notifyCameraChanged.bind(this),e.transform.updateFlagManager.addListener(this._notifyCameraChanged)}intersectRenderer(e,t){const{tempRaycaster:r}=$e;if(e instanceof y){const{entity:t,_pixelViewport:n}=this,i=(e.x-n.x)/n.z,s=(e.y-n.y)/n.w;if(i>1||i<0||s>1||s<0)return null;r.setFromCamera(new y(2*i-1,1-2*s),t.transform.object3D)}else r.ray.copy(e),r.camera=this.entity.transform.object3D;return t.raycast(r)}intersectEntity(e,t,r=ze.Everything){const{tempRaycaster:n}=$e;if(e instanceof y){const{entity:t,_pixelViewport:r}=this,i=(e.x-r.x)/r.z,s=(e.y-r.y)/r.w;if(i>1||i<0||s>1||s<0)return null;n.setFromCamera(new y(2*i-1,1-2*s),t.transform.object3D)}else n.ray.copy(e),n.camera=this.entity.transform.object3D;const i=[],s=t.getAllComponents();for(let e=0,t=s.length;e<t;e++){const t=s[e];if(t.isRenderer&&0!=(t.queryMask&r)){const e=t.raycast(n);Me(e)&&i.push({renderer:t,intersection:e})}}return i.sort(((e,t)=>e.intersection.distance-t.intersection.distance)),i[0]}raycast(e,t=ze.Everything){const{tempRaycaster:r}=$e;if(e instanceof y){const{entity:t,_pixelViewport:n}=this,i=(e.x-n.x)/n.z,s=(e.y-n.y)/n.w;if(i>1||i<0||s>1||s<0)return[];r.setFromCamera(new y(2*i-1,1-2*s),t.transform.object3D)}else r.ray.copy(e),r.camera=this.entity.transform.object3D;const n=[],{scene:i}=this,{rootEntity:s}=i;return Ve.traverse(s,(e=>{const s=e.getAllComponents();for(let o=0,a=s.length;o<a;o++){const a=s[o];if(a.isRenderer&&0!=(a.queryMask&t)){const t=a.raycast(r);Me(t)&&n.push({scene:i,entity:e,renderer:a,intersection:t})}}s.length=0})),n.sort(((e,t)=>e.intersection.distance-t.intersection.distance)),n}screenPointToRay(e,t){const{entity:r,_pixelViewport:n}=this,i=(e.x-n.x)/n.z,s=(e.y-n.y)/n.w;return $e.tempRaycaster.setFromCamera(new y(2*i-1,1-2*s),r.transform.object3D),t.copy($e.tempRaycaster.ray),t}worldToScreenPoint(e,t){const{entity:r,_pixelViewport:n}=this,i=$e.tempvec3.copy(e).project(r.transform.object3D);return t.x=n.x+Math.round(.5*(1+i.x)*n.z),t.y=n.y+Math.round(.5*(1-i.y)*n.w),t}_renderDepth(){const{_depthTarget:e,entity:t,scene:r}=this;if(Me(e)&&Me(r)){const{rootEntity:n}=r,{gl:i}=t.engine,s=i.autoClear,o=i.getScissorTest(),a=i.getRenderTarget();this.emit({type:me.BEFORE_CAMERA_DEPTH_RENDER}),r.emit({type:me.BEFORE_CAMERA_DEPTH_RENDER,camera:this}),i.autoClear=!0,i.setScissorTest(!1),i.setRenderTarget(e),i.render(n.transform.object3D,t.transform.object3D),i.autoClear=s,i.setScissorTest(o),i.setRenderTarget(a),this.emit({type:me.AFTER_CAMERA_DEPTH_RENDER}),r.emit({type:me.AFTER_CAMERA_DEPTH_RENDER,camera:this})}}_onBeforeRender(){this.emit({type:me.BEFORE_CAMERA_RENDER}),this.scene.emit({type:me.BEFORE_CAMERA_RENDER,camera:this})}_onAfterRender(){this.emit({type:me.AFTER_CAMERA_RENDER}),this.scene.emit({type:me.AFTER_CAMERA_RENDER,camera:this})}_notifyCameraChanged(){const{scene:e,_updateFlagManager:t}=this;t.dispatch(),this.emit({type:me.CAMERA_CHANGED,camera:this}),Me(e)&&e.isActive&&e.emit({type:me.CAMERA_CHANGED,camera:this})}_upatePixelViewport(){var e,t;const{entity:r,_viewport:n,_pixelViewport:i,_renderTarget:s,_depthTarget:o}=this,a=null!==(e=null==s?void 0:s.width)&&void 0!==e?e:r.engine.viewport.clientWidth,c=null!==(t=null==s?void 0:s.height)&&void 0!==t?t:r.engine.viewport.clientHeight;i.set(a*n.x,c*n.y,a*n.z,c*n.w),Me(o)&&o.setSize(i.z,i.w)}_onEnableInScene(){this.scene._attachRenderCamera(this)}_onDisableInScene(){this.scene._detachRenderCamera(this)}_onDestroy(){this.entity.transform.updateFlagManager.removeListener(this._notifyCameraChanged)}}Ye([Qe()],Ze.prototype,"priority",null),Ye([Qe()],Ze.prototype,"viewport",null),Ye([Qe()],Ze.prototype,"enableDepth",null);class Xe extends Ze{set near(e){const{_camera:t}=this;t.near!==e&&(t.near=e,this.updateProjectionMatrix())}get near(){return this._camera.near}set far(e){const{_camera:t}=this;t.far!==e&&(t.far=e,this.updateProjectionMatrix())}get far(){return this._camera.far}set frustumSize(e){const{_camera:t}=this;if(this._frustumSize!==e){this._frustumSize=e;const{engine:r}=this.entity,{clientWidth:n,clientHeight:i}=r.viewport,s=this._frustumSize,o=s*(i/n);t.left=-s/2,t.right=s/2,t.top=o/2,t.bottom=-o/2,this.updateProjectionMatrix()}}get frustumSize(){return this._frustumSize}constructor(e,t={}){super(e,t),this.isOrthographicCamera=!0;const{transform:r}=e,{near:n=.1,far:i=2e3,frustumSize:s}=t,{_pixelViewport:o}=this,a=o.z,c=o.w/a;this._frustumSize=Se(s,a),this._camera=r.object3D,this._camera.near=n,this._camera.far=i,this._camera.left=-this._frustumSize/2,this._camera.right=this._frustumSize/2,this._camera.top=this._frustumSize*c/2,this._camera.bottom=-this._frustumSize*c/2,this.updateProjectionMatrix()}screenToWorldPoint(e,t){const{_camera:r,_pixelViewport:n}=this,{near:i,far:s}=r;return t.x=(e.x-n.x)/n.z*2-1,t.y=1-(e.y-n.y)/n.w*2,t.z=2/(s-i)-(s+i)/((s-i)*e.z),t.unproject(r)}resize(e,t){this._upatePixelViewport()}updateWorldMatrix(){this._camera.updateMatrixWorld(!0),this._notifyCameraChanged()}updateProjectionMatrix(){this._camera.updateProjectionMatrix(),this._notifyCameraChanged()}_upatePixelViewport(){super._upatePixelViewport();const{_camera:e,_frustumSize:t,_pixelViewport:r}=this;if(Me(e)){const n=r.w/r.z;e.left=-t/2,e.right=t/2,e.top=t*n/2,e.bottom=-t*n/2,this.updateProjectionMatrix()}}}Ye([Qe()],Xe.prototype,"near",null),Ye([Qe()],Xe.prototype,"far",null),Ye([Qe()],Xe.prototype,"frustumSize",null);class Je extends Ze{set fov(e){const{_camera:t}=this;t.fov!==e&&(t.fov=e,this.updateProjectionMatrix())}get fov(){return this._camera.fov}set near(e){const{_camera:t}=this;t.near!==e&&(t.near=e,this.updateProjectionMatrix())}get near(){return this._camera.near}set far(e){const{_camera:t}=this;t.far!==e&&(t.far=e,this.updateProjectionMatrix())}get far(){return this._camera.far}constructor(e,t={}){super(e,t),this.isPerspectiveCamera=!0;const{transform:r}=e,{fov:n=45,near:i=.1,far:s=2e3}=t,{_pixelViewport:o}=this;this._camera=r.object3D,this._camera.fov=n,this._camera.near=i,this._camera.far=s,this._camera.aspect=o.z/o.w,this.updateProjectionMatrix()}screenToWorldPoint(e,t){const{_camera:r,_pixelViewport:n}=this,{near:i,far:s}=r;return t.x=(e.x-n.x)/n.z*2-1,t.y=1-(e.y-n.y)/n.w*2,t.z=(s+i)/(s-i)-2*s*i/((s-i)*e.z),t.unproject(r)}resize(e,t){this._upatePixelViewport()}updateWorldMatrix(){this._camera.updateMatrixWorld(!0),this._notifyCameraChanged()}updateProjectionMatrix(){this._camera.updateProjectionMatrix(),this._notifyCameraChanged()}_upatePixelViewport(){super._upatePixelViewport();const{_camera:e,_pixelViewport:t}=this;Me(e)&&(e.aspect=t.z/t.w,this.updateProjectionMatrix())}}Ye([Qe()],Je.prototype,"fov",null),Ye([Qe()],Je.prototype,"near",null),Ye([Qe()],Je.prototype,"far",null);class et extends Te{set isActive(e){this._isActive!==e&&(this._isActive=e,e?this.engine._addScene(this):this.engine._removeScene(this))}get isActive(){return this._isActive}get rootEntity(){return this._rootEntity}get activeCameras(){return this._activeCameras}get native(){return this._rootEntity.transform.object3D}set background(e){const{engine:t,_scene:r}=this;Me(r.background)&&r.background instanceof p&&t.resourceManager.disposeTexture(r.background),Me(e)&&this._updateBackground(e)}set backgroundBlurriness(e){const{_scene:t}=this;t.backgroundBlurriness=e}set backgroundIntensity(e){const{_scene:t}=this;t.backgroundIntensity=e}set environment(e){const{engine:t,_scene:r}=this;Me(r.environment)&&t.resourceManager.disposeTexture(r.environment),Me(e)&&this._updateEnvironment(e)}constructor(e,t={}){super(e),this._camerasNeedSorting=!1,this._isActive=!1,this._rootEntity=null,this._activeCameras=[],this._initialize(t)}render(e={}){const{sceneRenderer:t}=this;Me(t)&&(this._onBeforeRender(),t.renderScene(this,e),this._onAfterRender())}createOrthographicCamera(e){const{guid:t,name:r,userData:n,transform:i,camera:s}=e;i.object3D=new j;const o=new Ve(this.engine,{guid:t,name:r,userData:n,transform:i});return o.addComponent(Xe,s).updateWorldMatrix(),Ve._traverseSetOwnerScene(o,this),o}createPerspectiveCamera(e){const{guid:t,name:r,userData:n,transform:i,camera:s}=e;i.object3D=new I;const o=new Ve(this.engine,{guid:t,name:r,userData:n,transform:i});return o.addComponent(Je,s).updateWorldMatrix(),Ve._traverseSetOwnerScene(o,this),o}dispose(){const{_activeCameras:e,_componentsManager:t,engine:r,_rootEntity:n,_scene:i}=this,{resourceManager:s}=r,{background:o,environment:a}=i;this.isActive=!1,Me(o)&&o instanceof p&&s.disposeTexture(o),Me(a)&&s.disposeTexture(a),n.destroy(),t.dispose(),e.length=0,this._scene=null,this._rootEntity=null,this._componentsManager=null}_initialize(e){const{name:t,guid:r,background:n,backgroundBlurriness:i=0,backgroundIntensity:s=1,environment:o,fog:a}=e,c=this._scene=new O;c.matrixWorldAutoUpdate=!1,this._initializeBackground(n,i,s),this._initializeEnvironment(o),this._initializeFog(a),this._rootEntity=new Ve(this.engine,{name:t,guid:r,transform:{object3D:c}}),Ve._traverseSetOwnerScene(this._rootEntity,this),this._componentsManager=new Fe(this)}_initializeBackground(e,t,r){if(Me(e)){const{_scene:n}=this;n.backgroundBlurriness=t,n.backgroundIntensity=r,this._updateBackground(e)}}_initializeEnvironment(e){Me(e)&&this._updateEnvironment(e)}_initializeFog(e){if(Me(e)){const{_scene:t}=this,{isFogExp2:r=!1,color:n="#555555",near:i=1,far:s=100,density:o=25e-5}=e;t.fog=r?new U(new S(n).getHex(),o):new k(n,i,s)}}_updateBackground(e){const{engine:t,_scene:r}=this;if(e instanceof p)r.background=e;else if(e instanceof S||"number"==typeof e||"string"==typeof e)Me(r.background)&&r.background instanceof S?r.background.set(e):r.background=new S(e);else if(Array.isArray(e))switch(e[0].substring(e[0].lastIndexOf(".")+1)){case"exr":case"hdr":t.resourceManager.loadHDRCubeTexture(e).then((e=>{r.background=e.reference().texture}));break;default:t.resourceManager.loadCubeTexture(e).then((e=>{const t=e.reference().texture;t.colorSpace=b,r.background=t}))}else{const{url:n,mapping:i=L}=e;switch(n.substring(n.lastIndexOf(".")+1)){case"exr":t.resourceManager.loadEXRTexture(n).then((e=>{const t=e.reference().texture;t.mapping=i,r.background=t}));break;case"hdr":t.resourceManager.loadHDRTexture(n).then((e=>{const t=e.reference().texture;t.mapping=i,r.background=t}));break;default:t.resourceManager.loadTexture(n).then((e=>{const t=e.reference().texture;t.colorSpace=b,t.mapping=i,r.background=t}))}}}_updateEnvironment(e){const{engine:t,_scene:r}=this;if(e instanceof p)r.environment=e;else if(Array.isArray(e))switch(e[0].substring(e[0].lastIndexOf(".")+1)){case"exr":case"hdr":t.resourceManager.loadHDRCubeTexture(e).then((e=>{r.environment=e.reference().texture}));break;default:t.resourceManager.loadCubeTexture(e).then((e=>{const t=e.reference().texture;t.colorSpace=b,r.environment=t}))}else{const{url:n,mapping:i=L}=e;switch(n.substring(n.lastIndexOf(".")+1)){case"exr":t.resourceManager.loadEXRTexture(n).then((e=>{const t=e.reference().texture;t.mapping=i,r.environment=t}));break;case"hdr":t.resourceManager.loadHDRTexture(n).then((e=>{const t=e.reference().texture;t.mapping=i,r.environment=t}));break;default:t.resourceManager.loadTexture(n).then((e=>{const t=e.reference().texture;t.colorSpace=b,t.mapping=i,r.environment=t}))}}}_onBeforeRender(){this.emit({type:me.BEFORE_SCENE_RENDER}),this.engine.emit({type:me.BEFORE_SCENE_RENDER,scene:this})}_onAfterRender(){this.emit({type:me.AFTER_SCENE_RENDER}),this.engine.emit({type:me.AFTER_SCENE_RENDER,scene:this})}_sortCameras(){this._activeCameras.sort(((e,t)=>e.priority-t.priority)),this._camerasNeedSorting=!1}_attachRenderCamera(e){const{_activeCameras:t}=this;~t.indexOf(e)||(t.push(e),this._camerasNeedSorting=!0)}_detachRenderCamera(e){const{_activeCameras:t}=this,r=t.indexOf(e);~r&&t.splice(r,1)}}class tt extends Te{constructor(e){super(e),e._addSceneRenderer(this)}setSize(e,t){}renderScene(e,t={}){var r;const{gl:n,uniformsLib:i,viewport:s}=this.engine,{activeCameras:o}=e;for(let a=0,c=o.length;a<c;a++){const c=o[a],{pixelViewport:d,depthTexture:l,native:h}=c,{timeSinceLastFrame:p,totalTime:u,timeStamp:g,frame:m,renderTarget:f=c.renderTarget}=t,{matrixWorld:_,matrixWorldInverse:v,projectionMatrix:x,projectionMatrixInverse:y}=h;i.cameraType.value=h.isOrthographicCamera?0:1,i.cameraNearFar.value.set(h.near,h.far),i.cameraWorldMatrix.value.copy(_),i.cameraWorldMatrixInverse.value.copy(v),i.cameraProjectionMatrix.value.copy(x),i.cameraProjectionMatrixInverse.value.copy(y),i.cameraDepthTexture.value=l,i.viewport.value.copy(d).multiplyScalar(Me(f)?1:n.getPixelRatio()).floor(),i.resolution.value.set(i.viewport.value.z,i.viewport.value.w),c._renderDepth(),c._onBeforeRender();const w=d.x,z=(null!==(r=null==f?void 0:f.height)&&void 0!==r?r:s.clientHeight)-d.y-d.w,P=d.z,b=d.w;Me(f)?(f.viewport.set(w,z,P,b),f.scissor.set(w,z,P,b),f.scissorTest=!0):(n.setViewport(w,z,P,b),n.setScissor(w,z,P,b),n.setScissorTest(!0)),this._renderCameraScene(e,c,{timeSinceLastFrame:p,totalTime:u,timeStamp:g,frame:m,renderTarget:f}),c._onAfterRender()}}dispose(){super.dispose(),this.engine._removeSceneRenderer(this)}_renderCameraScene(e,t,r){const{gl:n}=this.engine,{autoClear:i}=n,{renderTarget:s=null}=r;n.autoClear=!0,n.setRenderTarget(s),n.render(e.native,t.native),n.autoClear=i}}class rt extends Ne{constructor(e,t){super(e,t),this._onUpdateIndex=-1,this.controller=t.controller}update(e){this.enabled&&(this.controller.update(e),this.entity.transform.updateWorldMatrix())}_onEnableInScene(){const{_componentsManager:e}=this.scene;e.addOnUpdateAnimator(this)}_onDisableInScene(){const{_componentsManager:e}=this.scene;e.removeOnUpdateAnimator(this)}_onDestroy(){this.controller.destroy()}}class nt{}class it extends nt{get animationMixer(){return this._mixer}get animationClips(){return this._animations}constructor(e,t){super(),this._animations=t,this._mixer=new B(e)}animationNames(){const e=[];for(let t=0,r=this._animations.length;t<r;t++)e.push(this._animations[t].name);return e}play(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);Me(n)&&r.clipAction(n).play()}pause(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&(n.clipAction(i).paused=t)}stop(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);Me(n)&&r.clipAction(n).stop()}reset(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);Me(n)&&r.clipAction(n).reset()}isRunning(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return!!Me(n)&&r.clipAction(n).isRunning()}isScheduled(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return!!Me(n)&&r.clipAction(n).isScheduled()}isPaused(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return!!Me(n)&&r.clipAction(n).paused}setEnabled(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&(n.clipAction(i).enabled=t)}setDuration(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&n.clipAction(i).setDuration(t)}getDuration(e){const{_animations:t}=this,r=F.findByName(t,e);return Me(r)?r.duration:0}setTimeScale(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&(n.clipAction(i).timeScale=t)}getTimeScale(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return Me(n)?r.clipAction(n).timeScale:0}setEffectiveTimeScale(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&n.clipAction(i).setEffectiveTimeScale(t)}getEffectiveTimeScale(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return Me(n)?r.clipAction(n).getEffectiveTimeScale():0}setWeight(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&(n.clipAction(i).weight=t)}getWeight(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return Me(n)?r.clipAction(n).weight:0}setEffectiveWeight(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&n.clipAction(i).setEffectiveWeight(t)}getEffectiveWeight(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return Me(n)?r.clipAction(n).getEffectiveWeight():0}setTime(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&(n.clipAction(i).time=t)}getTime(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);return Me(n)?r.clipAction(n).time:0}setStartAt(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&n.clipAction(i).startAt(t)}setClampWhenFinished(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&(n.clipAction(i).clampWhenFinished=t)}setLoop(e,t,r){const{_animations:n,_mixer:i}=this,s=F.findByName(n,e);Me(s)&&i.clipAction(s).setLoop(t,r)}fadeIn(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&n.clipAction(i).fadeIn(t)}fadeOut(e,t){const{_animations:r,_mixer:n}=this,i=F.findByName(r,e);Me(i)&&n.clipAction(i).fadeOut(t)}crossFadeFromTo(e,t,r,n){const{_animations:i,_mixer:s}=this,o=F.findByName(i,e),a=F.findByName(i,t);if(Me(o)&&Me(a)){const e=s.clipAction(o),t=s.clipAction(a);e.crossFadeTo(t,r,n)}}stopFading(e){const{_animations:t,_mixer:r}=this,n=F.findByName(t,e);Me(n)&&r.clipAction(n).stopFading()}update(e){this._mixer.update(e)}destroy(){const e=this._mixer.getRoot();this._mixer.uncacheRoot(e),this._mixer=null,this._animations.length=0}}class st extends Ne{set color(e){this._light.color.set(e)}set intensity(e){this._light.intensity=e}get light(){return this._light}constructor(e,t={}){super(e,t),this._intialize(t)}_intialize(e){const{color:t="#ffffff",intensity:r=1}=e,n=this._light=new N(t,r);this.entity.transform.object3D.add(n)}_onDestroy(){this._light.removeFromParent(),this._light.dispose(),this._light=null}}Ye([Qe()],st.prototype,"color",null),Ye([Qe()],st.prototype,"intensity",null);class ot extends Ne{set color(e){this._light.color.set(e)}set intensity(e){this._light.intensity=e}set position(e){this._light.position.copy(e),this._light.updateMatrixWorld(!0)}set target(e){this._light.target.position.copy(e),this._light.target.updateMatrixWorld(!0)}get light(){return this._light}constructor(e,t={}){super(e,t),this._initialize(t)}setTarget(e,t=!1){const{entity:r,_light:n}=this;t?n.target.position.copy(r.transform.worldToLocal(e)):n.target.position.copy(e),n.target.updateMatrixWorld(!0),this.emit({type:me.ATTRIBUTE_CHANGED,name:"target",value:n.target.clone()})}translateTargetOnAxis(e,t){const{_light:r}=this,{target:n}=r;n.position.copy(r.position).add(e.clone().multiplyScalar(t)),n.updateMatrixWorld(!0),this.emit({type:me.ATTRIBUTE_CHANGED,name:"position",value:r.position.clone()})}_initialize(e){const{color:t="#ffffff",intensity:r=1,castShadow:n=!1,shadow:i={},position:s,target:o}=e,a=this._light=new W(t,r);if(n){a.castShadow=n;const{bias:e=0,autoUpdate:t=!0,needsUpdate:r=!1,mapSize:s=512,camera:o={near:.5,far:500}}=i,{near:c,far:d,frustumSize:l=512}=o;a.shadow.bias=e,a.shadow.autoUpdate=t,a.shadow.needsUpdate=r,a.shadow.mapSize.set(s,s),a.shadow.camera.near=c,a.shadow.camera.far=d,a.shadow.camera.left=-l/2,a.shadow.camera.right=l/2,a.shadow.camera.top=l/2,a.shadow.camera.bottom=-l/2}Me(s)&&a.position.copy(s),Me(o)?a.target.position.copy(o):a.target.position.copy(this.entity.transform.worldToLocal(new A(0,0,0))),this.entity.transform.object3D.add(a),this.entity.transform.object3D.add(a.target),a.updateMatrixWorld(!0),a.target.updateMatrixWorld(!0)}_onDestroy(){this._light.removeFromParent(),this._light.target.removeFromParent(),this._light.dispose(),this._light=null}}Ye([Qe()],ot.prototype,"color",null),Ye([Qe()],ot.prototype,"intensity",null),Ye([Qe()],ot.prototype,"position",null),Ye([Qe()],ot.prototype,"target",null);class at extends Ne{set skyColor(e){this._light.color.set(e)}set groundColor(e){this._light.groundColor.set(e)}set intensity(e){this._light.intensity=e}get light(){return this._light}constructor(e,t={}){super(e,t),this._initialize(t)}_initialize(e){const{skyColor:t="#ffffff",groundColor:r="#ffffff",intensity:n=1}=e,i=this._light=new q(t,r,n);this.entity.transform.object3D.add(i),i.updateMatrixWorld(!0)}_onDestroy(){this._light.removeFromParent(),this._light.dispose(),this._light=null}}Ye([Qe()],at.prototype,"skyColor",null),Ye([Qe()],at.prototype,"groundColor",null),Ye([Qe()],at.prototype,"intensity",null);class ct extends Ne{set color(e){this._light.color.set(e)}set intensity(e){this._light.intensity=e}set power(e){this._light.power=e}set watts(e){this._light.intensity=683*e/(4*Math.PI)}set distance(e){this._light.distance=e}set decay(e){this._light.decay=e}set position(e){this._light.position.copy(e),this._light.updateMatrixWorld(!0)}get light(){return this._light}constructor(e,t={}){super(e,t),this._initialize(t)}_initialize(e){const{color:t="#ffffff",intensity:r=1,distance:n=0,decay:i=2,power:s,watts:o,castShadow:a=!1,shadow:c={},position:d}=e,l=this._light=new K(t,r,n,i);if(Me(s)&&(l.power=s),Me(o)&&(l.intensity=683*o/(4*Math.PI)),a){l.castShadow=a;const{bias:e=0,autoUpdate:t=!0,needsUpdate:r=!1,mapSize:n=512,camera:i={near:.5,far:500}}=c;l.shadow.bias=e,l.shadow.autoUpdate=t,l.shadow.needsUpdate=r,l.shadow.mapSize.set(n,n),l.shadow.camera.near=i.near,l.shadow.camera.far=i.far}Me(d)&&l.position.copy(d),this.entity.transform.object3D.add(l),l.updateMatrixWorld(!0)}_onDestroy(){this._light.removeFromParent(),this._light.dispose(),this._light=null}}Ye([Qe()],ct.prototype,"color",null),Ye([Qe()],ct.prototype,"intensity",null),Ye([Qe()],ct.prototype,"power",null),Ye([Qe()],ct.prototype,"watts",null),Ye([Qe()],ct.prototype,"distance",null),Ye([Qe()],ct.prototype,"decay",null),Ye([Qe()],ct.prototype,"position",null);class dt extends Ne{set color(e){this._light.color.set(e)}set intensity(e){this._light.intensity=e}set power(e){this._light.power=e}set watts(e){this._light.intensity=683*e/Math.PI}set distance(e){this._light.distance=e}set angle(e){this._light.angle=e}set penumbra(e){this._light.penumbra=R.clamp(e,0,1)}set decay(e){this._light.decay=e}set position(e){this._light.position.copy(e),this._light.updateMatrixWorld(!0)}set target(e){this._light.target.position.copy(e),this._light.target.updateMatrixWorld(!0)}get light(){return this._light}constructor(e,t={}){super(e,t),this._initialize(t)}setTarget(e,t=!1){const{entity:r,_light:n}=this;t?n.target.position.copy(r.transform.worldToLocal(e)):n.target.position.copy(e),n.target.updateMatrixWorld(!0),this.emit({type:me.ATTRIBUTE_CHANGED,name:"target",value:n.target.clone()})}translateTargetOnAxis(e,t){const{_light:r}=this,{target:n}=r;n.position.copy(r.position).add(e.clone().multiplyScalar(t)),n.updateMatrixWorld(!0),this.emit({type:me.ATTRIBUTE_CHANGED,name:"position",value:r.position.clone()})}_initialize(e){const{color:t="#ffffff",intensity:r=1,distance:n=0,angle:i=Math.PI/6,penumbra:s=0,decay:o=2,power:a,watts:c,castShadow:d=!1,shadow:l={},position:h,target:p}=e,u=this._light=new G(t,r,n,i,s,o);if(Me(a)&&(u.power=a),Me(c)&&(u.intensity=683*c/Math.PI),d){u.castShadow=d;const{bias:e=0,autoUpdate:t=!0,needsUpdate:r=!1,mapSize:n=512,camera:i={near:.5,far:500}}=l;u.shadow.bias=e,u.shadow.autoUpdate=t,u.shadow.needsUpdate=r,u.shadow.mapSize.set(n,n),u.shadow.camera.near=i.near,u.shadow.camera.far=i.far}Me(h)&&u.position.copy(h),Me(p)?u.target.position.copy(p):u.target.position.copy(this.entity.transform.worldToLocal(new A(0,0,0))),this.entity.transform.object3D.add(u),this.entity.transform.object3D.add(u.target),u.updateMatrixWorld(!0),u.target.updateMatrixWorld(!0)}_onDestroy(){this._light.removeFromParent(),this._light.dispose(),this._light=null}}Ye([Qe()],dt.prototype,"color",null),Ye([Qe()],dt.prototype,"intensity",null),Ye([Qe()],dt.prototype,"power",null),Ye([Qe()],dt.prototype,"watts",null),Ye([Qe()],dt.prototype,"distance",null),Ye([Qe()],dt.prototype,"angle",null),Ye([Qe()],dt.prototype,"penumbra",null),Ye([Qe()],dt.prototype,"decay",null),Ye([Qe()],dt.prototype,"position",null),Ye([Qe()],dt.prototype,"target",null);class lt extends Ne{set color(e){this._light.color.set(e)}set intensity(e){this._light.intensity=e}set power(e){this._light.power=e}set watts(e){this._light.intensity=683*e/(Math.PI*this._light.width*this._light.height)}set width(e){this._light.width=e}set height(e){this._light.height=e}set position(e){this._light.position.copy(e),this._light.updateMatrixWorld(!0)}set rotation(e){this._light.rotation.copy(e),this._light.updateMatrixWorld(!0)}set quaternion(e){this._light.quaternion.copy(e),this._light.updateMatrixWorld(!0)}get light(){return this._light}constructor(e,t={}){super(e,t),this._initialize(t)}_initialize(e){ke.initRectAreaLightUniforms();const{color:t="#ffffff",intensity:r=1,width:n=10,height:i=10,power:s,watts:o,position:a,rotation:c,quaternion:d}=e,l=this._light=new H(t,r,n,i);Me(s)&&(l.power=s),Me(o)&&(l.intensity=683*o/(Math.PI*n*i)),Me(a)&&l.position.copy(a),Me(c)&&l.rotation.copy(c),Me(d)&&l.quaternion.copy(d),this.entity.transform.object3D.add(l),l.updateMatrixWorld(!0)}_onDestroy(){this._light.removeFromParent(),this._light.dispose(),this._light=null}}Ye([Qe()],lt.prototype,"color",null),Ye([Qe()],lt.prototype,"intensity",null),Ye([Qe()],lt.prototype,"power",null),Ye([Qe()],lt.prototype,"watts",null),Ye([Qe()],lt.prototype,"width",null),Ye([Qe()],lt.prototype,"height",null),Ye([Qe()],lt.prototype,"position",null),Ye([Qe()],lt.prototype,"rotation",null),Ye([Qe()],lt.prototype,"quaternion",null);class ht{constructor(){this._flagManagers=[]}clearFromManagers(){this._removeFromManager(),this._flagManagers.length=0}destroy(){this._removeFromManager(),this._flagManagers=null}_removeFromManager(){const{_flagManagers:e}=this;for(let t=0,r=e.length;t<r;t++)De(e[t]._updateFlags,this)}}class pt extends ht{constructor(){super(...arguments),this.flag=!0}dispatch(e,t){this.flag=!0}}class ut extends Ne{set visible(e){this._object3D.visible=e}set renderOrder(e){this._renderOrder=e,this._updateRenderOrder()}get renderOrder(){return this._renderOrder}set position(e){this.setTransformation({position:e})}get position(){return this._object3D.position}set scale(e){this.setTransformation({scale:e})}get scale(){return this._object3D.scale}set rotation(e){this.setTransformation({rotation:e})}get rotation(){return this._object3D.rotation}set quaternion(e){this.setTransformation({quaternion:e})}get quaternion(){return this._object3D.quaternion}get object3D(){return this._object3D}get worldBounds(){const{_bounds:e,_boundsUpdateFlag:t}=this;return(t.flag||e.isEmpty())&&(this._updateWorldBounds(),t.flag=!1),e}constructor(e,t={}){super(e,t),this.isRenderer=!0,this._onUpdateIndex=-1,this._bounds=new V;const{queryMask:r=ze.Nothing,renderOrder:n=xe.DEFAULT,onBeforeRender:i=null,onAfterRender:s=null}=t;this.queryMask=r,this._renderOrder=n,this._onBeforeRender=i,this._onAfterRender=s,this._boundsUpdateFlag=e.transform.updateFlagManager.createFlag(pt)}getWorldPosition(e){return this._object3D.getWorldPosition(e)}getWorldScale(e){return this._object3D.getWorldScale(e)}getWorldQuaternion(e){return this._object3D.getWorldQuaternion(e)}getWorldDirection(e){return this._object3D.getWorldDirection(e)}setTransformation(e){const{position:t,scale:r,rotation:n,quaternion:i}=e,{_object3D:s}=this;Me(t)&&s.position.copy(t),Me(r)&&s.scale.copy(r),Me(n)&&s.rotation.copy(n),Me(i)&&s.quaternion.copy(i),this._updateWorldMatrix()}lookAt(e){this._object3D.lookAt(e),this._updateWorldMatrix()}localToWorld(e){const{_object3D:t}=this;return Me(t)?t.localToWorld(e):null}worldToLocal(e){const{_object3D:t}=this;return Me(t)?t.worldToLocal(e):null}updateWorldMatrix(){this._updateWorldMatrix()}update(e,t){}_onEnable(){const{entity:e,_object3D:t,_onBeforeRender:r,_onAfterRender:n,scene:i}=this,{_componentsManager:s}=i,{prototype:o}=ut;if(this.update!==o.update&&s.addOnUpdateRenderer(this),Me(t)){const{transform:i}=e,{parent:s}=t;if(Me(s)&&s===i.object3D||i.object3D.add(t),Me(r)){const e=t.onBeforeRender;Me(e)?t.onBeforeRender=(...t)=>{e(...t),r(...t)}:t.onBeforeRender=r}if(Me(n)){const e=t.onAfterRender;Me(e)?t.onAfterRender=(...t)=>{e(...t),n(...t)}:t.onAfterRender=n}this._updateWorldMatrix()}}_onDisable(){const{_object3D:e,scene:t}=this,{_componentsManager:r}=t,{prototype:n}=ut;this.update!==n.update&&r.removeOnUpdateRenderer(this),Me(e)&&e.removeFromParent()}_onDestroy(){this._destroy()}_updateRenderOrder(){const{_object3D:e,_renderOrder:t}=this;e.traverse((e=>{(e.isMesh||e.isLine||e.isPoints||e.isSprite)&&(e.renderOrder=t)}))}_updateWorldMatrix(){const{_boundsUpdateFlag:e,_object3D:t}=this;t.updateMatrixWorld(!0),e.flag=!0}_updateWorldBounds(){this._bounds.setFromObject(this._object3D)}}Ye([Qe()],ut.prototype,"visible",null),Ye([Qe()],ut.prototype,"renderOrder",null),Ye([Qe()],ut.prototype,"position",null),Ye([Qe()],ut.prototype,"scale",null),Ye([Qe()],ut.prototype,"rotation",null),Ye([Qe()],ut.prototype,"quaternion",null);class gt extends ut{set mesh(e){if(this._object3D!==e&&(Me(this._object3D)&&(this._object3D.removeFromParent(),this._destroy()),Me(e))){this._object3D=e,this._object3D.renderOrder=this._renderOrder,this.entity.transform.object3D.add(this._object3D);const{_onBeforeRender:t,_onAfterRender:r}=this;if(Me(t)){const e=this._object3D.onBeforeRender;Me(e)?this._object3D.onBeforeRender=(...r)=>{e(...r),t(...r)}:this._object3D.onBeforeRender=t}if(Me(r)){const e=this._object3D.onAfterRender;Me(e)?this._object3D.onAfterRender=(...t)=>{e(...t),r(...t)}:this._object3D.onAfterRender=r}this._updateWorldMatrix()}}constructor(e,t={}){super(e,t);const{mesh:r}=t;Me(r)&&(this._object3D=r,this._object3D.renderOrder=this._renderOrder,this.entity.transform.object3D.add(this._object3D))}raycast(e){const{_object3D:t}=this;if(!Me(t)||!t.visible)return null;const r=[];return t.raycast(e,r),r.length>0?(r.sort(((e,t)=>e.distance-t.distance)),r[0]):null}_destroy(){if(Me(this._object3D)){const{resourceManager:e}=this.entity.engine,{geometry:t,material:r}=this._object3D;if(t.dispose(),Array.isArray(r))for(let t=0,n=r.length;t<n;t++)e.disposeMaterial(r[t]);else e.disposeMaterial(r)}}}Ye([Qe()],gt.prototype,"mesh",null);class mt extends ut{set visible(e){const{_meshes:t}=this;for(let r=0,n=t.length;r<n;r++)t[r].visible=e}set position(e){this.entity.transform.position=e}get position(){return this.entity.transform.position}set scale(e){this.entity.transform.scale=e}get scale(){return this.entity.transform.scale}set rotation(e){this.entity.transform.rotation=e}get rotation(){return this.entity.transform.rotation}set quaternion(e){this.entity.transform.quaternion=e}get quaternion(){return this.entity.transform.quaternion}set castShadow(e){for(let t=0,r=this._meshes.length;t<r;t++)this._meshes[t].castShadow=e}set receiveShadow(e){for(let t=0,r=this._meshes.length;t<r;t++)this._meshes[t].receiveShadow=e}get object3D(){return this._meshes}get meshes(){return this._meshes}constructor(e,t){super(e,t),this._meshes=[],this._initialize(t)}setTransformation(e){this.entity.transform.setTransformation(e)}lookAt(e){this.entity.transform.lookAt(e)}localToWorld(e){return this.entity.transform.localToWorld(e)}worldToLocal(e){return this.entity.transform.worldToLocal(e)}updateWorldMatrix(){this.entity.transform.updateWorldMatrix()}setMorphTargetInfluence(e,t,r=1){const{_meshes:n}=this;for(let i=0,s=n.length;i<s;i++)mt._updateMorphTargetInfluence(n[i],e,t,r)}raycast(e){const t=[],{_meshes:r}=this;for(let n=0,i=r.length;n<i;n++){const i=r[n];i.visible&&i.raycast(e,t)}return t.length>0?(t.sort(((e,t)=>e.distance-t.distance)),t[0]):null}_initialize(e){const{renderOrder:t,castShadow:r,receiveShadow:n,resource:i,meshes:s}=e;for(let e=0,i=s.length;e<i;e++){const i=s[e];i.renderOrder=t,i.castShadow=r,i.receiveShadow=n,this._meshes.push(i)}this._resource=i.reference()}static _updateMorphTargetInfluence(e,t,r,n){const{morphTargetDictionary:i,morphTargetInfluences:s}=e;if(Me(i)&&Me(s)){const e=i[t];Me(e)&&(s[e]=R.lerp(s[e],R.clamp(r,0,1),n))}}_onEnable(){const{_bounds:e,_meshes:t,_onBeforeRender:r,_onAfterRender:n}=this;e.makeEmpty();for(let i=0,s=t.length;i<s;i++){const s=t[i];if(Me(r)){const e=s.onBeforeRender;Me(e)?s.onBeforeRender=(...t)=>{e(...t),r(...t)}:s.onBeforeRender=r}if(Me(n)){const e=s.onAfterRender;Me(e)?s.onAfterRender=(...t)=>{e(...t),n(...t)}:s.onAfterRender=n}s.updateMatrixWorld(!0),e.expandByObject(s)}}_onDisable(){}_updateWorldMatrix(){this._boundsUpdateFlag.flag=!0}_updateWorldBounds(){const{_bounds:e,_meshes:t}=this;e.makeEmpty();for(let r=0,n=t.length;r<n;r++)e.expandByObject(t[r])}_destroy(){this._resource.dispose(),this._resource=null,this._meshes.length=0}}Ye([Qe()],mt.prototype,"visible",null),Ye([Qe()],mt.prototype,"position",null),Ye([Qe()],mt.prototype,"scale",null),Ye([Qe()],mt.prototype,"rotation",null),Ye([Qe()],mt.prototype,"quaternion",null),Ye([Qe()],mt.prototype,"castShadow",null),Ye([Qe()],mt.prototype,"receiveShadow",null);class ft extends Ne{constructor(){super(...arguments),this.isScript=!0,this._started=!1,this._entityScriptsIndex=-1,this._onStartIndex=-1,this._onUpdateIndex=-1,this._onLateUpdateIndex=-1,this._onPhysicsUpdateIndex=-1}onAwake(){}onEnable(){}onStart(){}onUpdate(e,t){}onLateUpdate(e,t){}onDisable(){}onDestroy(){}onPhysicsUpdate(){}_onAwake(){this.onAwake()}_onEnable(){const{_componentsManager:e}=this.scene,{prototype:t}=ft;this._started||e.addOnStartScript(this),this.onUpdate!==t.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==t.onLateUpdate&&e.addOnLateUpdateScript(this),this.onPhysicsUpdate!==t.onPhysicsUpdate&&e.addOnPhysicsUpdateScript(this),this.entity._addScript(this),this.onEnable()}_onDisable(){const{_componentsManager:e}=this.scene,{prototype:t}=ft;this._started||e.removeOnStartScript(this),this.onUpdate!==t.onUpdate&&e.removeOnUpdateScript(this),this.onLateUpdate!==t.onLateUpdate&&e.removeOnLateUpdateScript(this),this.onPhysicsUpdate!==t.onPhysicsUpdate&&e.removeOnPhysicsUpdateScript(this),this.entity._removeScript(this),this.onDisable()}_onDestroy(){this.onDestroy()}}class _t extends g{constructor(e=new y){super({uniforms:{inputBuffer:{value:null},depthBuffer:{value:null},resolution:{value:new y},texelSize:{value:new y(e.x,e.y)},halfTexelSize:{value:new y(.5*e.x,.5*e.y)},kernel:{value:0},scale:{value:1},minDepthThreshold:{value:0},maxDepthThreshold:{value:1},depthScale:{value:0},depthToBlurRatioBias:{value:.25}},vertexShader:"#define GLSLIFY 1\nuniform vec2 texelSize;uniform vec2 halfTexelSize;uniform float kernel;uniform float scale;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv=uv;vec2 dUv=(texelSize*vec2(kernel)+halfTexelSize)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",fragmentShader:"#define GLSLIFY 1\n#include <common>\n#include <dithering_pars_fragment>\nuniform sampler2D inputBuffer;uniform sampler2D depthBuffer;uniform float minDepthThreshold;uniform float maxDepthThreshold;uniform float depthScale;uniform float depthToBlurRatioBias;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){float depthFactor=0.0;\n#ifdef USE_DEPTH\nvec4 depth=texture2D(depthBuffer,vUv);depthFactor=smoothstep(minDepthThreshold,maxDepthThreshold,1.0-(depth.r*depth.a));depthFactor*=depthScale;depthFactor=max(0.0,min(1.0,depthFactor+0.25));\n#endif\nvec4 sum=texture2D(inputBuffer,mix(vUv0,vUv,depthFactor));sum+=texture2D(inputBuffer,mix(vUv1,vUv,depthFactor));sum+=texture2D(inputBuffer,mix(vUv2,vUv,depthFactor));sum+=texture2D(inputBuffer,mix(vUv3,vUv,depthFactor));gl_FragColor=sum*0.25;\n#include <dithering_fragment>\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n}",blending:Y,depthWrite:!1,depthTest:!1}),this.kernel=new Float32Array([0,1,2,2,3]),this.toneMapped=!1,this.setTexelSize(e.x,e.y)}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(.5*e,.5*t)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class vt{get size(){return this._items.length}get empty(){return 0===this._items.length}constructor(e){this._items=[],this._compareFn=e}enqueue(e){this._items.push(e);let t=this._items.length-1;for(;0!==t&&this._compare(this._items[this._parentOf(t)],this._items[t]);)this._swap(t,this._parentOf(t)),t=this._parentOf(t)}dequeue(){if(0===this._items.length)return null;this._swap(0,this._items.length-1);const e=this._items.pop();return this._heapify(0),e}peek(){return this._items.length>0?this._items[0]:null}clear(){this._items.length=0}contains(e,t){if(0===this._items.length)return!1;const r=t||(t=>t===e),n=Math.floor(this._items.length/2);let i,s,o=0;for(;o<=n-1;){if(i=2*o+1,s=2*o+2,this._items[o]&&r(this._items[o])||this._items[i]&&r(this._items[i])||this._items[s]&&r(this._items[s]))return!0;o++}return!1}_heapify(e){const t=this._items.length,r=Math.floor(t/2);let n,i,s;for(;e<=r-1&&(n=2*e+(t<=2?0:1),i=2*e+(t<=2?1:2),s=n,this._compare(this._items[n],this._items[i])&&(s=i),this._compare(this._items[e],this._items[s])&&this._swap(e,s),e!==s);)e=s}_swap(e,t){const r=this._items[e];this._items[e]=this._items[t],this._items[t]=r}_compare(e,t){return this._compareFn?this._compareFn(e,t):e<t}_parentOf(e){return Math.floor((e-1)/2)}}class xt{constructor(){this._items={},this._size=0}get size(){return this._size}get empty(){return 0===this._size}push(e){this._items[this._size++]=e}pop(){if(this.empty)return null;const e=this._items[--this._size];return delete this._items[this._size],e}peek(){return this.empty?null:this._items[this._size-1]}clear(){this._items={},this._size=0}}const yt={easeLinear:e=>e,easeInQuad:e=>e*e,easeOutQuad:e=>e*(2-e),easeInOutQuad:e=>(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1),easeInCubic:e=>e*e*e,easeOutCubic:e=>--e*e*e+1,easeInOutCubic:e=>(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2),easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1- --e*e*e*e,easeInOutQuart:e=>(e*=2)<1?.5*e*e*e*e*e:-.5*((e-=2)*e*e*e-2),easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>--e*e*e*e*e+1,easeInOutQuint:e=>(e*=2)<1?.5*e*e*e*e*e:(e-=2)*e*e*e*e*.5,easeInSine:e=>1-Math.sin((1-e)*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>.5*(1-Math.sin(Math.PI*(.5-e))),easeInExpo:e=>0===e?0:Math.pow(1024,e-1),easeOutExpo:e=>1===e?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1))),easeInCirc:e=>1-Math.sqrt(1-e*e),easeOutCirc:e=>Math.sqrt(1- --e*e),easeInOutCirc:e=>(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1),easeInBack:e=>{const t=1.70158;return 1===e?1:e*e*((t+1)*e-t)},easeOutBack:e=>{const t=1.70158;return 0===e?0:--e*e*((t+1)*e+t)+1},easeInOutBack:e=>{const t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},easeInElastic:e=>0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI),easeOutElastic:e=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1,easeInOutElastic:e=>0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1,easeInBounce:e=>1-yt.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?.5*yt.easeInBounce(2*e):.5*yt.easeOutBounce(2*e-1)+.5};function wt(e){return yt[e]?yt[e]:yt.easeLinear}class zt extends a{constructor(e=1,t=1,r=1,n=1){super(),this.parameters={width:e,height:t,widthSegments:r,heightSegments:n};const i=e/2,s=t/2,o=Math.floor(r),a=Math.floor(n),d=o+1,l=a+1,h=e/o,p=t/a,u=[],g=[],m=[],f=[];for(let e=0;e<l;e++){const t=e*p-s;for(let r=0;r<d;r++){const n=r*h-i;g.push(n,0,-t),m.push(0,1,0),f.push(r/o),f.push(1-e/a)}}for(let e=0;e<a;e++)for(let t=0;t<o;t++){const r=t+d*e,n=t+d*(e+1),i=t+1+d*(e+1),s=t+1+d*e;u.push(r,s,n),u.push(n,s,i)}this.setIndex(u),this.setAttribute("position",new c(g,3)),this.setAttribute("normal",new c(m,3)),this.setAttribute("uv",new c(f,2))}}class Pt{static parse(e,t={}){const{engine:r,glTF:n}=e,{animations:i,scene:s}=n,o=i.length>0||Pt._hasSkeleton(s)?ue.clone(s):s.clone(),a=new Ve(r,{name:o.name,transform:{object3D:o}});i.length>0&&a.addComponent(rt,{controller:new it(o,i)});const{queryMask:c,renderOrder:d=xe.DEFAULT,castShadow:l=!1,receiveShadow:h=!1,useBVH:p=!1,position:u,scale:g,rotation:m,quaternion:f}=t;for(a.transform.setTransformation({position:u,scale:g,rotation:m,quaternion:f}),Pt._tempQueue.enqueue(a);!Pt._tempQueue.empty;){const t=Pt._tempQueue.dequeue(),{object3D:r}=t.transform,{children:n,isGroup:i}=r,s=[];for(let r=0,o=n.length;r<o;r++){const o=n[r];switch(o.type){case"Bone":case"Group":case"Object3D":Pt._tempQueue.enqueue(t.createChild({name:o.name,transform:{object3D:o}}));break;case"Mesh":case"SkinnedMesh":if(i)s.push(o),o.children.length>0&&Pt._tempQueue.enqueue(t.createChild({name:o.name,transform:{object3D:o}}));else{const r=t.createChild({name:o.name,transform:{object3D:o}});r.addComponent(mt,{queryMask:c,renderOrder:d,castShadow:l,receiveShadow:h,resource:e,meshes:[o]}),Pt._tempQueue.enqueue(r)}break;case"DirectionalLight":case"PointLight":case"SpotLight":throw new Error(`${o.type} unsupport.`)}}i&&s.length>0&&(t.addComponent(mt,{queryMask:c,renderOrder:d,castShadow:l,receiveShadow:h,resource:e,meshes:s}),s.length=0)}return a}static _hasSkeleton(e){let t=e.getObjectByProperty("type","Bone");return Me(t)||(t=e.getObjectByProperty("type","SkinnedMesh")),Me(t)}}Pt._tempQueue=new Ke;class bt{constructor(e=257){this.gridSize=e;const t=e-1;if(t&t-1)throw new Error(`Expected grid size to be 2^n+1, got ${e}`);this.numTriangles=t*t*2-2,this.numParentTriangles=this.numTriangles-t*t,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let e=0;e<this.numTriangles;e++){let r=e+2,n=0,i=0,s=0,o=0,a=0,c=0;for(1&r?s=o=a=t:n=i=c=t;(r>>=1)>1;){const e=n+s>>1,t=i+o>>1;1&r?(s=n,o=i,n=a,i=c):(n=s,i=o,s=a,o=c),a=e,c=t}const d=4*e;this.coords[d+0]=n,this.coords[d+1]=i,this.coords[d+2]=s,this.coords[d+3]=o}}createTerrainBuilder(e){return new Mt(e,this)}}class Mt{constructor(e,t){this.terrain=e,this.martini=t;const{length:r}=e,{gridSize:n}=t;if(r!==n*n)throw new Error(`Expected terrain data of length ${n*n} (${n} x ${n}), got ${r}`);this.errors=new Float32Array(r),this.update()}update(){const{martini:e,terrain:t,errors:r}=this,{numTriangles:n,numParentTriangles:i,coords:s,gridSize:o}=e;for(let e=n-1;e>=0;e--){const n=4*e,a=s[n+0],c=s[n+1],d=s[n+2],l=s[n+3],h=a+d>>1,p=c+l>>1,u=h+p-c,g=p+a-h,m=(t[c*o+a]+t[l*o+d])/2,f=p*o+h,_=Math.abs(m-t[f]);if(r[f]=Math.max(r[f],_),e<i){const e=(c+g>>1)*o+(a+u>>1),t=(l+g>>1)*o+(d+u>>1);r[f]=Math.max(r[f],r[e],r[t])}}}createMesh(e=0,t=1){const{martini:r,terrain:n,errors:i}=this,{gridSize:s,indices:o}=r,a=s-1;let c=0,d=0;o.fill(0);const l=(t,r,n,a,h,p)=>{const u=t+n>>1,g=r+a>>1;Math.abs(t-h)+Math.abs(r-p)>1&&i[g*s+u]>e?(l(h,p,t,r,u,g),l(n,a,h,p,u,g)):(o[r*s+t]=o[r*s+t]||++c,o[a*s+n]=o[a*s+n]||++c,o[p*s+h]=o[p*s+h]||++c,d++)};l(0,0,a,a,a,0),l(a,a,0,0,0,a);const h=new Array(3*c),p=new Array(3*d);let u=0;const g=(r,c,d,l,m,f)=>{const _=r+d>>1,v=c+l>>1;if(Math.abs(r-m)+Math.abs(c-f)>1&&i[v*s+_]>e)g(m,f,r,c,_,v),g(d,l,m,f,_,v);else{const e=o[c*s+r]-1,i=o[l*s+d]-1,g=o[f*s+m]-1;h[3*e]=(r-.5*a)*t,h[3*e+1]=n[c*s+r],h[3*e+2]=(c-.5*a)*t,h[3*i]=(d-.5*a)*t,h[3*i+1]=n[l*s+d],h[3*i+2]=(l-.5*a)*t,h[3*g]=(m-.5*a)*t,h[3*g+1]=n[f*s+m],h[3*g+2]=(f-.5*a)*t,p[u++]=e,p[u++]=i,p[u++]=g}};return g(0,0,a,a,a,0),g(a,a,0,0,0,a),{vertices:h,triangles:p}}}class St{constructor(e,t,r){this.x=e,this.y=t,this.z=r}dot2(e,t){return this.x*e+this.y*t}dot3(e,t,r){return this.dot2(e,t)+this.z*r}}const Dt=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],Et=[new St(1,1,0),new St(-1,1,0),new St(1,-1,0),new St(-1,-1,0),new St(1,0,1),new St(-1,0,1),new St(1,0,-1),new St(-1,0,-1),new St(0,1,1),new St(0,-1,1),new St(0,1,-1),new St(0,-1,-1)];function Tt(e){return e*e*e*(e*(6*e-15)+10)}function Rt(e,t,r){return e+r*(t-e)}class At{constructor(e=Math.random()){this.p=new Array(512),this.g=new Array(512),e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(let t=0;t<256;t++){const r=1&t?Dt[t]^255&e:Dt[t]^e>>8&256;this.p[t]=this.p[t+256]=r,this.g[t]=this.g[t+256]=Et[r%12]}}noise2d(e,t){const{g:r,p:n}=this;let i=Math.floor(e),s=Math.floor(t);e-=i,t-=s,i&=255,s&=255;const o=r[i+n[s]].dot2(e,t),a=r[i+n[s+1]].dot2(e,t-1),c=r[i+1+n[s]].dot2(e-1,t),d=r[i+1+n[s+1]].dot2(e-1,t-1),l=Tt(e);return Rt(Rt(o,c,l),Rt(a,d,l),Tt(t))}noise3d(e,t,r){const{g:n,p:i}=this;let s=Math.floor(e),o=Math.floor(t),a=Math.floor(r);e-=s,t-=o,r-=a,s&=255,o&=255,a&=255;const c=n[s+i[o+i[a]]].dot3(e,t,r),d=n[s+i[o+i[a+1]]].dot3(e,t,r-1),l=n[s+i[o+1+i[a]]].dot3(e,t-1,r),h=n[s+i[o+1+i[a+1]]].dot3(e,t-1,r-1),p=n[s+1+i[o+i[a]]].dot3(e-1,t,r),u=n[s+1+i[o+i[a+1]]].dot3(e-1,t,r-1),g=n[s+1+i[o+1+i[a]]].dot3(e-1,t-1,r),m=n[s+1+i[o+1+i[a+1]]].dot3(e-1,t-1,r-1),f=Tt(e),_=Tt(t),v=Tt(r);return Rt(Rt(Rt(c,p,f),Rt(d,u,f),v),Rt(Rt(l,g,f),Rt(h,m,f),v),_)}}function Ct(e,t,r,n){switch(15&e){case 0:return t+r;case 1:return-t+r;case 2:return t-r;case 3:return-t-r;case 4:return t+n;case 5:return-t+n;case 6:return t-n;case 7:return-t-n;case 8:return r+n;case 9:case 13:return-r+n;case 10:return r-n;case 11:case 15:return-r-n;case 12:return r+t;case 14:return r-t;default:return 0}}class jt{constructor(){this.p=new Array(512);for(let e=0;e<256;e++)this.p[e]=this.p[e+256]=Dt[e]}noise(e,t,r){const n=Math.floor(e),i=Math.floor(t),s=Math.floor(r),o=255&n,a=255&i,c=255&s,d=(e-=n)-1,l=(t-=i)-1,h=(r-=s)-1,p=Tt(e),u=Tt(t),g=Tt(r),m=this.p[o]+a,f=this.p[m]+c,_=this.p[m+1]+c,v=this.p[o+1]+a,x=this.p[v]+c,y=this.p[v+1]+c;return Rt(g,Rt(u,Rt(p,Ct(this.p[f],e,t,r),Ct(this.p[x],d,t,r)),Rt(p,Ct(this.p[_],e,l,r),Ct(this.p[y],d,l,r))),Rt(u,Rt(p,Ct(this.p[f+1],e,t,h),Ct(this.p[x+1],d,t,h)),Rt(p,Ct(this.p[_+1],e,l,h),Ct(this.p[y+1],d,l,h))))}}const It=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]],Ot=[[-1,-1,-1],[0,-1,-1],[1,-1,-1],[-1,-1,0],[0,-1,0],[1,-1,0],[-1,-1,1],[0,-1,1],[1,-1,1],[-1,0,-1],[0,0,-1],[1,0,-1],[-1,0,0],[0,0,0],[1,0,0],[-1,0,1],[0,0,1],[1,0,1],[-1,1,-1],[0,1,-1],[1,1,-1],[-1,1,0],[0,1,0],[1,1,0],[-1,1,1],[0,1,1],[1,1,1]];class Ut{constructor(e=128,t=32){this._size=Math.floor(e),this._cellSize=Math.floor(t),this._cellCount=Math.floor(e/t),this._featurePoints2D=this._create2DFeaturePoints(),this._featurePoints3D=this._create3DFeaturePoints()}noise2d(e,t){const{_size:r,_cellSize:n,_cellCount:i,_featurePoints2D:s}=this,o=new y(e%r,t%r),a=Math.floor(o.x/n),c=Math.floor(o.y/n),d=new y;let l=1/0;for(let e=0;e<9;e++){const t=It[e],r=a+t[0],h=c+t[1],p=(r+i)%i,u=(h+i)%i;d.fromArray(s[p][u]),d.x+=r*n,d.y+=h*n,l=Math.min(l,o.distanceTo(d))}return l/Math.sqrt(2*n*n)}noise3d(e,t,r){const{_size:n,_cellSize:i,_cellCount:s,_featurePoints3D:o}=this,a=new A(e%n,t%n,r%n),c=Math.floor(a.x/i),d=Math.floor(a.y/i),l=Math.floor(a.z/i),h=new A;let p=1/0;for(let e=0;e<27;e++){const t=Ot[e],r=c+t[0],n=d+t[1],u=l+t[2],g=(r+s)%s,m=(n+s)%s,f=(u+s)%s;h.fromArray(o[g][m][f]),h.x+=r*i,h.y+=n*i,h.z+=u*i,p=Math.min(p,a.distanceTo(h))}return p/Math.sqrt(3*i*i)}_create2DFeaturePoints(){const{_cellCount:e,_cellSize:t}=this,r=[];for(let n=0;n<e;n++){r[n]=[];for(let i=0;i<e;i++)r[n].push([Math.random()*t,Math.random()*t])}return r}_create3DFeaturePoints(){const{_cellCount:e,_cellSize:t}=this,r=[];for(let n=0;n<e;n++){r[n]=[];for(let i=0;i<e;i++){r[n][i]=[];for(let s=0;s<e;s++)r[n][i].push([Math.random()*t,Math.random()*t,Math.random()*t])}}return r}}class kt{get texture(){return Me(this._renderTarget)?this._renderTarget.texture:null}constructor(e){this._updateCount=0;const{scene:t,width:r,height:n,samples:i=4,stencilBuffer:s=!1,depthBuffer:o=!1,generateMipmaps:a=!1,frames:c=1/0}=e;this._scene=t,this._frames=c;const{gl:d}=this._scene.engine;this._renderTarget=Pe({width:r*d.getPixelRatio(),height:n*d.getPixelRatio(),renderTargetOptions:{type:Q,minFilter:$,magFilter:$,samples:i,stencilBuffer:s,depthBuffer:o,generateMipmaps:a}}),this._scene.on(me.BEFORE_SCENE_RENDER,this._renderToTexture,{target:this})}dispose(){this._scene.off(me.BEFORE_SCENE_RENDER,this._renderToTexture),this._renderTarget.dispose(),this._renderTarget=null,this._scene=null}_renderToTexture(e){const{_scene:t,_frames:r,_updateCount:n,_renderTarget:i}=this;if(r===1/0||n<r){const{sceneRenderer:r,options:n}=e,{timeSinceLastFrame:s,totalTime:o,timeStamp:a,frame:c}=n;r.renderScene(t,{timeSinceLastFrame:s,totalTime:o,timeStamp:a,frame:c,renderTarget:i}),this._updateCount++}}}class Lt{get texture(){return this._cubeCamera.renderTarget.texture}constructor(e,t){this._updateCount=0;const{resolution:r=256,stencilBuffer:n=!1,depthBuffer:i=!1,generateMipmaps:s=!1,frames:o=1/0,near:a=.1,far:c=500,position:d,rotation:l,quaternion:h}=t;this._scene=e,this._frames=o,this._cubeCamera=new Z(a,c,new X(r,{type:Q,stencilBuffer:n,depthBuffer:i,generateMipmaps:s})),Me(d)&&this._cubeCamera.position.copy(d),Me(l)&&this._cubeCamera.rotation.copy(l),Me(h)&&this._cubeCamera.quaternion.copy(h),this._scene.engine.on(me.BEFORE_SCENES_RENDER,this._renderToCubeTexture,{target:this})}dispose(){this._scene.engine.off(me.BEFORE_SCENES_RENDER,this._renderToCubeTexture),this._cubeCamera.renderTarget.dispose(),this._cubeCamera=null,this._scene=null}_renderToCubeTexture(e){const{_scene:t,_frames:r,_updateCount:n,_cubeCamera:i}=this;if(r===1/0||n<r){const{engine:e,rootEntity:r}=t,{gl:n}=e,{object3D:s}=r.transform;i.update(n,s),this._updateCount++}}}class Bt{constructor(t){this.renderToScreen=!1;const{resolution:r,width:n=500,height:i=500,minDepthThreshold:s=0,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:c=.25}=t;this.renderTargetA=new e(r,r,{minFilter:$,magFilter:$,stencilBuffer:!1,depthBuffer:!1,type:Q}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new _t,this.convolutionMaterial.setTexelSize(1/n,1/i),this.convolutionMaterial.setResolution(new y(n,i)),this.convolutionMaterial.uniforms.minDepthThreshold.value=s,this.convolutionMaterial.uniforms.maxDepthThreshold.value=o,this.convolutionMaterial.uniforms.depthScale.value=a,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=c,this.convolutionMaterial.defines.USE_DEPTH=a>0,this.scene=new O,this.camera=new J,this.screen=new ee(be(),this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,r){const{renderTargetA:n,renderTargetB:i,convolutionMaterial:s,renderToScreen:o,scene:a,camera:c}=this,{kernel:d,uniforms:l}=s;l.depthBuffer.value=t.depthTexture;let h=0,p=0,u=t,g=null;for(h=0,p=d.length-1;h<p;++h)g=0==(1&h)?n:i,l.kernel.value=d[h],l.inputBuffer.value=u.texture,e.setRenderTarget(g),e.autoClear||e.clear(),e.render(a,c),u=g;l.kernel.value=d[h],l.inputBuffer.value=u.texture,e.setRenderTarget(o?null:r),e.autoClear||e.clear(),e.render(a,c)}dispose(){this.renderTargetA.dispose(),this.renderTargetB.dispose(),this.convolutionMaterial.dispose(),this.screen.geometry.dispose()}}class Ft{}Ft.reflectWorldPosition=new A,Ft.reflectWorldDirection=new A,Ft.cameraWorldPosition=new A,Ft.cameraWorldLookAt=new A,Ft.view=new A,Ft.target=new A,Ft.q=new x,Ft.clipPlane=new x,Ft.rotationMatrix=new w,Ft.clearColor=new S;class Nt extends te{get texture(){return this._renderTargetA.texture}get blurTexture(){return this._renderTargetB.texture}get depthTexture(){return this._renderTargetA.depthTexture}get textureMatrix(){return this._textureMatrix}constructor(e={}){super(),this._clipBias=0,this._reflectOffset=0,this._reflectPlane=new re,this._reflectDirection=new A,this._textureMatrix=new w,this._virtualCamera=new I;const{resolution:t=512,samples:r=4,blur:n=new y(0,0),minDepthThreshold:i=.9,maxDepthThreshold:s=1,depthScale:o=0,depthToBlurRatioBias:a=.25,reflectDirection:c=new A(0,0,1),reflectOffset:d=0,clipBias:l=0,clearColor:h,clearAlpha:p}=e,u={type:Q,minFilter:$,magFilter:$,samples:r};this._renderTargetA=Pe({width:t,height:t,createDepthTexture:!0,renderTargetOptions:u}),this._renderTargetB=Pe({width:t,height:t,renderTargetOptions:u});let g=0,m=0;n instanceof y?(g=n.x,m=n.y):g=m=n,g+m>0&&(this._blurPass=new Bt({resolution:t,width:g,height:m,minDepthThreshold:i,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a})),this._reflectDirection.copy(c),this._reflectOffset=d,this._clipBias=l,Me(h)&&(this._clearColor=new S(h)),this._clearAlpha=p}render(e,t,r){if(!this._updateVirtualCamera(r))return;const{_virtualCamera:n,_renderTargetA:i,_renderTargetB:s,_blurPass:o,_clearColor:a,_clearAlpha:c}=this,d=e.getRenderTarget(),l=e.xr.enabled,h=e.shadowMap.autoUpdate,p=e.outputColorSpace,u=e.toneMapping,g=e.getClearColor(Ft.clearColor),m=e.getClearAlpha();e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.outputColorSpace=ne,e.toneMapping=D,Me(a)&&e.setClearColor(a),Me(c)&&e.setClearAlpha(c),e.setRenderTarget(i),e.state.buffers.depth.setMask(!0),e.autoClear||e.clear(),e.render(t,n),Me(o)&&o.render(e,i,s),e.xr.enabled=l,e.shadowMap.autoUpdate=h,e.outputColorSpace=p,e.toneMapping=u,Me(a)&&e.setClearColor(g),Me(c)&&e.setClearAlpha(m),e.setRenderTarget(d);const f=r.viewport;Me(f)&&e.state.viewport(f)}dispose(){this._renderTargetA.dispose(),this._renderTargetB.dispose(),Me(this._blurPass)&&(this._blurPass.dispose(),this._blurPass=null),this._renderTargetA=null,this._renderTargetB=null,this._virtualCamera=null}_updateVirtualCamera(e){const{_clipBias:t,_reflectOffset:r,_reflectPlane:n,_reflectDirection:i,_textureMatrix:s,_virtualCamera:o,matrixWorld:a}=this,c=Ft.rotationMatrix.extractRotation(a),d=Ft.reflectWorldPosition.setFromMatrixPosition(a),l=Ft.reflectWorldDirection.copy(i),h=Ft.cameraWorldPosition.setFromMatrixPosition(e.matrixWorld);l.applyMatrix4(c),d.addScaledVector(l,r);const p=Ft.view.subVectors(d,h);if(p.dot(l)>0)return!1;p.reflect(l).negate(),p.add(d),c.extractRotation(e.matrixWorld);const u=Ft.cameraWorldLookAt.set(0,0,-1);u.applyMatrix4(c),u.add(h);const g=Ft.target.subVectors(d,u);g.reflect(l).negate(),g.add(d),o.position.copy(p),o.up.set(0,1,0),o.up.applyMatrix4(c),o.up.reflect(l),o.lookAt(g),o.far=e.far,o.updateMatrixWorld(),o.projectionMatrix.copy(e.projectionMatrix),s.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),s.multiply(o.projectionMatrix),s.multiply(o.matrixWorldInverse),s.multiply(this.matrixWorld),n.setFromNormalAndCoplanarPoint(l,d),n.applyMatrix4(o.matrixWorldInverse);const m=Ft.clipPlane.set(n.normal.x,n.normal.y,n.normal.z,n.constant),f=Ft.q,_=o.projectionMatrix;return f.x=(Math.sign(m.x)+_.elements[8])/_.elements[0],f.y=(Math.sign(m.y)+_.elements[9])/_.elements[5],f.z=-1,f.w=(1+_.elements[10])/_.elements[14],m.multiplyScalar(2/m.dot(f)),_.elements[2]=m.x,_.elements[6]=m.y,_.elements[10]=m.z+1-t,_.elements[14]=m.w,!0}}function Wt(e,t,r,n){const i=class extends g{constructor(i={}){const s=Object.entries(e);super({uniforms:s.reduce(((e,[t,r])=>{const n=ie.clone({[t]:{value:r}});return Object.assign(Object.assign({},e),n)}),{}),vertexShader:t,fragmentShader:r}),this.key="",s.forEach((([e])=>Object.defineProperty(this,e,{get:()=>this.uniforms[e].value,set:t=>this.uniforms[e].value=t}))),Object.assign(this,i),n&&n(this)}};return i.key=R.generateUUID(),i}export{st as AmbientLight,rt as Animator,nt as AnimatorController,pt as BoolUpdateFlag,Ze as Camera,Ne as Component,Fe as ComponentsManager,ge as ControllerState,_t as ConvolutionMaterial,it as DefaultAnimatorController,we as DependentMode,ot as DirectionalLight,Be as DisorderedArray,Le as Engine,Ve as Entity,Ee as EventDispatcher,me as EventType,Pt as GLTFParser,je as GLTFResource,at as HemisphereLight,jt as ImprovedNoise,fe as LogLevel,bt as Martini,gt as MeshRenderer,mt as ModelRenderer,_e as MouseButton,Xe as OrthographicCamera,At as PerlinNoise,Je as PerspectiveCamera,zt as PlaneGeometry,ct as PointLight,ve as Priority,vt as PriorityQueue,ze as QueryMask,Ke as Queue,lt as RectAreaLight,Nt as Reflector,Lt as RenderCubeTexture,xe as RenderOrder,kt as RenderTexture,ut as Renderer,Ie as ResourceManager,et as Scene,tt as SceneRenderer,ft as Script,Ue as ShaderChunks,dt as SpotLight,xt as Stack,Mt as TerrainBuilder,Ce as TextureResource,ye as Touch,He as Transform,ke as UniformsLib,ht as UpdateFlag,Ge as UpdateFlagManager,Ut as WorleyNoise,Qe as attributeChanged,Pe as createFBO,be as createScreenQuadGeometry,Se as defaultValue,Wt as defineShaderMaterial,Me as defined,qe as dependentComponents,wt as easing,De as removeFromArray};
