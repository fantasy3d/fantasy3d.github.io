/*!
 * @fantasy3d/addons latest@2024-2-25 18:37
 * Copyright Â© yisky 2024-2024 all right reserved
 */
import{CameraHelper as t,MathUtils as e,BufferGeometry as n,Float32BufferAttribute as r,LineBasicMaterial as i,LineSegments as o,SphereGeometry as a,MeshBasicMaterial as s,Mesh as l,Plane as c,Vector3 as u,Ray as h,Spherical as d,Vector2 as f,Quaternion as p,Color as v,Group as g,OrthographicCamera as m,WebGLRenderTarget as y,PlaneGeometry as _,MeshDepthMaterial as x,ShaderMaterial as b,RingGeometry as w,HalfFloatType as S,FloatType as T,NearestFilter as U,MeshLambertMaterial as M,DirectionalLight as D,MeshStandardMaterial as A,UniformsUtils as C,RGBADepthPacking as P,MeshDistanceMaterial as B,ShaderChunk as k,FrontSide as F,Texture as I,LinearFilter as E,InstancedBufferGeometry as R,Sphere as O,Box3 as G,BackSide as z,DoubleSide as L,InstancedBufferAttribute as N,Vector4 as j,Matrix3 as W,Matrix4 as H,RepeatWrapping as V,BufferAttribute as q,Line3 as X,Triangle as Y,UnsignedIntType as $,DataTexture as Z,IntType as K,UnsignedByteType as Q,UnsignedShortType as J,ByteType as tt,ShortType as et,RGBAFormat as nt,RGBAIntegerFormat as rt,RGFormat as it,RedFormat as ot,RGIntegerFormat as at,RedIntegerFormat as st}from"three";import{dependentComponents as lt,OrthographicCamera as ct,PerspectiveCamera as ut,DependentMode as ht,Renderer as dt,defined as ft,EventType as pt,DirectionalLight as vt,PointLight as gt,RectAreaLight as mt,SpotLight as yt,Script as _t,MouseButton as xt,Touch as bt,ControllerState as wt,defaultValue as St,BoolUpdateFlag as Tt,defineShaderMaterial as Ut,Reflector as Mt,PlaneGeometry as Dt,attributeChanged as At,createScreenQuadGeometry as Ct}from"@fantasy3d/core";import{HorizontalBlurShader as Pt}from"three/examples/jsm/shaders/HorizontalBlurShader.js";import{VerticalBlurShader as Bt}from"three/examples/jsm/shaders/VerticalBlurShader.js";lt([ct,ut],ht.OR);class kt extends dt{constructor(t,e={}){super(t,e),this._cameraChangeHandler=this._notifyCameraChanged.bind(this),this._initialize()}raycast(t){return null}_initialize(){const{_cameraChangeHandler:e,entity:n,scene:r}=this;let i=n.getComponent(ut);ft(i)||(i=n.getComponent(ct)),i.on(pt.CAMERA_CHANGED,e);const o=this._object3D=new t(n.transform.object3D);r.rootEntity.transform.object3D.add(o)}_notifyCameraChanged(){this._updateWorldMatrix()}_onEnable(){const{_object3D:t,scene:e}=this,{rootEntity:n}=e;if(ft(t)){const{transform:e}=n,{parent:r}=t;ft(r)&&r===e.object3D||e.object3D.add(t)}this._updateWorldMatrix()}_onDisable(){const{_object3D:t}=this;ft(t)&&t.removeFromParent()}_updateWorldMatrix(){this._object3D.update(),this._object3D.updateMatrixWorld(!0)}_destroy(){const{_cameraChangeHandler:t,entity:e,_object3D:n}=this;let r=e.getComponent(ut);ft(r)||(r=e.getComponent(ct)),r.off(pt.CAMERA_CHANGED,t),n.dispose()}}function Ft(t,e,n,r){var i,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(o<3?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a}"function"==typeof SuppressedError&&SuppressedError;let It=class extends dt{constructor(t,e={}){super(t,e),this._attributeChangeHandler=this._notifyLightAttributeChanged.bind(this),this._initialize()}raycast(t){return null}_initialize(){const{_attributeChangeHandler:t,entity:a}=this,s=a.getComponent(vt);s.on(pt.ATTRIBUTE_CHANGED,t);const l=[];for(let t=0;t<360;t+=10){const n=e.degToRad(t),r=e.degToRad(t+10),i=4*Math.sin(n),o=4*Math.cos(n),a=4*Math.sin(r),s=4*Math.cos(r);l.push(i,o,0),l.push(a,s,0)}l.push(0,0,0,0,0,1);const c=new n;c.setAttribute("position",new r(l,3));const{light:u}=s,h=new i({color:u.color,fog:!1,toneMapped:!1}),d=this._object3D=new o(c,h);d.renderOrder=this._renderOrder,d.position.copy(u.position),d.scale.set(1,1,u.position.distanceTo(u.target.position)),d.lookAt(u.target.position),a.transform.object3D.add(d)}_notifyLightAttributeChanged(t){const{entity:e,_object3D:n}=this;if(ft(n)){const{light:r}=e.getComponent(vt),{name:i,value:o}=t;switch(i){case"color":n.material.color.set(o);break;case"position":case"target":n.position.copy(r.position),n.scale.set(1,1,r.position.distanceTo(r.target.position)),n.lookAt(r.target.position),n.updateMatrixWorld(!0)}}}_destroy(){const{_attributeChangeHandler:t,entity:e,_object3D:n}=this;e.getComponent(vt).off(pt.ATTRIBUTE_CHANGED,t),n.geometry.dispose(),n.material.dispose()}};It=Ft([lt(vt)],It);let Et=class extends dt{constructor(t,e={}){super(t,e),this._attributeChangeHandler=this._notifyLightAttributeChanged.bind(this),this._initialize()}raycast(t){return null}_initialize(){const{_attributeChangeHandler:t,entity:e}=this,n=e.getComponent(gt);n.on(pt.ATTRIBUTE_CHANGED,t);const{light:r}=n,i=new a(1,4,2),o=new s({color:r.color,wireframe:!0,fog:!1,toneMapped:!1}),c=this._object3D=new l(i,o);c.renderOrder=this._renderOrder,c.position.copy(r.position),e.transform.object3D.add(c)}_notifyLightAttributeChanged(t){const{_object3D:e}=this;if(ft(e)){const{name:n,value:r}=t;switch(n){case"color":e.material.color.set(r);break;case"position":e.position.copy(r),e.updateMatrixWorld(!0)}}}_destroy(){const{_attributeChangeHandler:t,entity:e,_object3D:n}=this;e.getComponent(gt).off(pt.ATTRIBUTE_CHANGED,t),n.geometry.dispose(),n.material.dispose()}};Et=Ft([lt(gt)],Et);let Rt=class extends dt{constructor(t,e={}){super(t,e),this._attributeChangeHandler=this._notifyLightAttributeChanged.bind(this),this._initialize()}raycast(t){return null}_initialize(){const{_attributeChangeHandler:t,entity:e}=this,a=e.getComponent(mt);a.on(pt.ATTRIBUTE_CHANGED,t);const s=new n;s.setAttribute("position",new r([-.5,.5,0,.5,.5,0,.5,.5,0,.5,-.5,0,.5,-.5,0,-.5,-.5,0,-.5,-.5,0,-.5,.5,0,0,0,0,0,0,-1],3));const{light:l}=a,c=new i({color:l.color,fog:!1,toneMapped:!1}),u=this._object3D=new o(s,c);u.renderOrder=this._renderOrder,u.position.copy(l.position),u.quaternion.copy(l.quaternion),u.scale.set(l.width,l.height,Math.min(5,Math.min(l.width,l.height))),e.transform.object3D.add(u)}_notifyLightAttributeChanged(t){const{entity:e,_object3D:n}=this;if(ft(n)){const{light:r}=e.getComponent(mt),{name:i,value:o}=t;switch(i){case"color":n.material.color.set(o);break;case"width":case"height":n.scale.set(r.width,r.height,Math.min(5,Math.min(r.width,r.height))),n.updateMatrixWorld(!0);break;case"position":n.position.copy(o),n.updateMatrixWorld(!0);break;case"rotation":n.rotation.copy(o),n.updateMatrixWorld(!0);break;case"quaternion":n.quaternion.copy(o),n.updateMatrixWorld(!0)}}}_destroy(){const{_attributeChangeHandler:t,entity:e,_object3D:n}=this;e.getComponent(mt).off(pt.ATTRIBUTE_CHANGED,t),n.geometry.dispose(),n.material.dispose()}};Rt=Ft([lt(mt)],Rt);let Ot=class extends dt{constructor(t,e={}){super(t,e),this._attributeChangeHandler=this._notifyLightAttributeChanged.bind(this),this._initialize()}raycast(t){return null}_initialize(){const{_attributeChangeHandler:t,entity:e}=this,a=e.getComponent(yt);a.on(pt.ATTRIBUTE_CHANGED,t);const s=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let t=0,e=1,n=32;t<n;t++,e++){const r=t/n*Math.PI*2,i=e/n*Math.PI*2;s.push(Math.cos(r),Math.sin(r),1,Math.cos(i),Math.sin(i),1)}const l=new n;l.setAttribute("position",new r(s,3));const{light:c}=a,u=new i({color:c.color,fog:!1,toneMapped:!1}),h=c.distance?c.distance:1e3,d=h*Math.tan(c.angle),f=this._object3D=new o(l,u);f.renderOrder=this._renderOrder,f.position.copy(c.position),f.scale.set(d,d,h),f.lookAt(c.target.position),e.transform.object3D.add(f)}_notifyLightAttributeChanged(t){const{entity:e,_object3D:n}=this;if(ft(n)){const{light:r}=e.getComponent(yt),{name:i,value:o}=t;switch(i){case"color":n.material.color.set(o);break;case"angle":case"distance":case"position":case"target":const t=r.distance?r.distance:1e3,e=t*Math.tan(r.angle);n.position.copy(r.position),n.scale.set(e,e,t),n.lookAt(r.target.position),n.updateMatrixWorld(!0)}}}_destroy(){const{_attributeChangeHandler:t,entity:e,_object3D:n}=this;e.getComponent(yt).off(pt.ATTRIBUTE_CHANGED,t),n.geometry.dispose(),n.material.dispose()}};var Gt;Ot=Ft([lt(yt)],Ot);const zt=1e-6;let Lt=Gt=class extends _t{get target(){return this._target}constructor(t,e={}){super(t),this.rotateButton=xt.LEFT,this.panButton=xt.RIGHT,this.touchOne=bt.ROTATE,this.touchTwo=bt.ZOOM_PAN,this.minDistance=0,this.maxDistance=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.zoomSpeed=1,this.zoomThreshold=2,this.rotateSpeed=1,this.panSpeed=1,this.screenSpacePanning=!1,this.damping=!1,this.dampingFactor=.05,this._target=new u,this._spherical=new d,this._sphericalDelta=new d,this._zoomScale=1,this._rotateStart=new f,this._rotateEnd=new f,this._rotateDelta=new f,this._panStart=new f,this._panEnd=new f,this._panDelta=new f,this._panOffset=new u,this._zoomStart=new f,this._zoomEnd=new f,this._zoomDelta=new f,this._offset=new u,this._quat=new p,this._quatInverse=new p,this._lastPosition=new u,this._lastQuaternion=new p,this._reset=!0,this._pointers=[],this._pointerPositions={},this._state=wt.NONE,this.rotateButton=St(e.rotateButton,xt.LEFT),this.panButton=St(e.panButton,xt.RIGHT),this.touchOne=St(e.touchOne,bt.ROTATE),this.touchTwo=St(e.touchTwo,bt.ZOOM_PAN),this.minDistance=St(e.minDistance,0),this.maxDistance=St(e.maxDistance,1/0),this.minPolarAngle=St(e.minPolarAngle,0),this.maxPolarAngle=St(e.maxPolarAngle,Math.PI),this.minAzimuthAngle=St(e.minAzimuthAngle,-1/0),this.maxAzimuthAngle=St(e.maxAzimuthAngle,1/0),this.zoomSpeed=St(e.zoomSpeed,1),this.zoomThreshold=St(e.zoomThreshold,2),this.rotateSpeed=St(e.rotateSpeed,1),this.panSpeed=St(e.panSpeed,1),this.screenSpacePanning=St(e.screenSpacePanning,!1),this.damping=St(e.damping,!1),this.dampingFactor=St(e.dampingFactor,.05);const n=this.entity.getComponent(ut);this._cameraUpdateFlag=n.updateFlagManager.createFlag(Tt)}_onEnableInScene(){const{transform:t}=this.entity;this._offset.set(0,0,0),this._quat.setFromUnitVectors(t.object3D.up,Gt._tempUp),this._quatInverse.copy(this._quat).invert(),this._lastPosition.set(0,0,0),this._lastQuaternion.set(0,0,0,1),this._resetTarget(),this.scene.on("contextmenu",this._onContextmenu,{target:this}),this.scene.on("pointerdown",this._onPointerDown,{target:this}),this.scene.on("pointerup",this._onPointerUp,{target:this}),this.scene.on("pointermove",this._onPointerMove,{target:this}),this.scene.on("pointercancel",this._onPointerCancel,{target:this}),this.scene.on("wheel",this._onWheel,{target:this})}_onDisableInScene(){this.scene.off("contextmenu",this._onContextmenu),this.scene.off("pointerdown",this._onPointerDown),this.scene.off("pointerup",this._onPointerUp),this.scene.off("pointermove",this._onPointerMove),this.scene.off("pointercancel",this._onPointerCancel),this.scene.off("wheel",this._onWheel),this._pointers.length=0,this._pointerPositions={}}onLateUpdate(t,e){this.enabled&&this.damping&&(this._resetTarget(),this._updateCamera())}onDestroy(){this._cameraUpdateFlag.destroy(),this._cameraUpdateFlag=null}_onContextmenu(t){t.preventDefault()}_onPointerDown(t){const{clientX:e,clientY:n}=t;this.enabled&&this._inViewport(e,n)&&(this._addPointer(t),this._resetTarget(),"touch"===t.pointerType?this._onTouchStart(t):this._onMouseDown(t))}_onPointerUp(t){const{clientX:e,clientY:n}=t;this.enabled&&this._inViewport(e,n)?(this._removePointer(t),this._state=wt.NONE):this._state=wt.NONE}_onPointerMove(t){const{clientX:e,clientY:n}=t;this.enabled&&this._inViewport(e,n)&&("touch"===t.pointerType?this._onTouchMove(t):this._onMouseMove(t))}_onPointerCancel(t){this._removePointer(t)}_onWheel(t){const{clientX:e,clientY:n}=t;this.enabled&&this._inViewport(e,n)&&(t.stopPropagation(),this._resetTarget(),t.deltaY<0?this._zoomOut(this._getZoomScale()):t.deltaY>0&&this._zoomIn(this._getZoomScale()),this._updateCamera())}_onMouseDown(t){const{button:e,clientX:n,clientY:r}=t;e===this.rotateButton?(this._rotateStart.set(n,r),this._state=wt.ROTATE):e===this.panButton&&(this._panStart.set(n,r),this._state=wt.PAN)}_onMouseMove(t){switch(this._state){case wt.ROTATE:this._mouseMoveRotate(t);break;case wt.PAN:this._mouseMovePan(t)}}_onTouchStart(t){switch(this._trackPointer(t),this._pointers.length){case 1:switch(this.touchOne){case bt.ROTATE:this._touchStartRotate(),this._state=wt.TOUCH_ROTATE;break;case bt.PAN:this._touchStartPan(),this._state=wt.TOUCH_PAN;break;default:this._state=wt.NONE}break;case 2:switch(this.touchTwo){case bt.ZOOM_PAN:this._touchStartZoomPan(),this._state=wt.TOUCH_ZOOM_PAN;break;case bt.ZOOM_ROTATE:this._touchStartZoomRotate(),this._state=wt.TOUCH_ZOOM_ROTATE;break;default:this._state=wt.NONE}break;default:this._state=wt.NONE}}_onTouchMove(t){switch(t.preventDefault(),this._trackPointer(t),this._state){case wt.TOUCH_PAN:this._touchMovePan(t),this._updateCamera();break;case wt.TOUCH_ROTATE:this._touchMoveRotate(t),this._updateCamera();break;case wt.TOUCH_ZOOM_PAN:this._touchMoveZoomPan(t),this._updateCamera();break;case wt.TOUCH_ZOOM_ROTATE:this._touchMoveZoomRotate(t),this._updateCamera()}}_mouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this._updateCamera()}_mouseMoveRotate(t){const{engine:e}=this.entity,{viewport:n}=e;this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed),this._rotateLeft(2*Math.PI*this._rotateDelta.x/n.clientHeight),this._rotateUp(2*Math.PI*this._rotateDelta.y/n.clientHeight),this._rotateStart.copy(this._rotateEnd),this._updateCamera()}_touchStartPan(){const t=this._pointers;if(1===t.length)this._panStart.set(t[0].pageX,t[0].pageY);else{const e=.5*(t[0].pageX+t[1].pageX),n=.5*(t[0].pageY+t[1].pageY);this._panStart.set(e,n)}}_touchStartRotate(){const t=this._pointers;if(1===t.length)this._rotateStart.set(t[0].pageX,t[0].pageY);else{const e=.5*(t[0].pageX+t[1].pageX),n=.5*(t[0].pageY+t[1].pageY);this._rotateStart.set(e,n)}}_touchStartZoom(){const t=this._pointers,e=t[0].pageX-t[1].pageX,n=t[0].pageY-t[1].pageY,r=Math.sqrt(e*e+n*n);this._zoomStart.set(0,r)}_touchStartZoomPan(){this._touchStartZoom(),this._touchStartPan()}_touchStartZoomRotate(){this._touchStartZoom(),this._touchStartRotate()}_touchMovePan(t){if(1===this._pointers.length)this._panEnd.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),n=.5*(t.pageX+e.x),r=.5*(t.pageY+e.y);this._panEnd.set(n,r)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_touchMoveRotate(t){const{engine:e}=this.entity,{viewport:n}=e;if(1===this._pointers.length)this._rotateEnd.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),n=.5*(t.pageX+e.x),r=.5*(t.pageY+e.y);this._rotateEnd.set(n,r)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed),this._rotateLeft(2*Math.PI*this._rotateDelta.x/n.clientHeight),this._rotateUp(2*Math.PI*this._rotateDelta.y/n.clientHeight),this._rotateStart.copy(this._rotateEnd)}_touchMoveZoom(t){const e=this._getSecondPointerPosition(t),n=t.pageX-e.x,r=t.pageY-e.y,i=Math.sqrt(n*n+r*r);this._zoomEnd.set(0,i),Math.abs(this._zoomStart.y-this._zoomEnd.y)>this.zoomThreshold&&(this._zoomDelta.set(0,Math.pow(this._zoomStart.y/this._zoomEnd.y,this.zoomSpeed)),this._zoomOut(this._zoomDelta.y)),this._zoomStart.copy(this._zoomEnd)}_touchMoveZoomPan(t){this._touchMoveZoom(t),this._touchMovePan(t)}_touchMoveZoomRotate(t){this._touchMoveZoom(t),this._touchMoveRotate(t)}_pan(t,e){const{engine:n,transform:r}=this.entity,{viewport:i}=n,o=this.entity.getComponent(ut),a=r.object3D.position;Gt._tempPosition.copy(a).sub(this._target);let s=Gt._tempPosition.length();s*=Math.tan(o.fov/2*Math.PI/180),this._panLeft(2*t*s/i.clientHeight,r.object3D.matrix),this._panUp(2*e*s/i.clientHeight,r.object3D.matrix)}_panLeft(t,e){Gt._tempPosition.setFromMatrixColumn(e,0),Gt._tempPosition.multiplyScalar(-t),this._panOffset.add(Gt._tempPosition)}_panUp(t,e){this.screenSpacePanning?Gt._tempPosition.setFromMatrixColumn(e,1):(Gt._tempPosition.setFromMatrixColumn(e,0),Gt._tempPosition.crossVectors(this.entity.transform.object3D.up,Gt._tempPosition)),Gt._tempPosition.multiplyScalar(t),this._panOffset.add(Gt._tempPosition)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_zoomIn(t){this._zoomScale/=t}_zoomOut(t){this._zoomScale*=t}_getZoomScale(){return Math.pow(.95,this.zoomSpeed)}_updateCamera(){const t=this.entity.transform.object3D;this._offset.copy(t.position).sub(this._target),this._offset.applyQuaternion(this._quat),this._spherical.setFromVector3(this._offset),this.damping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi),this._spherical.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this._spherical.radius*=this._zoomScale,this._spherical.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this._spherical.radius)),this.damping?this._target.addScaledVector(this._panOffset,this.dampingFactor):this._target.add(this._panOffset),this._offset.setFromSpherical(this._spherical),this._offset.applyQuaternion(this._quatInverse),t.position.copy(this._target).add(this._offset),t.lookAt(this._target),this.damping?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this._zoomScale=1,(this._lastPosition.distanceToSquared(t.position)>zt||8*(1-this._lastQuaternion.dot(t.quaternion))>zt)&&(this._lastPosition.copy(t.position),this._lastQuaternion.copy(t.quaternion),this.entity.getComponent(ut).updateWorldMatrix())}_resetTarget(){if(this.enabled&&(this._cameraUpdateFlag.flag&&(this._offset.set(0,0,0),this._quat.setFromUnitVectors(this.entity.transform.object3D.up,Gt._tempUp),this._quatInverse.copy(this._quat).invert(),this._lastPosition.set(0,0,0),this._lastQuaternion.set(0,0,0,1),this._cameraUpdateFlag.flag=!1,this._reset=!0),this._reset)){const t=this.entity.transform.object3D,{_tempDirection:e,_tempPosition:n,_tempUp:r,_tempPlane:i,_tempRay:o}=Gt;t.getWorldDirection(e),n.set(0,t.position.y-Math.abs(t.position.y),0),i.setFromNormalAndCoplanarPoint(r,n),o.set(t.position,e).intersectPlane(i,this._target),this._reset=!1}}_addPointer(t){this._pointers.push(t)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let e=0,n=this._pointers.length;e<n;e++)if(this._pointers[e].pointerId===t.pointerId)return void this._pointers.splice(e,1)}_trackPointer(t){let e=this._pointerPositions[t.pointerId];ft(e)||(e=new f,this._pointerPositions[t.pointerId]=e),e.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const e=t.pointerId===this._pointers[0].pointerId?this._pointers[1]:this._pointers[0];return this._pointerPositions[e.pointerId]}_inViewport(t,e){const{pixelViewport:n}=this.entity.getComponent(ut),r=(t-n.x)/n.z,i=(e-n.y)/n.w;return!(r>1||r<0||i>1||i<0)}};Lt._tempPlane=new c,Lt._tempUp=new u(0,1,0),Lt._tempDirection=new u,Lt._tempPosition=new u,Lt._tempRay=new h,Lt=Gt=Ft([lt(ut)],Lt);class Nt extends dt{set opacity(t){this._shadowPlane.material.opacity=t}set color(t){this._shadowColor.set(t)}constructor(t,e={}){super(t,e),this._updateCount=0,this._shadowColor=new v,this._initialize(e)}update(t,e){const{blur:n,smooth:r,_frames:i,_updateCount:o,_depthMaterial:a,_shadowPlane:s,_shadowCamera:l,_shadowRenderTarget:c}=this;if(i===1/0||o<i){const{engine:t,rootEntity:e}=this.scene,{gl:i}=t,o=e.transform.object3D,{background:u,overrideMaterial:h}=o;s.visible=!1,o.background=null,o.overrideMaterial=a,i.setRenderTarget(c),i.render(o,l),this._blurShadows(n),r&&this._blurShadows(.4*n),i.setRenderTarget(null),o.background=u,o.overrideMaterial=h,s.visible=!0,this._updateCount++}}raycast(t){const{_object3D:e,_shadowPlane:n}=this;if(!ft(e)||!e.visible||!n.visible)return null;const r=[];return n.raycast(t,r),r.length>0?(r.sort(((t,e)=>t.distance-e.distance)),r[0]):null}_initialize(t){const{near:e=0,far:n=10,resolution:r=512,blur:i=1,smooth:o=!0,width:a=1,height:c=1,opacity:u=1,color:h="#000000",depthWrite:d=!1,frames:f=1/0}=t;this.blur=i,this.smooth=o,this._frames=f,this._object3D=new g,this._shadowCamera=new m(-a/2,a/2,c/2,-c/2,e,n),this._shadowCamera.rotation.x=Math.PI/2,this._shadowRenderTarget=new y(r,r,{generateMipmaps:!1}),this._shadowBlurRenderTarget=new y(r,r,{generateMipmaps:!1}),this._planeGeometry=new _(a,c).rotateX(Math.PI/2),this._shadowPlane=new l(this._planeGeometry,new s({map:this._shadowRenderTarget.texture,opacity:u,transparent:!0,depthWrite:d})),this._shadowPlane.renderOrder=this._renderOrder,this._shadowPlane.scale.y=-1,this._shadowBlurPlane=new l(this._planeGeometry),this._shadowBlurPlane.renderOrder=this._renderOrder,this._shadowBlurPlane.visible=!1,this._shadowColor.set(h),this._depthMaterial=new x({depthTest:!1,depthWrite:!1}),this._depthMaterial.onBeforeCompile=t=>{t.uniforms=Object.assign(Object.assign({},t.uniforms),{ucolor:{value:this._shadowColor}}),t.fragmentShader=t.fragmentShader.replace("void main() {","uniform vec3 ucolor;\n                 void main() {"),t.fragmentShader=t.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")},this._horizontalBlurMaterial=new b(Pt),this._horizontalBlurMaterial.depthTest=!0,this._verticalBlurMaterial=new b(Bt),this._verticalBlurMaterial.depthTest=!0,this._object3D.add(this._shadowPlane),this._object3D.add(this._shadowCamera),this.entity.transform.object3D.add(this._object3D)}_blurShadows(t){const{scene:e,_shadowCamera:n,_shadowBlurPlane:r,_shadowRenderTarget:i,_shadowBlurRenderTarget:o,_horizontalBlurMaterial:a,_verticalBlurMaterial:s}=this,{gl:l}=e.engine;r.visible=!0,r.material=a,a.uniforms.tDiffuse.value=i.texture,a.uniforms.h.value=1*t/256,l.setRenderTarget(o),l.render(r,n),r.material=s,s.uniforms.tDiffuse.value=o.texture,s.uniforms.v.value=1*t/256,l.setRenderTarget(i),l.render(r,n),r.visible=!1}_destroy(){const{_object3D:t,_planeGeometry:e,_shadowPlane:n,_shadowBlurPlane:r,_shadowRenderTarget:i,_shadowBlurRenderTarget:o,_depthMaterial:a,_horizontalBlurMaterial:s,_verticalBlurMaterial:l}=this;t.clear(),e.dispose(),n.material.dispose(),r.material.dispose(),i.dispose(),o.dispose(),a.dispose(),s.dispose(),l.dispose()}}class jt extends dt{constructor(t,e={}){super(t,e),this._initialize(e)}raycast(t){const{_object3D:e}=this;if(!ft(e)||!e.visible)return null;const n=[];return e.raycast(t,n),n.length>0?(n.sort(((t,e)=>t.distance-e.distance)),n[0]):null}_initialize(t){const{intensity:e=1,color:r="white",map:i=null,form:o="Rect",position:a,scale:c,rotation:u,quaternion:h,lookAt:d}=t,f=new s({color:new v(r).multiplyScalar(e),map:i,toneMapped:!1,fog:!1});let p;if(o instanceof n)p=o;else switch(o){case"Circle":p=new w(0,1,64);break;case"Ring":p=new w(.5,1,64);break;case"Rect":p=new _}const g=this._object3D=new l(p,f);g.renderOrder=this._renderOrder,ft(a)&&g.position.copy(a),ft(c)&&g.scale.copy(c),ft(u)&&g.rotation.copy(u),ft(h)&&g.quaternion.copy(h),ft(d)&&g.lookAt(d),this.entity.transform.object3D.add(g)}_destroy(){const{_object3D:t,entity:e}=this,{geometry:n,material:r}=t;n.dispose();const{resourceManager:i}=e.engine;i.disposeMaterial(r)}}class Wt extends b{constructor(){super({vertexShader:"void main() { }",fragmentShader:"void main() { gl_FragColor = vec4( 0.0, 0.0, 0.0, 0.0 ); discard; }"})}}const Ht=Ut({color:new v(0,0,0),blend:2,opacity:1,alphaTest:0,map:null,transparent:!0,depthWrite:!1,toneMapped:!1},"#define GLSLIFY 1\nvarying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*viewMatrix*modelMatrix*vec4(position,1.0);}","#define GLSLIFY 1\nvarying vec2 vUv;uniform sampler2D map;uniform vec3 color;uniform float opacity;uniform float alphaTest;uniform float blend;void main(){vec4 sampledDiffuseColor=texture2D(map,vUv);gl_FragColor=vec4(color*sampledDiffuseColor.r*blend,max(0.0,(1.0-(sampledDiffuseColor.r+sampledDiffuseColor.g+sampledDiffuseColor.b)/alphaTest))*opacity);\n#include <tonemapping_fragment>\n#include <colorspace_fragment>\n}");class Vt{constructor(t={}){this._lights=[];const{position:e=new u(0,1,0)}=t;this.lightOrigin=new g,this.lightOrigin.name="Light Origin",this.lightOrigin.position.copy(e),this.lightGroup=new g,this.lightGroup.name="Light Group",this._initialize(t)}update(){const{ambient:t,lightOrigin:n,_lights:r,radius:i}=this,{position:o}=n,a=o.length();for(let n=0,s=r.length;n<s;n++){const s=r[n];if(Math.random()>t)s.position.set(o.x+e.randFloatSpread(i),o.y+e.randFloatSpread(i),o.z+e.randFloatSpread(i));else{const t=Math.acos(2*Math.random()-1)-Math.PI/2,e=2*Math.PI*Math.random();s.position.set(Math.cos(t)*Math.cos(e)*a,Math.abs(Math.cos(t)*Math.sin(e)*a),Math.sin(t)*a)}s.updateMatrixWorld(!0)}}_initialize(t){const{amount:e=8,ambient:n=.5,radius:r=1,shadow:i={}}=t,{bias:o=0,autoUpdate:a=!0,needsUpdate:s=!1,mapSize:l=512,camera:c={near:.1,far:50}}=i,{near:u,far:h,frustumSize:d=512}=c,{lightGroup:f,_lights:p}=this;this.ambient=n,this.radius=r;for(let t=0;t<e;t++){const n=new D(16777215,Math.PI/e);n.name=`DirectionalLight_${t}`,n.castShadow=!0,n.shadow.bias=o,n.shadow.autoUpdate=a,n.shadow.needsUpdate=s,n.shadow.camera.near=u,n.shadow.camera.far=h,n.shadow.camera.left=-d/2,n.shadow.camera.right=d/2,n.shadow.camera.top=d/2,n.shadow.camera.bottom=-d/2,n.shadow.mapSize.set(l,l),p.push(n),f.add(n)}}}class qt extends dt{set frames(t){this._frames=t,this.reset()}set ambient(t){this._randomizedLight.ambient=t,this.reset()}set radius(t){this._randomizedLight.radius=t,this.reset()}set color(t){this._shadowReceiverMaterial.color.set(t)}set blend(t){this._shadowReceiverMaterial.blend=e.clamp(t,0,2)}set opacity(t){this._shadowReceiverMaterial.opacity=e.clamp(t,0,1)}set alphaTest(t){this._shadowReceiverMaterial.alphaTest=e.clamp(t,0,1)}constructor(t,e){super(t,e),this._buffer1Active=!1,this._discardMaterial=new Wt,this._clearColor=new v,this._lights=[],this._includedMeshes=[],this._excludedMeshes=[],this._updateCount=0,this._initialize(e)}update(t,n){const{_frames:r,_updateCount:i,_opacity:o,_alphaTest:a,_randomizedLight:s,_shadowReceiverMaterial:l}=this;i<r&&(l.opacity=e.clamp(e.mapLinear(i,2,r-1,0,o),0,1),l.alphaTest=e.clamp(e.mapLinear(i,2,r-1,0,a),0,1),this._updateLightMap(),s.update(),this._updateCount++)}raycast(t){const{_shadowReceiver:e}=this;if(!ft(e)||!e.visible)return null;const n=[];return e.raycast(t,n),n.length>0?(n.sort(((t,e)=>t.distance-e.distance)),n[0]):null}reset(){const{scene:t,_progressiveLightMap1:e,_progressiveLightMap2:n,_shadowReceiver:r,_shadowReceiverMaterial:i,_randomizedLight:o,_clearColor:a,_lights:s,_includedMeshes:l,_excludedMeshes:c}=this,{gl:u}=t.engine;u.getClearColor(a);const h=u.getClearAlpha(),d=u.getRenderTarget();u.setClearColor("black",1),u.setRenderTarget(e),u.clear(),u.setRenderTarget(n),u.clear(),u.setRenderTarget(d),u.setClearColor(a,h),i.opacity=0,i.alphaTest=0,s.length=l.length=c.length=0,t.native.traverse((t=>{!function(t){return t.isMesh}(t)||t===r?function(t){return t.isLight}(t)&&t.parent!==o.lightGroup&&s.push({object:t,intensity:t.intensity}):t.castShadow?l.push({object:t,material:t.material}):c.push({object:t,visible:t.visible})})),this._updateCount=0}_initialize(t){const{frames:e=40,blend:n=2,opacity:r=1,alphaTest:i=.98,color:o="black",resolution:a=1024,width:s=1,height:c=1,lights:u}=t,{scene:h}=this,{gl:d}=h.engine,f={type:/(Android|iPad|iPhone|iPod)/g.test(navigator.userAgent)?S:T,magFilter:U,minFilter:U,colorSpace:d.outputColorSpace};this._frames=e,this._opacity=r,this._alphaTest=i,this._progressiveLightMap1=new y(a,a,f),this._progressiveLightMap2=new y(a,a,f),this._lightMapCamera=new m(-a/2,a/2,a/2,-a/2,.5,50),this._lightMapMaterial=new M({fog:!1}),this._averagingWindow={value:e},this._previousShadowMap={value:this._progressiveLightMap1.texture},this._lightMapMaterial.onBeforeCompile=t=>{t.vertexShader="varying vec2 vUv;\n"+t.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const e=t.fragmentShader.indexOf("void main() {");t.fragmentShader="varying vec2 vUv;\n"+t.fragmentShader.slice(0,e)+"uniform sampler2D previousShadowMap;\n\tuniform float averagingWindow;\n"+t.fragmentShader.slice(e-1,-1)+"\nvec3 texelOld = texture2D(previousShadowMap, vUv).rgb;\n\t\t\t\tgl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);\n\t\t\t}",t.uniforms.averagingWindow=this._averagingWindow,t.uniforms.previousShadowMap=this._previousShadowMap},this._object3D=new g,this._randomizedLight=new Vt(u),this._object3D.add(this._randomizedLight.lightOrigin),this._object3D.add(this._randomizedLight.lightGroup),this._shadowReceiverMaterial=new Ht({color:new v(o),blend:n,opacity:r,alphaTest:i,map:this._progressiveLightMap2.texture}),this._shadowReceiver=new l(new _(s,c).rotateX(-Math.PI/2),this._shadowReceiverMaterial),this._shadowReceiver.receiveShadow=!0,this._shadowReceiver.renderOrder=this._renderOrder,this._object3D.add(this._shadowReceiver),this.entity.transform.object3D.add(this._object3D)}_beforeUpdate(){const{_discardMaterial:t,_lightMapMaterial:e,_shadowReceiver:n,_randomizedLight:r,_lights:i,_includedMeshes:o,_excludedMeshes:a}=this;i.forEach((t=>{t.object.intensity=0})),o.forEach((e=>{e.object.material=t})),a.forEach((t=>{t.object.visible=!1})),r.lightGroup.visible=!0,n.material=e}_afterUpdate(){const{_shadowReceiver:t,_shadowReceiverMaterial:e,_randomizedLight:n,_lights:r,_includedMeshes:i,_excludedMeshes:o}=this;r.forEach((t=>{t.object.intensity=t.intensity})),i.forEach((t=>{t.object.material=t.material})),o.forEach((t=>{t.object.visible=t.visible})),n.lightGroup.visible=!1,t.material=e}_updateLightMap(){const{_frames:t,_progressiveLightMap1:e,_progressiveLightMap2:n,_buffer1Active:r,_averagingWindow:i,_previousShadowMap:o,_lightMapCamera:a}=this,{gl:s}=this.scene.engine,{native:l}=this.scene;this._beforeUpdate(),i.value=t;const c=r?e:n,u=r?n:e;o.value=u.texture;const h=l.background,d=s.getRenderTarget();s.setRenderTarget(c),s.render(l,a),l.background=h,s.setRenderTarget(d),this._afterUpdate(),this._buffer1Active=!this._buffer1Active}_onEnable(){super._onEnable(),this.reset()}_destroy(){}}class Xt extends A{get tDiffuse(){return this._tDiffuse.value}set tDiffuse(t){this._tDiffuse.value=t}get tDepth(){return this._tDepth.value}set tDepth(t){this._tDepth.value=t}get distortionMap(){return this._distortionMap.value}set distortionMap(t){this._distortionMap.value=t}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(t){this._tDiffuseBlur.value=t}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(t){this._textureMatrix.value=t}get hasBlur(){return this._hasBlur.value}set hasBlur(t){this._hasBlur.value=t}get mirror(){return this._mirror.value}set mirror(t){this._mirror.value=t}get mixBlur(){return this._mixBlur.value}set mixBlur(t){this._mixBlur.value=t}get mixStrength(){return this._mixStrength.value}set mixStrength(t){this._mixStrength.value=t}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(t){this._minDepthThreshold.value=t}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(t){this._maxDepthThreshold.value=t}get depthScale(){return this._depthScale.value}set depthScale(t){this._depthScale.value=t}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(t){this._depthToBlurRatioBias.value=t}get distortion(){return this._distortion.value}set distortion(t){this._distortion.value=t}get mixContrast(){return this._mixContrast.value}set mixContrast(t){this._mixContrast.value=t}constructor(t={}){super({}),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._mixStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(t)}onBeforeCompile(t){var e;(null===(e=t.defines)||void 0===e?void 0:e.USE_UV)||(t.defines.USE_UV=""),t.uniforms.hasBlur=this._hasBlur,t.uniforms.tDiffuse=this._tDiffuse,t.uniforms.tDepth=this._tDepth,t.uniforms.distortionMap=this._distortionMap,t.uniforms.tDiffuseBlur=this._tDiffuseBlur,t.uniforms.textureMatrix=this._textureMatrix,t.uniforms.mirror=this._mirror,t.uniforms.mixBlur=this._mixBlur,t.uniforms.mixStrength=this._mixStrength,t.uniforms.minDepthThreshold=this._minDepthThreshold,t.uniforms.maxDepthThreshold=this._maxDepthThreshold,t.uniforms.depthScale=this._depthScale,t.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,t.uniforms.distortion=this._distortion,t.uniforms.mixContrast=this._mixContrast,t.vertexShader=`\n            uniform mat4 textureMatrix;\n            varying vec4 my_vUv;\n            ${t.vertexShader}`,t.vertexShader=t.vertexShader.replace("#include <project_vertex>","#include <project_vertex>\n            my_vUv = textureMatrix * vec4( position, 1.0 );\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );"),t.fragmentShader=`\n            uniform sampler2D tDiffuse;\n            uniform sampler2D tDiffuseBlur;\n            uniform sampler2D tDepth;\n            uniform sampler2D distortionMap;\n            uniform float distortion;\n            uniform float cameraNear;\n            uniform float cameraFar;\n            uniform bool hasBlur;\n            uniform float mixBlur;\n            uniform float mirror;\n            uniform float mixStrength;\n            uniform float minDepthThreshold;\n            uniform float maxDepthThreshold;\n            uniform float mixContrast;\n            uniform float depthScale;\n            uniform float depthToBlurRatioBias;\n            varying vec4 my_vUv;\n            ${t.fragmentShader}`,t.fragmentShader=t.fragmentShader.replace("#include <emissivemap_fragment>","#include <emissivemap_fragment>\n          \n            float distortionFactor = 0.0;\n            #ifdef USE_DISTORTION\n                distortionFactor = texture2D(distortionMap, vUv).r * distortion;\n            #endif\n        \n            vec4 new_vUv = my_vUv;\n            new_vUv.x += distortionFactor;\n            new_vUv.y += distortionFactor;\n        \n            vec4 base = texture2DProj(tDiffuse, new_vUv);\n            vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);\n        \n            vec4 merge = base;\n        \n            #ifdef USE_NORMALMAP\n                vec2 normal_uv = vec2(0.0);\n                vec4 normalColor = texture2D(normalMap, vUv * normalScale);\n                vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );\n                vec3 coord = new_vUv.xyz / new_vUv.w;\n                normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;\n                vec4 base_normal = texture2D(tDiffuse, normal_uv);\n                vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);\n                merge = base_normal;\n                blur = blur_normal;\n            #endif\n        \n            float depthFactor = 0.0001;\n            float blurFactor = 0.0;\n        \n            #ifdef USE_DEPTH\n                vec4 depth = texture2DProj(tDepth, new_vUv);\n                depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));\n                depthFactor *= depthScale;\n                depthFactor = max(0.0001, min(1.0, depthFactor));\n        \n                #ifdef USE_BLUR\n                blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);\n                merge = merge * min(1.0, depthFactor + 0.5);\n                #else\n                merge = merge * depthFactor;\n                #endif\n        \n            #endif\n        \n            float reflectorRoughnessFactor = roughness;\n            #ifdef USE_ROUGHNESSMAP\n                vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );\n                reflectorRoughnessFactor *= reflectorTexelRoughness.g;\n            #endif\n        \n            #ifdef USE_BLUR\n                blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);\n                merge = mix(merge, blur, blurFactor);\n            #endif\n        \n            vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);\n            newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;\n            newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;\n            newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;\n        \n            diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);\n            ")}}class Yt extends dt{constructor(t,e={}){super(t,e),this._initialize(e)}raycast(t){const{_object3D:e}=this;if(!ft(e)||!e.visible)return null;const n=[];return e.raycast(t,n),n.length>0?(n.sort(((t,e)=>t.distance-e.distance)),n[0]):null}_initialize(t){const{width:e=1,height:n=1,reflector:r={},material:i={}}=t;r.reflectDirection=new u(0,1,0);const o=this._reflector=new Mt(r),a=new Dt(e,n),{blur:s}=r,{depthScale:c=0,distortionMap:h}=i,d=s instanceof f?s.x+s.y>0:s>0,p=c>0,v=ft(h);i.textureMatrix=o.textureMatrix,i.tDiffuse=o.texture,i.tDiffuseBlur=o.blurTexture,i.tDepth=o.depthTexture,i.hasBlur=d;const g=new Xt(i);d&&(g.defines.USE_BLUR=""),p&&(g.defines.USE_DEPTH=""),v&&(g.defines.USE_DISTORTION="");const m=this._object3D=new l(a,g);m.renderOrder=this._renderOrder,m.add(o),m.onBeforeRender=(t,e,n)=>{o.visible=!1,o.render(t,e,n),o.visible=!0},this.entity.transform.object3D.add(m)}_destroy(){const{entity:t,_object3D:e,_reflector:n}=this,{geometry:r,material:i}=e,{resourceManager:o}=t.engine;n.removeFromParent(),n.dispose(),r.dispose(),o.disposeMaterial(i)}}function $t(){var t=Object.create(null);function e(r,i){var o=r.id,a=r.name,s=r.dependencies;void 0===s&&(s=[]);var l=r.init;void 0===l&&(l=function(){});var c=r.getTransferables;if(void 0===c&&(c=null),!t[o])try{s=s.map((function(n){return n&&n.isWorkerModule&&(e(n,(function(t){if(t instanceof Error)throw t})),n=t[n.id].value),n})),l=n("<"+a+">.init",l),c&&(c=n("<"+a+">.getTransferables",c));var u=null;"function"==typeof l?u=l.apply(void 0,s):console.error("worker module init function failed to rehydrate"),t[o]={id:o,value:u,getTransferables:c},i(u)}catch(t){t&&t.noLog||console.error(t),i(t)}}function n(t,e){var n=void 0;self.troikaDefine=function(t){return n=t};var r=URL.createObjectURL(new Blob(["/** "+t.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+e+"\n)"],{type:"application/javascript"}));try{importScripts(r)}catch(t){console.error(t)}return URL.revokeObjectURL(r),delete self.troikaDefine,n}self.addEventListener("message",(function(n){var r=n.data,i=r.messageId,o=r.action,a=r.data;try{"registerModule"===o&&e(a,(function(t){t instanceof Error?postMessage({messageId:i,success:!1,error:t.message}):postMessage({messageId:i,success:!0,result:{isCallable:"function"==typeof t}})})),"callModule"===o&&function(e,n){var r,i=e.id,o=e.args;t[i]&&"function"==typeof t[i].value||n(new Error("Worker module "+i+": not found or its 'init' did not return a function"));try{var a=(r=t[i]).value.apply(r,o);a&&"function"==typeof a.then?a.then(s,(function(t){return n(t instanceof Error?t:new Error(""+t))})):s(a)}catch(t){n(t)}function s(e){try{var r=t[i].getTransferables&&t[i].getTransferables(e);r&&Array.isArray(r)&&r.length||(r=void 0),n(e,r)}catch(t){console.error(t),n(t)}}}(a,(function(t,e){t instanceof Error?postMessage({messageId:i,success:!1,error:t.message}):postMessage({messageId:i,success:!0,result:t},e||void 0)}))}catch(t){postMessage({messageId:i,success:!1,error:t.stack})}}))}var Zt=function(){var t=!1;if("undefined"!=typeof window&&void 0!==window.document)try{new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"}))).terminate(),t=!0}catch(t){"undefined"!=typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+t.message+"]")}return Zt=function(){return t},t},Kt=0,Qt=0,Jt=!1,te=Object.create(null),ee=Object.create(null),ne=Object.create(null);function re(t){if(!(t&&"function"==typeof t.init||Jt))throw new Error("requires `options.init` function");var e=t.dependencies,n=t.init,r=t.getTransferables,i=t.workerId;if(!Zt())return function(t){var e=function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];return e._getInitResult().then((function(e){if("function"==typeof e)return e.apply(void 0,t);throw new Error("Worker module function was called but `init` did not return a callable function")}))};return e._getInitResult=function(){var n=t.dependencies,r=t.init;n=Array.isArray(n)?n.map((function(t){return t&&t._getInitResult?t._getInitResult():t})):[];var i=Promise.all(n).then((function(t){return r.apply(null,t)}));return e._getInitResult=function(){return i},i},e}(t);null==i&&(i="#default");var o="workerModule"+ ++Kt,a=t.name||o,s=null;function l(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];if(!s){s=oe(i,"registerModule",l.workerModuleData);var n=function(){s=null,ee[i].delete(n)};(ee[i]||(ee[i]=new Set)).add(n)}return s.then((function(e){if(e.isCallable)return oe(i,"callModule",{id:o,args:t});throw new Error("Worker module function was called but `init` did not return a callable function")}))}return e=e&&e.map((function(t){return"function"!=typeof t||t.workerModuleData||(Jt=!0,t=re({workerId:i,name:"<"+a+"> function dependency: "+t.name,init:"function(){return (\n"+ie(t)+"\n)}"}),Jt=!1),t&&t.workerModuleData&&(t=t.workerModuleData),t})),l.workerModuleData={isWorkerModule:!0,id:o,name:a,dependencies:e,init:ie(n),getTransferables:r&&ie(r)},l}function ie(t){var e=t.toString();return!/^function/.test(e)&&/^\w+\s*\(/.test(e)&&(e="function "+e),e}function oe(t,e,n){return new Promise((function(r,i){var o=++Qt;ne[o]=function(t){t.success?r(t.result):i(new Error("Error in worker "+e+" call: "+t.error))},function(t){var e=te[t];if(!e){var n=ie($t);(e=te[t]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+t.replace(/\*/g,"")+" **/\n\n;("+n+")()"],{type:"application/javascript"})))).onmessage=function(t){var e=t.data,n=e.messageId,r=ne[n];if(!r)throw new Error("WorkerModule response with empty or unknown messageId");delete ne[n],r(e)}}return e}(t).postMessage({messageId:o,action:e,data:n})}))}function ae(){var t=function(t){function e(t,e,n,r,i,o,a,s,l,c){var u=1-l;c.x=u*u*u*t+3*u*u*l*n+3*u*l*l*i+l*l*l*a,c.y=u*u*u*e+3*u*u*l*r+3*u*l*l*o+l*l*l*s}function n(t,e){for(var n,r,i,o,a,s=/([MLQCZ])([^MLQCZ]*)/g;n=s.exec(t);){var l=n[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map((function(t){return parseFloat(t)}));switch(n[1]){case"M":o=r=l[0],a=i=l[1];break;case"L":l[0]===o&&l[1]===a||e("L",o,a,o=l[0],a=l[1]);break;case"Q":e("Q",o,a,o=l[2],a=l[3],l[0],l[1]);break;case"C":e("C",o,a,o=l[4],a=l[5],l[0],l[1],l[2],l[3]);break;case"Z":o===r&&a===i||e("L",o,a,r,i)}}}function r(t,r,i){void 0===i&&(i=16);var o={x:0,y:0};n(t,(function(t,n,a,s,l,c,u,h,d){switch(t){case"L":r(n,a,s,l);break;case"Q":for(var f=n,p=a,v=1;v<i;v++)_=a,x=u,b=l,T=1-(w=v/(i-1)),(S=o).x=T*T*n+2*T*w*c+w*w*s,S.y=T*T*_+2*T*w*x+w*w*b,r(f,p,o.x,o.y),f=o.x,p=o.y;break;case"C":for(var g=n,m=a,y=1;y<i;y++)e(n,a,c,u,h,d,s,l,y/(i-1),o),r(g,m,o.x,o.y),g=o.x,m=o.y}var _,x,b,w,S,T}))}var i="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",o="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",a=new WeakMap,s={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function l(t,e){var n=t.getContext?t.getContext("webgl",s):t,r=a.get(n);if(!r){var i="undefined"!=typeof WebGL2RenderingContext&&n instanceof WebGL2RenderingContext,o={},l={},c={},u=-1,h=[];function d(t){var e=o[t];if(!e&&!(e=o[t]=n.getExtension(t)))throw new Error(t+" not supported");return e}function f(t,e){var r=n.createShader(e);return n.shaderSource(r,t),n.compileShader(r),r}function p(t,e,r,o){if(!l[t]){var a={},s={},c=n.createProgram();n.attachShader(c,f(e,n.VERTEX_SHADER)),n.attachShader(c,f(r,n.FRAGMENT_SHADER)),n.linkProgram(c),l[t]={program:c,transaction:function(t){n.useProgram(c),t({setUniform:function(t,e){for(var r=[],i=arguments.length-2;i-- >0;)r[i]=arguments[i+2];var o=s[e]||(s[e]=n.getUniformLocation(c,e));n["uniform"+t].apply(n,[o].concat(r))},setAttribute:function(t,e,r,o,s){var l=a[t];l||(l=a[t]={buf:n.createBuffer(),loc:n.getAttribLocation(c,t),data:null}),n.bindBuffer(n.ARRAY_BUFFER,l.buf),n.vertexAttribPointer(l.loc,e,n.FLOAT,!1,0,0),n.enableVertexAttribArray(l.loc),i?n.vertexAttribDivisor(l.loc,o):d("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(l.loc,o),s!==l.data&&(n.bufferData(n.ARRAY_BUFFER,s,r),l.data=s)}})}}}l[t].transaction(o)}function v(t,e){u++;try{n.activeTexture(n.TEXTURE0+u);var r=c[t];r||(r=c[t]=n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.bindTexture(n.TEXTURE_2D,r),e(r,u)}finally{u--}}function g(t,e,r){var i=n.createFramebuffer();h.push(i),n.bindFramebuffer(n.FRAMEBUFFER,i),n.activeTexture(n.TEXTURE0+e),n.bindTexture(n.TEXTURE_2D,t),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0);try{r(i)}finally{n.deleteFramebuffer(i),n.bindFramebuffer(n.FRAMEBUFFER,h[--h.length-1]||null)}}function m(){o={},l={},c={},u=-1,h.length=0}n.canvas.addEventListener("webglcontextlost",(function(t){m(),t.preventDefault()}),!1),a.set(n,r={gl:n,isWebGL2:i,getExtension:d,withProgram:p,withTexture:v,withTextureFramebuffer:g,handleContextLoss:m})}e(r)}function c(t,e,n,r,a,s,c,u){void 0===c&&(c=15),void 0===u&&(u=null),l(t,(function(t){var l=t.gl,h=t.withProgram;(0,t.withTexture)("copy",(function(t,d){l.texImage2D(l.TEXTURE_2D,0,l.RGBA,a,s,0,l.RGBA,l.UNSIGNED_BYTE,e),h("copy",i,o,(function(t){var e=t.setUniform;(0,t.setAttribute)("aUV",2,l.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),e("1i","image",d),l.bindFramebuffer(l.FRAMEBUFFER,u||null),l.disable(l.BLEND),l.colorMask(8&c,4&c,2&c,1&c),l.viewport(n,r,a,s),l.scissor(n,r,a,s),l.drawArrays(l.TRIANGLES,0,3)}))}))}))}var u=Object.freeze({__proto__:null,withWebGLContext:l,renderImageData:c,resizeWebGLCanvasWithoutClearing:function(t,e,n){var r=t.width,i=t.height;l(t,(function(o){var a=o.gl,s=new Uint8Array(r*i*4);a.readPixels(0,0,r,i,a.RGBA,a.UNSIGNED_BYTE,s),t.width=e,t.height=n,c(a,s,0,0,r,i)}))}});function h(t,e,n,i,o,a){void 0===a&&(a=1);var s=new Uint8Array(t*e),l=i[2]-i[0],c=i[3]-i[1],u=[];r(n,(function(t,e,n,r){u.push({x1:t,y1:e,x2:n,y2:r,minX:Math.min(t,n),minY:Math.min(e,r),maxX:Math.max(t,n),maxY:Math.max(e,r)})})),u.sort((function(t,e){return t.maxX-e.maxX}));for(var h=0;h<t;h++)for(var d=0;d<e;d++){var f=g(i[0]+l*(h+.5)/t,i[1]+c*(d+.5)/e),v=Math.pow(1-Math.abs(f)/o,a)/2;f<0&&(v=1-v),v=Math.max(0,Math.min(255,Math.round(255*v))),s[d*t+h]=v}return s;function g(t,e){for(var n=1/0,r=1/0,i=u.length;i--;){var o=u[i];if(o.maxX+r<=t)break;if(t+r>o.minX&&e-r<o.maxY&&e+r>o.minY){var a=p(t,e,o.x1,o.y1,o.x2,o.y2);a<n&&(n=a,r=Math.sqrt(n))}}return function(t,e){for(var n=0,r=u.length;r--;){var i=u[r];if(i.maxX<=t)break;i.y1>e!=i.y2>e&&t<(i.x2-i.x1)*(e-i.y1)/(i.y2-i.y1)+i.x1&&(n+=i.y1<i.y2?1:-1)}return 0!==n}(t,e)&&(r=-r),r}}function d(t,e,n,r,i,o,a,s,l,c){void 0===o&&(o=1),void 0===s&&(s=0),void 0===l&&(l=0),void 0===c&&(c=0),f(t,e,n,r,i,o,a,null,s,l,c)}function f(t,e,n,r,i,o,a,s,l,u,d){void 0===o&&(o=1),void 0===l&&(l=0),void 0===u&&(u=0),void 0===d&&(d=0);for(var f=h(t,e,n,r,i,o),p=new Uint8Array(4*f.length),v=0;v<f.length;v++)p[4*v+d]=f[v];c(a,p,l,u,t,e,1<<3-d,s)}function p(t,e,n,r,i,o){var a=i-n,s=o-r,l=a*a+s*s,c=l?Math.max(0,Math.min(1,((t-n)*a+(e-r)*s)/l)):0,u=t-(n+c*a),h=e-(r+c*s);return u*u+h*h}var v=Object.freeze({__proto__:null,generate:h,generateIntoCanvas:d,generateIntoFramebuffer:f}),g="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",m="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",y="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",_=new Float32Array([0,0,2,0,0,2]),x=null,b=!1,w={},S=new WeakMap;function T(t){if(!b&&!A(t))throw new Error("WebGL generation not supported")}function U(t,e,n,r,i,o,a){if(void 0===o&&(o=1),void 0===a&&(a=null),!a&&!(a=x)){var s="function"==typeof OffscreenCanvas?new OffscreenCanvas(1,1):"undefined"!=typeof document?document.createElement("canvas"):null;if(!s)throw new Error("OffscreenCanvas or DOM canvas not supported");a=x=s.getContext("webgl",{depth:!1})}T(a);var c=new Uint8Array(t*e*4);l(a,(function(a){var s=a.gl,l=a.withTexture,u=a.withTextureFramebuffer;l("readable",(function(a,l){s.texImage2D(s.TEXTURE_2D,0,s.RGBA,t,e,0,s.RGBA,s.UNSIGNED_BYTE,null),u(a,l,(function(a){D(t,e,n,r,i,o,s,a,0,0,0),s.readPixels(0,0,t,e,s.RGBA,s.UNSIGNED_BYTE,c)}))}))}));for(var u=new Uint8Array(t*e),h=0,d=0;h<c.length;h+=4)u[d++]=c[h];return u}function M(t,e,n,r,i,o,a,s,l,c){void 0===o&&(o=1),void 0===s&&(s=0),void 0===l&&(l=0),void 0===c&&(c=0),D(t,e,n,r,i,o,a,null,s,l,c)}function D(t,e,n,o,a,s,c,u,h,d,f){void 0===s&&(s=1),void 0===h&&(h=0),void 0===d&&(d=0),void 0===f&&(f=0),T(c);var p=[];r(n,(function(t,e,n,r){p.push(t,e,n,r)})),p=new Float32Array(p),l(c,(function(n){var r=n.gl,l=n.isWebGL2,c=n.getExtension,v=n.withProgram,x=n.withTexture,b=n.withTextureFramebuffer,w=n.handleContextLoss;if(x("rawDistances",(function(n,x){t===n._lastWidth&&e===n._lastHeight||r.texImage2D(r.TEXTURE_2D,0,r.RGBA,n._lastWidth=t,n._lastHeight=e,0,r.RGBA,r.UNSIGNED_BYTE,null),v("main",g,m,(function(i){var u=i.setAttribute,h=i.setUniform,d=!l&&c("ANGLE_instanced_arrays"),f=!l&&c("EXT_blend_minmax");u("aUV",2,r.STATIC_DRAW,0,_),u("aLineSegment",4,r.DYNAMIC_DRAW,1,p),h.apply(void 0,["4f","uGlyphBounds"].concat(o)),h("1f","uMaxDistance",a),h("1f","uExponent",s),b(n,x,(function(n){r.enable(r.BLEND),r.colorMask(!0,!0,!0,!0),r.viewport(0,0,t,e),r.scissor(0,0,t,e),r.blendFunc(r.ONE,r.ONE),r.blendEquationSeparate(r.FUNC_ADD,l?r.MAX:f.MAX_EXT),r.clear(r.COLOR_BUFFER_BIT),l?r.drawArraysInstanced(r.TRIANGLES,0,3,p.length/4):d.drawArraysInstancedANGLE(r.TRIANGLES,0,3,p.length/4)}))})),v("post",i,y,(function(n){n.setAttribute("aUV",2,r.STATIC_DRAW,0,_),n.setUniform("1i","tex",x),r.bindFramebuffer(r.FRAMEBUFFER,u),r.disable(r.BLEND),r.colorMask(0===f,1===f,2===f,3===f),r.viewport(h,d,t,e),r.scissor(h,d,t,e),r.drawArrays(r.TRIANGLES,0,3)}))})),r.isContextLost())throw w(),new Error("webgl context lost")}))}function A(t){var e=t&&t!==x?t.canvas||t:w,n=S.get(e);if(void 0===n){b=!0;var r=null;try{var i=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],o=U(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,t);(n=o&&i.length===o.length&&o.every((function(t,e){return t===i[e]})))||(r="bad trial run results",console.info(i,o))}catch(t){n=!1,r=t.message}r&&console.warn("WebGL SDF generation not supported:",r),b=!1,S.set(e,n)}return n}var C=Object.freeze({__proto__:null,generate:U,generateIntoCanvas:M,generateIntoFramebuffer:D,isSupported:A});return t.forEachPathCommand=n,t.generate=function(t,e,n,r,i,o){void 0===i&&(i=Math.max(r[2]-r[0],r[3]-r[1])/2),void 0===o&&(o=1);try{return U.apply(C,arguments)}catch(t){return console.info("WebGL SDF generation failed, falling back to JS",t),h.apply(v,arguments)}},t.generateIntoCanvas=function(t,e,n,r,i,o,a,s,l,c){void 0===i&&(i=Math.max(r[2]-r[0],r[3]-r[1])/2),void 0===o&&(o=1),void 0===s&&(s=0),void 0===l&&(l=0),void 0===c&&(c=0);try{return M.apply(C,arguments)}catch(t){return console.info("WebGL SDF generation failed, falling back to JS",t),d.apply(v,arguments)}},t.javascript=v,t.pathToLineSegments=r,t.webgl=C,t.webglUtils=u,Object.defineProperty(t,"__esModule",{value:!0}),t}({});return t}const se=/\bvoid\s+main\s*\(\s*\)\s*{/g;function le(t){return t.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(t,e){let n=k[e];return n?le(n):t}))}const ce=[];for(let t=0;t<256;t++)ce[t]=(t<16?"0":"")+t.toString(16);const ue=Object.assign||function(){let t=arguments[0];for(let e=1,n=arguments.length;e<n;e++){let n=arguments[e];if(n)for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},he=Date.now(),de=new WeakMap,fe=new Map;let pe=1e10;function ve(t,e){const n=function(t){const e=JSON.stringify(t,me);let n=_e.get(e);return null==n&&_e.set(e,n=++ye),n}
/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/(e);let r=de.get(t);if(r||de.set(t,r=Object.create(null)),r[n])return new r[n];const i=`_onBeforeCompile${n}`,o=function(r,o){t.onBeforeCompile.call(this,r,o);const a=this.customProgramCacheKey()+"|"+r.vertexShader+"|"+r.fragmentShader;let s=fe[a];if(!s){const t=function(t,{vertexShader:e,fragmentShader:n},r,i){let{vertexDefs:o,vertexMainIntro:a,vertexMainOutro:s,vertexTransform:l,fragmentDefs:c,fragmentMainIntro:u,fragmentMainOutro:h,fragmentColorTransform:d,customRewriter:f,timeUniform:p}=r;if(o=o||"",a=a||"",s=s||"",c=c||"",u=u||"",h=h||"",(l||f)&&(e=le(e)),(d||f)&&(n=le(n=n.replace(/^[ \t]*#include <((?:tonemapping|encodings|fog|premultiplied_alpha|dithering)_fragment)>/gm,"\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n"))),f){let t=f({vertexShader:e,fragmentShader:n});e=t.vertexShader,n=t.fragmentShader}if(d){let t=[];n=n.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,(e=>(t.push(e),""))),h=`${d}\n${t.join("\n")}\n${h}`}if(p){const t=`\nuniform float ${p};\n`;o=t+o,c=t+c}return l&&(o=`${o}\nvoid troikaVertexTransform${i}(inout vec3 position, inout vec3 normal, inout vec2 uv) {\n  ${l}\n}\n`,a=`\ntroika_position_${i} = vec3(position);\ntroika_normal_${i} = vec3(normal);\ntroika_uv_${i} = vec2(uv);\ntroikaVertexTransform${i}(troika_position_${i}, troika_normal_${i}, troika_uv_${i});\n${a}\n`,e=(e=`vec3 troika_position_${i};\nvec3 troika_normal_${i};\nvec2 troika_uv_${i};\n${e}\n`).replace(/\b(position|normal|uv)\b/g,((t,e,n,r)=>/\battribute\s+vec[23]\s+$/.test(r.substr(0,n))?e:`troika_${e}_${i}`)),t.map&&t.map.channel>0||(e=e.replace(/\bMAP_UV\b/g,`troika_uv_${i}`))),{vertexShader:e=ge(e,i,o,a,s),fragmentShader:n=ge(n,i,c,u,h)}}(this,r,e,n);s=fe[a]=t}r.vertexShader=s.vertexShader,r.fragmentShader=s.fragmentShader,ue(r.uniforms,this.uniforms),e.timeUniform&&(r.uniforms[e.timeUniform]={get value(){return Date.now()-he}}),this[i]&&this[i](r)},a=function(){return s(e.chained?t:t.clone())},s=function(r){const i=Object.create(r,l);return Object.defineProperty(i,"baseMaterial",{value:t}),Object.defineProperty(i,"id",{value:pe++}),i.uuid=function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(ce[255&t]+ce[t>>8&255]+ce[t>>16&255]+ce[t>>24&255]+"-"+ce[255&e]+ce[e>>8&255]+"-"+ce[e>>16&15|64]+ce[e>>24&255]+"-"+ce[63&n|128]+ce[n>>8&255]+"-"+ce[n>>16&255]+ce[n>>24&255]+ce[255&r]+ce[r>>8&255]+ce[r>>16&255]+ce[r>>24&255]).toUpperCase()}(),i.uniforms=ue({},r.uniforms,e.uniforms),i.defines=ue({},r.defines,e.defines),i.defines[`TROIKA_DERIVED_MATERIAL_${n}`]="",i.extensions=ue({},r.extensions,e.extensions),i._listeners=void 0,i},l={constructor:{value:a},isDerivedMaterial:{value:!0},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return t.customProgramCacheKey()+"|"+n}},onBeforeCompile:{get:()=>o,set(t){this[i]=t}},copy:{writable:!0,configurable:!0,value:function(e){return t.copy.call(this,e),t.isShaderMaterial||t.isDerivedMaterial||(ue(this.extensions,e.extensions),ue(this.defines,e.defines),ue(this.uniforms,C.clone(e.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const e=new t.constructor;return s(e).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let n=this._depthMaterial;return n||(n=this._depthMaterial=ve(t.isDerivedMaterial?t.getDepthMaterial():new x({depthPacking:P}),e),n.defines.IS_DEPTH_MATERIAL="",n.uniforms=this.uniforms),n}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let n=this._distanceMaterial;return n||(n=this._distanceMaterial=ve(t.isDerivedMaterial?t.getDistanceMaterial():new B,e),n.defines.IS_DISTANCE_MATERIAL="",n.uniforms=this.uniforms),n}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:e,_distanceMaterial:n}=this;e&&e.dispose(),n&&n.dispose(),t.dispose.call(this)}}};return r[n]=a,new a}function ge(t,e,n,r,i){return(r||i||n)&&(t=t.replace(se,`\n${n}\nvoid troikaOrigMain${e}() {`),t+=`\nvoid main() {\n  ${r}\n  troikaOrigMain${e}();\n  ${i}\n}`),t}function me(t,e){return"uniforms"===t?void 0:"function"==typeof e?e.toString():e}let ye=0;const _e=new Map,xe=re({name:"FontResolver",dependencies:[function(t,e){const n=Object.create(null),r=Object.create(null);function i(e,i){let o=n[e];o?i(o):r[e]?r[e].push(i):(r[e]=[i],function(i,o){const a=t=>{console.error(`Failure loading font ${i}`,t)};try{const o=new XMLHttpRequest;o.open("get",i,!0),o.responseType="arraybuffer",o.onload=function(){if(o.status>=400)a(new Error(o.statusText));else if(o.status>0)try{const a=t(o.response);a.src=i,(t=>{t.src=e,n[e]=t,r[e].forEach((e=>e(t))),delete r[e]})(a)}catch(t){a(t)}},o.onerror=a,o.send()}catch(t){a(t)}}(e))}return function(t,r,{lang:o,fonts:a=[],style:s="normal",weight:l="normal",unicodeFontsURL:c}={}){const u=new Uint8Array(t.length),h=[];t.length||v();const d=new Map,f=[];if("italic"!==s&&(s="normal"),"number"!=typeof l&&(l="bold"===l?700:400),a&&!Array.isArray(a)&&(a=[a]),(a=a.slice().filter((t=>!t.lang||t.lang.test(o))).reverse()).length){const e=1,r=2;let o=0;!function s(l=0){for(let c=l,p=t.length;c<p;c++){const l=t.codePointAt(c);if(o===e&&h[u[c-1]].supportsCodePoint(l)||/\s/.test(t[c]))u[c]=u[c-1],o===r&&(f[f.length-1][1]=c);else for(let t=u[c],p=a.length;t<=p;t++)if(t===p)(o===r?f[f.length-1]:f[f.length]=[c,c])[1]=c,o=r;else{u[c]=t;const{src:r,unicodeRange:f}=a[t];if(!f||g(l,f)){const t=n[r];if(!t)return void i(r,(()=>{s(c)}));if(t.supportsCodePoint(l)){let n=d.get(t);"number"!=typeof n&&(n=h.length,h.push(t),d.set(t,n)),u[c]=n,o=e;break}}}l>65535&&c+1<p&&(u[c+1]=u[c],c++,o===r&&(f[f.length-1][1]=c))}p()}()}else f.push([0,t.length-1]),p();function p(){if(f.length){const n=f.map((e=>t.substring(e[0],e[1]+1))).join("\n");e.getFontsForString(n,{lang:o||void 0,style:s,weight:l,dataUrl:c}).then((({fontUrls:t,chars:e})=>{const n=h.length;let r=0;f.forEach((t=>{for(let i=0,o=t[1]-t[0];i<=o;i++)u[t[0]+i]=e[r++]+n;r++}));let o=0;t.forEach(((e,r)=>{i(e,(e=>{h[r+n]=e,++o===t.length&&v()}))}))}))}else v()}function v(){r({chars:u,fonts:h})}function g(t,e){for(let n=0;n<e.length;n++){const[r,i=r]=e[n];if(r<=t&&t<=i)return!0}return!1}}},re({name:"Typr Font Parser",dependencies:[function(){return"undefined"==typeof window&&(self.window=self),function(t){var e={parse:function(t){var n=e._bin,r=new Uint8Array(t);if("ttcf"==n.readASCII(r,0,4)){var i=4;n.readUshort(r,i),i+=2,n.readUshort(r,i),i+=2;var o=n.readUint(r,i);i+=4;for(var a=[],s=0;s<o;s++){var l=n.readUint(r,i);i+=4,a.push(e._readFont(r,l))}return a}return[e._readFont(r,0)]},_readFont:function(t,n){var r=e._bin,i=n;r.readFixed(t,n),n+=4;var o=r.readUshort(t,n);n+=2,r.readUshort(t,n),n+=2,r.readUshort(t,n),n+=2,r.readUshort(t,n),n+=2;for(var a=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],s={_data:t,_offset:i},l={},c=0;c<o;c++){var u=r.readASCII(t,n,4);n+=4,r.readUint(t,n),n+=4;var h=r.readUint(t,n);n+=4;var d=r.readUint(t,n);n+=4,l[u]={offset:h,length:d}}for(c=0;c<a.length;c++){var f=a[c];l[f]&&(s[f.trim()]=e[f.trim()].parse(t,l[f].offset,l[f].length,s))}return s},_tabOffset:function(t,n,r){for(var i=e._bin,o=i.readUshort(t,r+4),a=r+12,s=0;s<o;s++){var l=i.readASCII(t,a,4);a+=4,i.readUint(t,a),a+=4;var c=i.readUint(t,a);if(a+=4,i.readUint(t,a),a+=4,l==n)return c}return 0}};e._bin={readFixed:function(t,e){return(t[e]<<8|t[e+1])+(t[e+2]<<8|t[e+3])/65540},readF2dot14:function(t,n){return e._bin.readShort(t,n)/16384},readInt:function(t,n){return e._bin._view(t).getInt32(n)},readInt8:function(t,n){return e._bin._view(t).getInt8(n)},readShort:function(t,n){return e._bin._view(t).getInt16(n)},readUshort:function(t,n){return e._bin._view(t).getUint16(n)},readUshorts:function(t,n,r){for(var i=[],o=0;o<r;o++)i.push(e._bin.readUshort(t,n+2*o));return i},readUint:function(t,n){return e._bin._view(t).getUint32(n)},readUint64:function(t,n){return 4294967296*e._bin.readUint(t,n)+e._bin.readUint(t,n+4)},readASCII:function(t,e,n){for(var r="",i=0;i<n;i++)r+=String.fromCharCode(t[e+i]);return r},readUnicode:function(t,e,n){for(var r="",i=0;i<n;i++){var o=t[e++]<<8|t[e++];r+=String.fromCharCode(o)}return r},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(t,n,r){var i=e._bin._tdec;return i&&0==n&&r==t.length?i.decode(t):e._bin.readASCII(t,n,r)},readBytes:function(t,e,n){for(var r=[],i=0;i<n;i++)r.push(t[e+i]);return r},readASCIIArray:function(t,e,n){for(var r=[],i=0;i<n;i++)r.push(String.fromCharCode(t[e+i]));return r},_view:function(t){return t._dataView||(t._dataView=t.buffer?new DataView(t.buffer,t.byteOffset,t.byteLength):new DataView(new Uint8Array(t).buffer))}},e._lctf={},e._lctf.parse=function(t,n,r,i,o){var a=e._bin,s={},l=n;a.readFixed(t,n),n+=4;var c=a.readUshort(t,n);n+=2;var u=a.readUshort(t,n);n+=2;var h=a.readUshort(t,n);return n+=2,s.scriptList=e._lctf.readScriptList(t,l+c),s.featureList=e._lctf.readFeatureList(t,l+u),s.lookupList=e._lctf.readLookupList(t,l+h,o),s},e._lctf.readLookupList=function(t,n,r){var i=e._bin,o=n,a=[],s=i.readUshort(t,n);n+=2;for(var l=0;l<s;l++){var c=i.readUshort(t,n);n+=2;var u=e._lctf.readLookupTable(t,o+c,r);a.push(u)}return a},e._lctf.readLookupTable=function(t,n,r){var i=e._bin,o=n,a={tabs:[]};a.ltype=i.readUshort(t,n),n+=2,a.flag=i.readUshort(t,n),n+=2;var s=i.readUshort(t,n);n+=2;for(var l=a.ltype,c=0;c<s;c++){var u=i.readUshort(t,n);n+=2;var h=r(t,l,o+u,a);a.tabs.push(h)}return a},e._lctf.numOfOnes=function(t){for(var e=0,n=0;n<32;n++)0!=(t>>>n&1)&&e++;return e},e._lctf.readClassDef=function(t,n){var r=e._bin,i=[],o=r.readUshort(t,n);if(n+=2,1==o){var a=r.readUshort(t,n);n+=2;var s=r.readUshort(t,n);n+=2;for(var l=0;l<s;l++)i.push(a+l),i.push(a+l),i.push(r.readUshort(t,n)),n+=2}if(2==o){var c=r.readUshort(t,n);for(n+=2,l=0;l<c;l++)i.push(r.readUshort(t,n)),n+=2,i.push(r.readUshort(t,n)),n+=2,i.push(r.readUshort(t,n)),n+=2}return i},e._lctf.getInterval=function(t,e){for(var n=0;n<t.length;n+=3){var r=t[n],i=t[n+1];if(t[n+2],r<=e&&e<=i)return n}return-1},e._lctf.readCoverage=function(t,n){var r=e._bin,i={};i.fmt=r.readUshort(t,n),n+=2;var o=r.readUshort(t,n);return n+=2,1==i.fmt&&(i.tab=r.readUshorts(t,n,o)),2==i.fmt&&(i.tab=r.readUshorts(t,n,3*o)),i},e._lctf.coverageIndex=function(t,n){var r=t.tab;if(1==t.fmt)return r.indexOf(n);if(2==t.fmt){var i=e._lctf.getInterval(r,n);if(-1!=i)return r[i+2]+(n-r[i])}return-1},e._lctf.readFeatureList=function(t,n){var r=e._bin,i=n,o=[],a=r.readUshort(t,n);n+=2;for(var s=0;s<a;s++){var l=r.readASCII(t,n,4);n+=4;var c=r.readUshort(t,n);n+=2;var u=e._lctf.readFeatureTable(t,i+c);u.tag=l.trim(),o.push(u)}return o},e._lctf.readFeatureTable=function(t,n){var r=e._bin,i=n,o={},a=r.readUshort(t,n);n+=2,a>0&&(o.featureParams=i+a);var s=r.readUshort(t,n);n+=2,o.tab=[];for(var l=0;l<s;l++)o.tab.push(r.readUshort(t,n+2*l));return o},e._lctf.readScriptList=function(t,n){var r=e._bin,i=n,o={},a=r.readUshort(t,n);n+=2;for(var s=0;s<a;s++){var l=r.readASCII(t,n,4);n+=4;var c=r.readUshort(t,n);n+=2,o[l.trim()]=e._lctf.readScriptTable(t,i+c)}return o},e._lctf.readScriptTable=function(t,n){var r=e._bin,i=n,o={},a=r.readUshort(t,n);n+=2,a>0&&(o.default=e._lctf.readLangSysTable(t,i+a));var s=r.readUshort(t,n);n+=2;for(var l=0;l<s;l++){var c=r.readASCII(t,n,4);n+=4;var u=r.readUshort(t,n);n+=2,o[c.trim()]=e._lctf.readLangSysTable(t,i+u)}return o},e._lctf.readLangSysTable=function(t,n){var r=e._bin,i={};r.readUshort(t,n),n+=2,i.reqFeature=r.readUshort(t,n),n+=2;var o=r.readUshort(t,n);return n+=2,i.features=r.readUshorts(t,n,o),i},e.CFF={},e.CFF.parse=function(t,n,r){var i=e._bin;(t=new Uint8Array(t.buffer,n,r))[n=0],t[++n],t[++n],t[++n],n++;var o=[];n=e.CFF.readIndex(t,n,o);for(var a=[],s=0;s<o.length-1;s++)a.push(i.readASCII(t,n+o[s],o[s+1]-o[s]));n+=o[o.length-1];var l=[];n=e.CFF.readIndex(t,n,l);var c=[];for(s=0;s<l.length-1;s++)c.push(e.CFF.readDict(t,n+l[s],n+l[s+1]));n+=l[l.length-1];var u=c[0],h=[];n=e.CFF.readIndex(t,n,h);var d=[];for(s=0;s<h.length-1;s++)d.push(i.readASCII(t,n+h[s],h[s+1]-h[s]));if(n+=h[h.length-1],e.CFF.readSubrs(t,n,u),u.CharStrings){n=u.CharStrings,h=[],n=e.CFF.readIndex(t,n,h);var f=[];for(s=0;s<h.length-1;s++)f.push(i.readBytes(t,n+h[s],h[s+1]-h[s]));u.CharStrings=f}if(u.ROS){n=u.FDArray;var p=[];for(n=e.CFF.readIndex(t,n,p),u.FDArray=[],s=0;s<p.length-1;s++){var v=e.CFF.readDict(t,n+p[s],n+p[s+1]);e.CFF._readFDict(t,v,d),u.FDArray.push(v)}n+=p[p.length-1],n=u.FDSelect,u.FDSelect=[];var g=t[n];if(n++,3!=g)throw g;var m=i.readUshort(t,n);for(n+=2,s=0;s<m+1;s++)u.FDSelect.push(i.readUshort(t,n),t[n+2]),n+=3}return u.Encoding&&(u.Encoding=e.CFF.readEncoding(t,u.Encoding,u.CharStrings.length)),u.charset&&(u.charset=e.CFF.readCharset(t,u.charset,u.CharStrings.length)),e.CFF._readFDict(t,u,d),u},e.CFF._readFDict=function(t,n,r){var i;for(var o in n.Private&&(i=n.Private[1],n.Private=e.CFF.readDict(t,i,i+n.Private[0]),n.Private.Subrs&&e.CFF.readSubrs(t,i+n.Private.Subrs,n.Private)),n)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(o)&&(n[o]=r[n[o]-426+35])},e.CFF.readSubrs=function(t,n,r){var i=e._bin,o=[];n=e.CFF.readIndex(t,n,o);var a,s=o.length;a=s<1240?107:s<33900?1131:32768,r.Bias=a,r.Subrs=[];for(var l=0;l<o.length-1;l++)r.Subrs.push(i.readBytes(t,n+o[l],o[l+1]-o[l]))},e.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],e.CFF.glyphByUnicode=function(t,e){for(var n=0;n<t.charset.length;n++)if(t.charset[n]==e)return n;return-1},e.CFF.glyphBySE=function(t,n){return n<0||n>255?-1:e.CFF.glyphByUnicode(t,e.CFF.tableSE[n])},e.CFF.readEncoding=function(t,n,r){e._bin;var i=[".notdef"],o=t[n];if(n++,0!=o)throw"error: unknown encoding format: "+o;var a=t[n];n++;for(var s=0;s<a;s++)i.push(t[n+s]);return i},e.CFF.readCharset=function(t,n,r){var i=e._bin,o=[".notdef"],a=t[n];if(n++,0==a)for(var s=0;s<r;s++){var l=i.readUshort(t,n);n+=2,o.push(l)}else{if(1!=a&&2!=a)throw"error: format: "+a;for(;o.length<r;){l=i.readUshort(t,n),n+=2;var c=0;for(1==a?(c=t[n],n++):(c=i.readUshort(t,n),n+=2),s=0;s<=c;s++)o.push(l),l++}}return o},e.CFF.readIndex=function(t,n,r){var i=e._bin,o=i.readUshort(t,n)+1,a=t[n+=2];if(n++,1==a)for(var s=0;s<o;s++)r.push(t[n+s]);else if(2==a)for(s=0;s<o;s++)r.push(i.readUshort(t,n+2*s));else if(3==a)for(s=0;s<o;s++)r.push(16777215&i.readUint(t,n+3*s-1));else if(1!=o)throw"unsupported offset size: "+a+", count: "+o;return(n+=o*a)-1},e.CFF.getCharString=function(t,n,r){var i=e._bin,o=t[n],a=t[n+1];t[n+2],t[n+3],t[n+4];var s=1,l=null,c=null;o<=20&&(l=o,s=1),12==o&&(l=100*o+a,s=2),21<=o&&o<=27&&(l=o,s=1),28==o&&(c=i.readShort(t,n+1),s=3),29<=o&&o<=31&&(l=o,s=1),32<=o&&o<=246&&(c=o-139,s=1),247<=o&&o<=250&&(c=256*(o-247)+a+108,s=2),251<=o&&o<=254&&(c=256*-(o-251)-a-108,s=2),255==o&&(c=i.readInt(t,n+1)/65535,s=5),r.val=null!=c?c:"o"+l,r.size=s},e.CFF.readCharString=function(t,n,r){for(var i=n+r,o=e._bin,a=[];n<i;){var s=t[n],l=t[n+1];t[n+2],t[n+3],t[n+4];var c=1,u=null,h=null;s<=20&&(u=s,c=1),12==s&&(u=100*s+l,c=2),19!=s&&20!=s||(u=s,c=2),21<=s&&s<=27&&(u=s,c=1),28==s&&(h=o.readShort(t,n+1),c=3),29<=s&&s<=31&&(u=s,c=1),32<=s&&s<=246&&(h=s-139,c=1),247<=s&&s<=250&&(h=256*(s-247)+l+108,c=2),251<=s&&s<=254&&(h=256*-(s-251)-l-108,c=2),255==s&&(h=o.readInt(t,n+1)/65535,c=5),a.push(null!=h?h:"o"+u),n+=c}return a},e.CFF.readDict=function(t,n,r){for(var i=e._bin,o={},a=[];n<r;){var s=t[n],l=t[n+1];t[n+2],t[n+3],t[n+4];var c=1,u=null,h=null;if(28==s&&(h=i.readShort(t,n+1),c=3),29==s&&(h=i.readInt(t,n+1),c=5),32<=s&&s<=246&&(h=s-139,c=1),247<=s&&s<=250&&(h=256*(s-247)+l+108,c=2),251<=s&&s<=254&&(h=256*-(s-251)-l-108,c=2),255==s)throw h=i.readInt(t,n+1)/65535,c=5,"unknown number";if(30==s){var d=[];for(c=1;;){var f=t[n+c];c++;var p=f>>4,v=15&f;if(15!=p&&d.push(p),15!=v&&d.push(v),15==v)break}for(var g="",m=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],y=0;y<d.length;y++)g+=m[d[y]];h=parseFloat(g)}s<=21&&(u=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][s],c=1,12==s&&(u=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][l],c=2)),null!=u?(o[u]=1==a.length?a[0]:a,a=[]):a.push(h),n+=c}return o},e.cmap={},e.cmap.parse=function(t,n,r){t=new Uint8Array(t.buffer,n,r),n=0;var i=e._bin,o={};i.readUshort(t,n),n+=2;var a=i.readUshort(t,n);n+=2;var s=[];o.tables=[];for(var l=0;l<a;l++){var c=i.readUshort(t,n);n+=2;var u=i.readUshort(t,n);n+=2;var h=i.readUint(t,n);n+=4;var d="p"+c+"e"+u,f=s.indexOf(h);if(-1==f){var p;f=o.tables.length,s.push(h);var v=i.readUshort(t,h);0==v?p=e.cmap.parse0(t,h):4==v?p=e.cmap.parse4(t,h):6==v?p=e.cmap.parse6(t,h):12==v?p=e.cmap.parse12(t,h):console.debug("unknown format: "+v,c,u,h),o.tables.push(p)}if(null!=o[d])throw"multiple tables for one platform+encoding";o[d]=f}return o},e.cmap.parse0=function(t,n){var r=e._bin,i={};i.format=r.readUshort(t,n),n+=2;var o=r.readUshort(t,n);n+=2,r.readUshort(t,n),n+=2,i.map=[];for(var a=0;a<o-6;a++)i.map.push(t[n+a]);return i},e.cmap.parse4=function(t,n){var r=e._bin,i=n,o={};o.format=r.readUshort(t,n),n+=2;var a=r.readUshort(t,n);n+=2,r.readUshort(t,n),n+=2;var s=r.readUshort(t,n);n+=2;var l=s/2;o.searchRange=r.readUshort(t,n),n+=2,o.entrySelector=r.readUshort(t,n),n+=2,o.rangeShift=r.readUshort(t,n),n+=2,o.endCount=r.readUshorts(t,n,l),n+=2*l,n+=2,o.startCount=r.readUshorts(t,n,l),n+=2*l,o.idDelta=[];for(var c=0;c<l;c++)o.idDelta.push(r.readShort(t,n)),n+=2;for(o.idRangeOffset=r.readUshorts(t,n,l),n+=2*l,o.glyphIdArray=[];n<i+a;)o.glyphIdArray.push(r.readUshort(t,n)),n+=2;return o},e.cmap.parse6=function(t,n){var r=e._bin,i={};i.format=r.readUshort(t,n),n+=2,r.readUshort(t,n),n+=2,r.readUshort(t,n),n+=2,i.firstCode=r.readUshort(t,n),n+=2;var o=r.readUshort(t,n);n+=2,i.glyphIdArray=[];for(var a=0;a<o;a++)i.glyphIdArray.push(r.readUshort(t,n)),n+=2;return i},e.cmap.parse12=function(t,n){var r=e._bin,i={};i.format=r.readUshort(t,n),n+=2,n+=2,r.readUint(t,n),n+=4,r.readUint(t,n),n+=4;var o=r.readUint(t,n);n+=4,i.groups=[];for(var a=0;a<o;a++){var s=n+12*a,l=r.readUint(t,s+0),c=r.readUint(t,s+4),u=r.readUint(t,s+8);i.groups.push([l,c,u])}return i},e.glyf={},e.glyf.parse=function(t,e,n,r){for(var i=[],o=0;o<r.maxp.numGlyphs;o++)i.push(null);return i},e.glyf._parseGlyf=function(t,n){var r=e._bin,i=t._data,o=e._tabOffset(i,"glyf",t._offset)+t.loca[n];if(t.loca[n]==t.loca[n+1])return null;var a={};if(a.noc=r.readShort(i,o),o+=2,a.xMin=r.readShort(i,o),o+=2,a.yMin=r.readShort(i,o),o+=2,a.xMax=r.readShort(i,o),o+=2,a.yMax=r.readShort(i,o),o+=2,a.xMin>=a.xMax||a.yMin>=a.yMax)return null;if(a.noc>0){a.endPts=[];for(var s=0;s<a.noc;s++)a.endPts.push(r.readUshort(i,o)),o+=2;var l=r.readUshort(i,o);if(o+=2,i.length-o<l)return null;a.instructions=r.readBytes(i,o,l),o+=l;var c=a.endPts[a.noc-1]+1;for(a.flags=[],s=0;s<c;s++){var u=i[o];if(o++,a.flags.push(u),0!=(8&u)){var h=i[o];o++;for(var d=0;d<h;d++)a.flags.push(u),s++}}for(a.xs=[],s=0;s<c;s++){var f=0!=(2&a.flags[s]),p=0!=(16&a.flags[s]);f?(a.xs.push(p?i[o]:-i[o]),o++):p?a.xs.push(0):(a.xs.push(r.readShort(i,o)),o+=2)}for(a.ys=[],s=0;s<c;s++)f=0!=(4&a.flags[s]),p=0!=(32&a.flags[s]),f?(a.ys.push(p?i[o]:-i[o]),o++):p?a.ys.push(0):(a.ys.push(r.readShort(i,o)),o+=2);var v=0,g=0;for(s=0;s<c;s++)v+=a.xs[s],g+=a.ys[s],a.xs[s]=v,a.ys[s]=g}else{var m;a.parts=[];do{m=r.readUshort(i,o),o+=2;var y={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(a.parts.push(y),y.glyphIndex=r.readUshort(i,o),o+=2,1&m){var _=r.readShort(i,o);o+=2;var x=r.readShort(i,o);o+=2}else _=r.readInt8(i,o),o++,x=r.readInt8(i,o),o++;2&m?(y.m.tx=_,y.m.ty=x):(y.p1=_,y.p2=x),8&m?(y.m.a=y.m.d=r.readF2dot14(i,o),o+=2):64&m?(y.m.a=r.readF2dot14(i,o),o+=2,y.m.d=r.readF2dot14(i,o),o+=2):128&m&&(y.m.a=r.readF2dot14(i,o),o+=2,y.m.b=r.readF2dot14(i,o),o+=2,y.m.c=r.readF2dot14(i,o),o+=2,y.m.d=r.readF2dot14(i,o),o+=2)}while(32&m);if(256&m){var b=r.readUshort(i,o);for(o+=2,a.instr=[],s=0;s<b;s++)a.instr.push(i[o]),o++}}return a},e.GDEF={},e.GDEF.parse=function(t,n,r,i){var o=n;n+=4;var a=e._bin.readUshort(t,n);return{glyphClassDef:0===a?null:e._lctf.readClassDef(t,o+a)}},e.GPOS={},e.GPOS.parse=function(t,n,r,i){return e._lctf.parse(t,n,r,i,e.GPOS.subt)},e.GPOS.subt=function(t,n,r,i){var o=e._bin,a=r,s={};if(s.fmt=o.readUshort(t,r),r+=2,1==n||2==n||3==n||7==n||8==n&&s.fmt<=2){var l=o.readUshort(t,r);r+=2,s.coverage=e._lctf.readCoverage(t,l+a)}if(1==n&&1==s.fmt){var c=o.readUshort(t,r);r+=2,0!=c&&(s.pos=e.GPOS.readValueRecord(t,r,c))}else if(2==n&&s.fmt>=1&&s.fmt<=2){c=o.readUshort(t,r),r+=2;var u=o.readUshort(t,r);r+=2;var h=e._lctf.numOfOnes(c),d=e._lctf.numOfOnes(u);if(1==s.fmt){s.pairsets=[];var f=o.readUshort(t,r);r+=2;for(var p=0;p<f;p++){var v=a+o.readUshort(t,r);r+=2;var g=o.readUshort(t,v);v+=2;for(var m=[],y=0;y<g;y++){var _=o.readUshort(t,v);v+=2,0!=c&&(U=e.GPOS.readValueRecord(t,v,c),v+=2*h),0!=u&&(M=e.GPOS.readValueRecord(t,v,u),v+=2*d),m.push({gid2:_,val1:U,val2:M})}s.pairsets.push(m)}}if(2==s.fmt){var x=o.readUshort(t,r);r+=2;var b=o.readUshort(t,r);r+=2;var w=o.readUshort(t,r);r+=2;var S=o.readUshort(t,r);for(r+=2,s.classDef1=e._lctf.readClassDef(t,a+x),s.classDef2=e._lctf.readClassDef(t,a+b),s.matrix=[],p=0;p<w;p++){var T=[];for(y=0;y<S;y++){var U=null,M=null;0!=c&&(U=e.GPOS.readValueRecord(t,r,c),r+=2*h),0!=u&&(M=e.GPOS.readValueRecord(t,r,u),r+=2*d),T.push({val1:U,val2:M})}s.matrix.push(T)}}}else if(4==n&&1==s.fmt)s.markCoverage=e._lctf.readCoverage(t,o.readUshort(t,r)+a),s.baseCoverage=e._lctf.readCoverage(t,o.readUshort(t,r+2)+a),s.markClassCount=o.readUshort(t,r+4),s.markArray=e.GPOS.readMarkArray(t,o.readUshort(t,r+6)+a),s.baseArray=e.GPOS.readBaseArray(t,o.readUshort(t,r+8)+a,s.markClassCount);else if(6==n&&1==s.fmt)s.mark1Coverage=e._lctf.readCoverage(t,o.readUshort(t,r)+a),s.mark2Coverage=e._lctf.readCoverage(t,o.readUshort(t,r+2)+a),s.markClassCount=o.readUshort(t,r+4),s.mark1Array=e.GPOS.readMarkArray(t,o.readUshort(t,r+6)+a),s.mark2Array=e.GPOS.readBaseArray(t,o.readUshort(t,r+8)+a,s.markClassCount);else{if(9==n&&1==s.fmt){var D=o.readUshort(t,r);r+=2;var A=o.readUint(t,r);if(r+=4,9==i.ltype)i.ltype=D;else if(i.ltype!=D)throw"invalid extension substitution";return e.GPOS.subt(t,i.ltype,a+A)}console.debug("unsupported GPOS table LookupType",n,"format",s.fmt)}return s},e.GPOS.readValueRecord=function(t,n,r){var i=e._bin,o=[];return o.push(1&r?i.readShort(t,n):0),n+=1&r?2:0,o.push(2&r?i.readShort(t,n):0),n+=2&r?2:0,o.push(4&r?i.readShort(t,n):0),n+=4&r?2:0,o.push(8&r?i.readShort(t,n):0),n+=8&r?2:0,o},e.GPOS.readBaseArray=function(t,n,r){var i=e._bin,o=[],a=n,s=i.readUshort(t,n);n+=2;for(var l=0;l<s;l++){for(var c=[],u=0;u<r;u++)c.push(e.GPOS.readAnchorRecord(t,a+i.readUshort(t,n))),n+=2;o.push(c)}return o},e.GPOS.readMarkArray=function(t,n){var r=e._bin,i=[],o=n,a=r.readUshort(t,n);n+=2;for(var s=0;s<a;s++){var l=e.GPOS.readAnchorRecord(t,r.readUshort(t,n+2)+o);l.markClass=r.readUshort(t,n),i.push(l),n+=4}return i},e.GPOS.readAnchorRecord=function(t,n){var r=e._bin,i={};return i.fmt=r.readUshort(t,n),i.x=r.readShort(t,n+2),i.y=r.readShort(t,n+4),i},e.GSUB={},e.GSUB.parse=function(t,n,r,i){return e._lctf.parse(t,n,r,i,e.GSUB.subt)},e.GSUB.subt=function(t,n,r,i){var o=e._bin,a=r,s={};if(s.fmt=o.readUshort(t,r),r+=2,1!=n&&2!=n&&4!=n&&5!=n&&6!=n)return null;if(1==n||2==n||4==n||5==n&&s.fmt<=2||6==n&&s.fmt<=2){var l=o.readUshort(t,r);r+=2,s.coverage=e._lctf.readCoverage(t,a+l)}if(1==n&&s.fmt>=1&&s.fmt<=2){if(1==s.fmt)s.delta=o.readShort(t,r),r+=2;else if(2==s.fmt){var c=o.readUshort(t,r);r+=2,s.newg=o.readUshorts(t,r,c),r+=2*s.newg.length}}else if(2==n&&1==s.fmt){c=o.readUshort(t,r),r+=2,s.seqs=[];for(var u=0;u<c;u++){var h=o.readUshort(t,r)+a;r+=2;var d=o.readUshort(t,h);s.seqs.push(o.readUshorts(t,h+2,d))}}else if(4==n)for(s.vals=[],c=o.readUshort(t,r),r+=2,u=0;u<c;u++){var f=o.readUshort(t,r);r+=2,s.vals.push(e.GSUB.readLigatureSet(t,a+f))}else if(5==n&&2==s.fmt){if(2==s.fmt){var p=o.readUshort(t,r);r+=2,s.cDef=e._lctf.readClassDef(t,a+p),s.scset=[];var v=o.readUshort(t,r);for(r+=2,u=0;u<v;u++){var g=o.readUshort(t,r);r+=2,s.scset.push(0==g?null:e.GSUB.readSubClassSet(t,a+g))}}}else if(6==n&&3==s.fmt){if(3==s.fmt){for(u=0;u<3;u++){c=o.readUshort(t,r),r+=2;for(var m=[],y=0;y<c;y++)m.push(e._lctf.readCoverage(t,a+o.readUshort(t,r+2*y)));r+=2*c,0==u&&(s.backCvg=m),1==u&&(s.inptCvg=m),2==u&&(s.ahedCvg=m)}c=o.readUshort(t,r),r+=2,s.lookupRec=e.GSUB.readSubstLookupRecords(t,r,c)}}else{if(7==n&&1==s.fmt){var _=o.readUshort(t,r);r+=2;var x=o.readUint(t,r);if(r+=4,9==i.ltype)i.ltype=_;else if(i.ltype!=_)throw"invalid extension substitution";return e.GSUB.subt(t,i.ltype,a+x)}console.debug("unsupported GSUB table LookupType",n,"format",s.fmt)}return s},e.GSUB.readSubClassSet=function(t,n){var r=e._bin.readUshort,i=n,o=[],a=r(t,n);n+=2;for(var s=0;s<a;s++){var l=r(t,n);n+=2,o.push(e.GSUB.readSubClassRule(t,i+l))}return o},e.GSUB.readSubClassRule=function(t,n){var r=e._bin.readUshort,i={},o=r(t,n),a=r(t,n+=2);n+=2,i.input=[];for(var s=0;s<o-1;s++)i.input.push(r(t,n)),n+=2;return i.substLookupRecords=e.GSUB.readSubstLookupRecords(t,n,a),i},e.GSUB.readSubstLookupRecords=function(t,n,r){for(var i=e._bin.readUshort,o=[],a=0;a<r;a++)o.push(i(t,n),i(t,n+2)),n+=4;return o},e.GSUB.readChainSubClassSet=function(t,n){var r=e._bin,i=n,o=[],a=r.readUshort(t,n);n+=2;for(var s=0;s<a;s++){var l=r.readUshort(t,n);n+=2,o.push(e.GSUB.readChainSubClassRule(t,i+l))}return o},e.GSUB.readChainSubClassRule=function(t,n){for(var r=e._bin,i={},o=["backtrack","input","lookahead"],a=0;a<o.length;a++){var s=r.readUshort(t,n);n+=2,1==a&&s--,i[o[a]]=r.readUshorts(t,n,s),n+=2*i[o[a]].length}return s=r.readUshort(t,n),n+=2,i.subst=r.readUshorts(t,n,2*s),n+=2*i.subst.length,i},e.GSUB.readLigatureSet=function(t,n){var r=e._bin,i=n,o=[],a=r.readUshort(t,n);n+=2;for(var s=0;s<a;s++){var l=r.readUshort(t,n);n+=2,o.push(e.GSUB.readLigature(t,i+l))}return o},e.GSUB.readLigature=function(t,n){var r=e._bin,i={chain:[]};i.nglyph=r.readUshort(t,n),n+=2;var o=r.readUshort(t,n);n+=2;for(var a=0;a<o-1;a++)i.chain.push(r.readUshort(t,n)),n+=2;return i},e.head={},e.head.parse=function(t,n,r){var i=e._bin,o={};return i.readFixed(t,n),n+=4,o.fontRevision=i.readFixed(t,n),n+=4,i.readUint(t,n),n+=4,i.readUint(t,n),n+=4,o.flags=i.readUshort(t,n),n+=2,o.unitsPerEm=i.readUshort(t,n),n+=2,o.created=i.readUint64(t,n),n+=8,o.modified=i.readUint64(t,n),n+=8,o.xMin=i.readShort(t,n),n+=2,o.yMin=i.readShort(t,n),n+=2,o.xMax=i.readShort(t,n),n+=2,o.yMax=i.readShort(t,n),n+=2,o.macStyle=i.readUshort(t,n),n+=2,o.lowestRecPPEM=i.readUshort(t,n),n+=2,o.fontDirectionHint=i.readShort(t,n),n+=2,o.indexToLocFormat=i.readShort(t,n),n+=2,o.glyphDataFormat=i.readShort(t,n),n+=2,o},e.hhea={},e.hhea.parse=function(t,n,r){var i=e._bin,o={};return i.readFixed(t,n),n+=4,o.ascender=i.readShort(t,n),n+=2,o.descender=i.readShort(t,n),n+=2,o.lineGap=i.readShort(t,n),n+=2,o.advanceWidthMax=i.readUshort(t,n),n+=2,o.minLeftSideBearing=i.readShort(t,n),n+=2,o.minRightSideBearing=i.readShort(t,n),n+=2,o.xMaxExtent=i.readShort(t,n),n+=2,o.caretSlopeRise=i.readShort(t,n),n+=2,o.caretSlopeRun=i.readShort(t,n),n+=2,o.caretOffset=i.readShort(t,n),n+=2,n+=8,o.metricDataFormat=i.readShort(t,n),n+=2,o.numberOfHMetrics=i.readUshort(t,n),n+=2,o},e.hmtx={},e.hmtx.parse=function(t,n,r,i){for(var o=e._bin,a={aWidth:[],lsBearing:[]},s=0,l=0,c=0;c<i.maxp.numGlyphs;c++)c<i.hhea.numberOfHMetrics&&(s=o.readUshort(t,n),n+=2,l=o.readShort(t,n),n+=2),a.aWidth.push(s),a.lsBearing.push(l);return a},e.kern={},e.kern.parse=function(t,n,r,i){var o=e._bin,a=o.readUshort(t,n);if(n+=2,1==a)return e.kern.parseV1(t,n-2,r,i);var s=o.readUshort(t,n);n+=2;for(var l={glyph1:[],rval:[]},c=0;c<s;c++){n+=2,r=o.readUshort(t,n),n+=2;var u=o.readUshort(t,n);n+=2;var h=u>>>8;if(0!=(h&=15))throw"unknown kern table format: "+h;n=e.kern.readFormat0(t,n,l)}return l},e.kern.parseV1=function(t,n,r,i){var o=e._bin;o.readFixed(t,n),n+=4;var a=o.readUint(t,n);n+=4;for(var s={glyph1:[],rval:[]},l=0;l<a;l++){o.readUint(t,n),n+=4;var c=o.readUshort(t,n);n+=2,o.readUshort(t,n),n+=2;var u=c>>>8;if(0!=(u&=15))throw"unknown kern table format: "+u;n=e.kern.readFormat0(t,n,s)}return s},e.kern.readFormat0=function(t,n,r){var i=e._bin,o=-1,a=i.readUshort(t,n);n+=2,i.readUshort(t,n),n+=2,i.readUshort(t,n),n+=2,i.readUshort(t,n),n+=2;for(var s=0;s<a;s++){var l=i.readUshort(t,n);n+=2;var c=i.readUshort(t,n);n+=2;var u=i.readShort(t,n);n+=2,l!=o&&(r.glyph1.push(l),r.rval.push({glyph2:[],vals:[]}));var h=r.rval[r.rval.length-1];h.glyph2.push(c),h.vals.push(u),o=l}return n},e.loca={},e.loca.parse=function(t,n,r,i){var o=e._bin,a=[],s=i.head.indexToLocFormat,l=i.maxp.numGlyphs+1;if(0==s)for(var c=0;c<l;c++)a.push(o.readUshort(t,n+(c<<1))<<1);if(1==s)for(c=0;c<l;c++)a.push(o.readUint(t,n+(c<<2)));return a},e.maxp={},e.maxp.parse=function(t,n,r){var i=e._bin,o={},a=i.readUint(t,n);return n+=4,o.numGlyphs=i.readUshort(t,n),n+=2,65536==a&&(o.maxPoints=i.readUshort(t,n),n+=2,o.maxContours=i.readUshort(t,n),n+=2,o.maxCompositePoints=i.readUshort(t,n),n+=2,o.maxCompositeContours=i.readUshort(t,n),n+=2,o.maxZones=i.readUshort(t,n),n+=2,o.maxTwilightPoints=i.readUshort(t,n),n+=2,o.maxStorage=i.readUshort(t,n),n+=2,o.maxFunctionDefs=i.readUshort(t,n),n+=2,o.maxInstructionDefs=i.readUshort(t,n),n+=2,o.maxStackElements=i.readUshort(t,n),n+=2,o.maxSizeOfInstructions=i.readUshort(t,n),n+=2,o.maxComponentElements=i.readUshort(t,n),n+=2,o.maxComponentDepth=i.readUshort(t,n),n+=2),o},e.name={},e.name.parse=function(t,n,r){var i=e._bin,o={};i.readUshort(t,n),n+=2;var a=i.readUshort(t,n);n+=2,i.readUshort(t,n);for(var s,l=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],c=n+=2,u=0;u<a;u++){var h=i.readUshort(t,n);n+=2;var d=i.readUshort(t,n);n+=2;var f=i.readUshort(t,n);n+=2;var p=i.readUshort(t,n);n+=2;var v=i.readUshort(t,n);n+=2;var g=i.readUshort(t,n);n+=2;var m,y=l[p],_=c+12*a+g;if(0==h)m=i.readUnicode(t,_,v/2);else if(3==h&&0==d)m=i.readUnicode(t,_,v/2);else if(0==d)m=i.readASCII(t,_,v);else if(1==d)m=i.readUnicode(t,_,v/2);else if(3==d)m=i.readUnicode(t,_,v/2);else{if(1!=h)throw"unknown encoding "+d+", platformID: "+h;m=i.readASCII(t,_,v),console.debug("reading unknown MAC encoding "+d+" as ASCII")}var x="p"+h+","+f.toString(16);null==o[x]&&(o[x]={}),o[x][void 0!==y?y:p]=m,o[x]._lang=f}for(var b in o)if(null!=o[b].postScriptName&&1033==o[b]._lang)return o[b];for(var b in o)if(null!=o[b].postScriptName&&0==o[b]._lang)return o[b];for(var b in o)if(null!=o[b].postScriptName&&3084==o[b]._lang)return o[b];for(var b in o)if(null!=o[b].postScriptName)return o[b];for(var b in o){s=b;break}return console.debug("returning name table with languageID "+o[s]._lang),o[s]},e["OS/2"]={},e["OS/2"].parse=function(t,n,r){var i=e._bin.readUshort(t,n);n+=2;var o={};if(0==i)e["OS/2"].version0(t,n,o);else if(1==i)e["OS/2"].version1(t,n,o);else if(2==i||3==i||4==i)e["OS/2"].version2(t,n,o);else{if(5!=i)throw"unknown OS/2 table version: "+i;e["OS/2"].version5(t,n,o)}return o},e["OS/2"].version0=function(t,n,r){var i=e._bin;return r.xAvgCharWidth=i.readShort(t,n),n+=2,r.usWeightClass=i.readUshort(t,n),n+=2,r.usWidthClass=i.readUshort(t,n),n+=2,r.fsType=i.readUshort(t,n),n+=2,r.ySubscriptXSize=i.readShort(t,n),n+=2,r.ySubscriptYSize=i.readShort(t,n),n+=2,r.ySubscriptXOffset=i.readShort(t,n),n+=2,r.ySubscriptYOffset=i.readShort(t,n),n+=2,r.ySuperscriptXSize=i.readShort(t,n),n+=2,r.ySuperscriptYSize=i.readShort(t,n),n+=2,r.ySuperscriptXOffset=i.readShort(t,n),n+=2,r.ySuperscriptYOffset=i.readShort(t,n),n+=2,r.yStrikeoutSize=i.readShort(t,n),n+=2,r.yStrikeoutPosition=i.readShort(t,n),n+=2,r.sFamilyClass=i.readShort(t,n),n+=2,r.panose=i.readBytes(t,n,10),n+=10,r.ulUnicodeRange1=i.readUint(t,n),n+=4,r.ulUnicodeRange2=i.readUint(t,n),n+=4,r.ulUnicodeRange3=i.readUint(t,n),n+=4,r.ulUnicodeRange4=i.readUint(t,n),n+=4,r.achVendID=[i.readInt8(t,n),i.readInt8(t,n+1),i.readInt8(t,n+2),i.readInt8(t,n+3)],n+=4,r.fsSelection=i.readUshort(t,n),n+=2,r.usFirstCharIndex=i.readUshort(t,n),n+=2,r.usLastCharIndex=i.readUshort(t,n),n+=2,r.sTypoAscender=i.readShort(t,n),n+=2,r.sTypoDescender=i.readShort(t,n),n+=2,r.sTypoLineGap=i.readShort(t,n),n+=2,r.usWinAscent=i.readUshort(t,n),n+=2,r.usWinDescent=i.readUshort(t,n),n+2},e["OS/2"].version1=function(t,n,r){var i=e._bin;return n=e["OS/2"].version0(t,n,r),r.ulCodePageRange1=i.readUint(t,n),n+=4,r.ulCodePageRange2=i.readUint(t,n),n+4},e["OS/2"].version2=function(t,n,r){var i=e._bin;return n=e["OS/2"].version1(t,n,r),r.sxHeight=i.readShort(t,n),n+=2,r.sCapHeight=i.readShort(t,n),n+=2,r.usDefault=i.readUshort(t,n),n+=2,r.usBreak=i.readUshort(t,n),n+=2,r.usMaxContext=i.readUshort(t,n),n+2},e["OS/2"].version5=function(t,n,r){var i=e._bin;return n=e["OS/2"].version2(t,n,r),r.usLowerOpticalPointSize=i.readUshort(t,n),n+=2,r.usUpperOpticalPointSize=i.readUshort(t,n),n+2},e.post={},e.post.parse=function(t,n,r){var i=e._bin,o={};return o.version=i.readFixed(t,n),n+=4,o.italicAngle=i.readFixed(t,n),n+=4,o.underlinePosition=i.readShort(t,n),n+=2,o.underlineThickness=i.readShort(t,n),n+=2,o},null==e&&(e={}),null==e.U&&(e.U={}),e.U.codeToGlyph=function(t,e){var n=t.cmap,r=-1;if(null!=n.p0e4?r=n.p0e4:null!=n.p3e1?r=n.p3e1:null!=n.p1e0?r=n.p1e0:null!=n.p0e3&&(r=n.p0e3),-1==r)throw"no familiar platform and encoding!";var i=n.tables[r];if(0==i.format)return e>=i.map.length?0:i.map[e];if(4==i.format){for(var o=-1,a=0;a<i.endCount.length;a++)if(e<=i.endCount[a]){o=a;break}return-1==o||i.startCount[o]>e?0:65535&(0!=i.idRangeOffset[o]?i.glyphIdArray[e-i.startCount[o]+(i.idRangeOffset[o]>>1)-(i.idRangeOffset.length-o)]:e+i.idDelta[o])}if(12==i.format){if(e>i.groups[i.groups.length-1][1])return 0;for(a=0;a<i.groups.length;a++){var s=i.groups[a];if(s[0]<=e&&e<=s[1])return s[2]+(e-s[0])}return 0}throw"unknown cmap table format "+i.format},e.U.glyphToPath=function(t,n){var r={cmds:[],crds:[]};if(t.SVG&&t.SVG.entries[n]){var i=t.SVG.entries[n];return null==i?r:("string"==typeof i&&(i=e.SVG.toPath(i),t.SVG.entries[n]=i),i)}if(t.CFF){var o={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:t.CFF.Private?t.CFF.Private.defaultWidthX:0,open:!1},a=t.CFF,s=t.CFF.Private;if(a.ROS){for(var l=0;a.FDSelect[l+2]<=n;)l+=2;s=a.FDArray[a.FDSelect[l+1]].Private}e.U._drawCFF(t.CFF.CharStrings[n],o,a,s,r)}else t.glyf&&e.U._drawGlyf(n,t,r);return r},e.U._drawGlyf=function(t,n,r){var i=n.glyf[t];null==i&&(i=n.glyf[t]=e.glyf._parseGlyf(n,t)),null!=i&&(i.noc>-1?e.U._simpleGlyph(i,r):e.U._compoGlyph(i,n,r))},e.U._simpleGlyph=function(t,n){for(var r=0;r<t.noc;r++){for(var i=0==r?0:t.endPts[r-1]+1,o=t.endPts[r],a=i;a<=o;a++){var s=a==i?o:a-1,l=a==o?i:a+1,c=1&t.flags[a],u=1&t.flags[s],h=1&t.flags[l],d=t.xs[a],f=t.ys[a];if(a==i)if(c){if(!u){e.U.P.moveTo(n,d,f);continue}e.U.P.moveTo(n,t.xs[s],t.ys[s])}else u?e.U.P.moveTo(n,t.xs[s],t.ys[s]):e.U.P.moveTo(n,(t.xs[s]+d)/2,(t.ys[s]+f)/2);c?u&&e.U.P.lineTo(n,d,f):h?e.U.P.qcurveTo(n,d,f,t.xs[l],t.ys[l]):e.U.P.qcurveTo(n,d,f,(d+t.xs[l])/2,(f+t.ys[l])/2)}e.U.P.closePath(n)}},e.U._compoGlyph=function(t,n,r){for(var i=0;i<t.parts.length;i++){var o={cmds:[],crds:[]},a=t.parts[i];e.U._drawGlyf(a.glyphIndex,n,o);for(var s=a.m,l=0;l<o.crds.length;l+=2){var c=o.crds[l],u=o.crds[l+1];r.crds.push(c*s.a+u*s.b+s.tx),r.crds.push(c*s.c+u*s.d+s.ty)}for(l=0;l<o.cmds.length;l++)r.cmds.push(o.cmds[l])}},e.U._getGlyphClass=function(t,n){var r=e._lctf.getInterval(n,t);return-1==r?0:n[r+2]},e.U._applySubs=function(t,n,r,i){for(var o=t.length-n-1,a=0;a<r.tabs.length;a++)if(null!=r.tabs[a]){var s,l=r.tabs[a];if(!l.coverage||-1!=(s=e._lctf.coverageIndex(l.coverage,t[n])))if(1==r.ltype)t[n],1==l.fmt?t[n]=t[n]+l.delta:t[n]=l.newg[s];else if(4==r.ltype)for(var c=l.vals[s],u=0;u<c.length;u++){var h=c[u],d=h.chain.length;if(!(d>o)){for(var f=!0,p=0,v=0;v<d;v++){for(;-1==t[n+p+(1+v)];)p++;h.chain[v]!=t[n+p+(1+v)]&&(f=!1)}if(f){for(t[n]=h.nglyph,v=0;v<d+p;v++)t[n+v+1]=-1;break}}}else if(5==r.ltype&&2==l.fmt)for(var g=e._lctf.getInterval(l.cDef,t[n]),m=l.cDef[g+2],y=l.scset[m],_=0;_<y.length;_++){var x=y[_],b=x.input;if(!(b.length>o)){for(f=!0,v=0;v<b.length;v++){var w=e._lctf.getInterval(l.cDef,t[n+1+v]);if(-1==g&&l.cDef[w+2]!=b[v]){f=!1;break}}if(f){var S=x.substLookupRecords;for(u=0;u<S.length;u+=2)S[u],S[u+1]}}}else if(6==r.ltype&&3==l.fmt){if(!e.U._glsCovered(t,l.backCvg,n-l.backCvg.length))continue;if(!e.U._glsCovered(t,l.inptCvg,n))continue;if(!e.U._glsCovered(t,l.ahedCvg,n+l.inptCvg.length))continue;var T=l.lookupRec;for(_=0;_<T.length;_+=2){g=T[_];var U=i[T[_+1]];e.U._applySubs(t,n+g,U,i)}}}},e.U._glsCovered=function(t,n,r){for(var i=0;i<n.length;i++)if(-1==e._lctf.coverageIndex(n[i],t[r+i]))return!1;return!0},e.U.glyphsToPath=function(t,n,r){for(var i={cmds:[],crds:[]},o=0,a=0;a<n.length;a++){var s=n[a];if(-1!=s){for(var l=a<n.length-1&&-1!=n[a+1]?n[a+1]:0,c=e.U.glyphToPath(t,s),u=0;u<c.crds.length;u+=2)i.crds.push(c.crds[u]+o),i.crds.push(c.crds[u+1]);for(r&&i.cmds.push(r),u=0;u<c.cmds.length;u++)i.cmds.push(c.cmds[u]);r&&i.cmds.push("X"),o+=t.hmtx.aWidth[s],a<n.length-1&&(o+=e.U.getPairAdjustment(t,s,l))}}return i},e.U.P={},e.U.P.moveTo=function(t,e,n){t.cmds.push("M"),t.crds.push(e,n)},e.U.P.lineTo=function(t,e,n){t.cmds.push("L"),t.crds.push(e,n)},e.U.P.curveTo=function(t,e,n,r,i,o,a){t.cmds.push("C"),t.crds.push(e,n,r,i,o,a)},e.U.P.qcurveTo=function(t,e,n,r,i){t.cmds.push("Q"),t.crds.push(e,n,r,i)},e.U.P.closePath=function(t){t.cmds.push("Z")},e.U._drawCFF=function(t,n,r,i,o){for(var a=n.stack,s=n.nStems,l=n.haveWidth,c=n.width,u=n.open,h=0,d=n.x,f=n.y,p=0,v=0,g=0,m=0,y=0,_=0,x=0,b=0,w=0,S=0,T={val:0,size:0};h<t.length;){e.CFF.getCharString(t,h,T);var U=T.val;if(h+=T.size,"o1"==U||"o18"==U)a.length%2!=0&&!l&&(c=a.shift()+i.nominalWidthX),s+=a.length>>1,a.length=0,l=!0;else if("o3"==U||"o23"==U)a.length%2!=0&&!l&&(c=a.shift()+i.nominalWidthX),s+=a.length>>1,a.length=0,l=!0;else if("o4"==U)a.length>1&&!l&&(c=a.shift()+i.nominalWidthX,l=!0),u&&e.U.P.closePath(o),f+=a.pop(),e.U.P.moveTo(o,d,f),u=!0;else if("o5"==U)for(;a.length>0;)d+=a.shift(),f+=a.shift(),e.U.P.lineTo(o,d,f);else if("o6"==U||"o7"==U)for(var M=a.length,D="o6"==U,A=0;A<M;A++){var C=a.shift();D?d+=C:f+=C,D=!D,e.U.P.lineTo(o,d,f)}else if("o8"==U||"o24"==U){M=a.length;for(var P=0;P+6<=M;)p=d+a.shift(),v=f+a.shift(),g=p+a.shift(),m=v+a.shift(),d=g+a.shift(),f=m+a.shift(),e.U.P.curveTo(o,p,v,g,m,d,f),P+=6;"o24"==U&&(d+=a.shift(),f+=a.shift(),e.U.P.lineTo(o,d,f))}else{if("o11"==U)break;if("o1234"==U||"o1235"==U||"o1236"==U||"o1237"==U)"o1234"==U&&(v=f,g=(p=d+a.shift())+a.shift(),S=m=v+a.shift(),_=m,b=f,d=(x=(y=(w=g+a.shift())+a.shift())+a.shift())+a.shift(),e.U.P.curveTo(o,p,v,g,m,w,S),e.U.P.curveTo(o,y,_,x,b,d,f)),"o1235"==U&&(p=d+a.shift(),v=f+a.shift(),g=p+a.shift(),m=v+a.shift(),w=g+a.shift(),S=m+a.shift(),y=w+a.shift(),_=S+a.shift(),x=y+a.shift(),b=_+a.shift(),d=x+a.shift(),f=b+a.shift(),a.shift(),e.U.P.curveTo(o,p,v,g,m,w,S),e.U.P.curveTo(o,y,_,x,b,d,f)),"o1236"==U&&(p=d+a.shift(),v=f+a.shift(),g=p+a.shift(),S=m=v+a.shift(),_=m,x=(y=(w=g+a.shift())+a.shift())+a.shift(),b=_+a.shift(),d=x+a.shift(),e.U.P.curveTo(o,p,v,g,m,w,S),e.U.P.curveTo(o,y,_,x,b,d,f)),"o1237"==U&&(p=d+a.shift(),v=f+a.shift(),g=p+a.shift(),m=v+a.shift(),w=g+a.shift(),S=m+a.shift(),y=w+a.shift(),_=S+a.shift(),x=y+a.shift(),b=_+a.shift(),Math.abs(x-d)>Math.abs(b-f)?d=x+a.shift():f=b+a.shift(),e.U.P.curveTo(o,p,v,g,m,w,S),e.U.P.curveTo(o,y,_,x,b,d,f));else if("o14"==U){if(a.length>0&&!l&&(c=a.shift()+r.nominalWidthX,l=!0),4==a.length){var B=a.shift(),k=a.shift(),F=a.shift(),I=a.shift(),E=e.CFF.glyphBySE(r,F),R=e.CFF.glyphBySE(r,I);e.U._drawCFF(r.CharStrings[E],n,r,i,o),n.x=B,n.y=k,e.U._drawCFF(r.CharStrings[R],n,r,i,o)}u&&(e.U.P.closePath(o),u=!1)}else if("o19"==U||"o20"==U)a.length%2!=0&&!l&&(c=a.shift()+i.nominalWidthX),s+=a.length>>1,a.length=0,l=!0,h+=s+7>>3;else if("o21"==U)a.length>2&&!l&&(c=a.shift()+i.nominalWidthX,l=!0),f+=a.pop(),d+=a.pop(),u&&e.U.P.closePath(o),e.U.P.moveTo(o,d,f),u=!0;else if("o22"==U)a.length>1&&!l&&(c=a.shift()+i.nominalWidthX,l=!0),d+=a.pop(),u&&e.U.P.closePath(o),e.U.P.moveTo(o,d,f),u=!0;else if("o25"==U){for(;a.length>6;)d+=a.shift(),f+=a.shift(),e.U.P.lineTo(o,d,f);p=d+a.shift(),v=f+a.shift(),g=p+a.shift(),m=v+a.shift(),d=g+a.shift(),f=m+a.shift(),e.U.P.curveTo(o,p,v,g,m,d,f)}else if("o26"==U)for(a.length%2&&(d+=a.shift());a.length>0;)p=d,v=f+a.shift(),d=g=p+a.shift(),f=(m=v+a.shift())+a.shift(),e.U.P.curveTo(o,p,v,g,m,d,f);else if("o27"==U)for(a.length%2&&(f+=a.shift());a.length>0;)v=f,g=(p=d+a.shift())+a.shift(),m=v+a.shift(),d=g+a.shift(),f=m,e.U.P.curveTo(o,p,v,g,m,d,f);else if("o10"==U||"o29"==U){var O="o10"==U?i:r;if(0==a.length)console.debug("error: empty stack");else{var G=a.pop(),z=O.Subrs[G+O.Bias];n.x=d,n.y=f,n.nStems=s,n.haveWidth=l,n.width=c,n.open=u,e.U._drawCFF(z,n,r,i,o),d=n.x,f=n.y,s=n.nStems,l=n.haveWidth,c=n.width,u=n.open}}else if("o30"==U||"o31"==U){var L=a.length,N=(P=0,"o31"==U);for(P+=L-(M=-3&L);P<M;)N?(v=f,g=(p=d+a.shift())+a.shift(),f=(m=v+a.shift())+a.shift(),M-P==5?(d=g+a.shift(),P++):d=g,N=!1):(p=d,v=f+a.shift(),g=p+a.shift(),m=v+a.shift(),d=g+a.shift(),M-P==5?(f=m+a.shift(),P++):f=m,N=!0),e.U.P.curveTo(o,p,v,g,m,d,f),P+=4}else{if("o"==(U+"").charAt(0))throw console.debug("Unknown operation: "+U,t),U;a.push(U)}}}n.x=d,n.y=f,n.nStems=s,n.haveWidth=l,n.width=c,n.open=u};var n=e,r={Typr:n};return t.Typr=n,t.default=r,Object.defineProperty(t,"__esModule",{value:!0}),t}({}).Typr
/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/},function(){return function(t){var e=Uint8Array,n=Uint16Array,r=Uint32Array,i=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),o=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),a=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),s=function(t,e){for(var i=new n(31),o=0;o<31;++o)i[o]=e+=1<<t[o-1];var a=new r(i[30]);for(o=1;o<30;++o)for(var s=i[o];s<i[o+1];++s)a[s]=s-i[o]<<5|o;return[i,a]},l=s(i,2),c=l[0],u=l[1];c[28]=258,u[258]=28;for(var h=s(o,0)[0],d=new n(32768),f=0;f<32768;++f){var p=(43690&f)>>>1|(21845&f)<<1;p=(61680&(p=(52428&p)>>>2|(13107&p)<<2))>>>4|(3855&p)<<4,d[f]=((65280&p)>>>8|(255&p)<<8)>>>1}var v=function(t,e,r){for(var i=t.length,o=0,a=new n(e);o<i;++o)++a[t[o]-1];var s,l=new n(e);for(o=0;o<e;++o)l[o]=l[o-1]+a[o-1]<<1;if(r){s=new n(1<<e);var c=15-e;for(o=0;o<i;++o)if(t[o])for(var u=o<<4|t[o],h=e-t[o],f=l[t[o]-1]++<<h,p=f|(1<<h)-1;f<=p;++f)s[d[f]>>>c]=u}else for(s=new n(i),o=0;o<i;++o)t[o]&&(s[o]=d[l[t[o]-1]++]>>>15-t[o]);return s},g=new e(288);for(f=0;f<144;++f)g[f]=8;for(f=144;f<256;++f)g[f]=9;for(f=256;f<280;++f)g[f]=7;for(f=280;f<288;++f)g[f]=8;var m=new e(32);for(f=0;f<32;++f)m[f]=5;var y=v(g,9,1),_=v(m,5,1),x=function(t){for(var e=t[0],n=1;n<t.length;++n)t[n]>e&&(e=t[n]);return e},b=function(t,e,n){var r=e/8|0;return(t[r]|t[r+1]<<8)>>(7&e)&n},w=function(t,e){var n=e/8|0;return(t[n]|t[n+1]<<8|t[n+2]<<16)>>(7&e)},S=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(t,e,n){var r=new Error(e||S[t]);if(r.code=t,Error.captureStackTrace&&Error.captureStackTrace(r,T),!n)throw r;return r},U=function(t,s,l){var u=t.length;if(!u||l&&!l.l&&u<5)return s||new e(0);var d=!s||l,f=!l||l.i;l||(l={}),s||(s=new e(3*u));var p,g=function(t){var n=s.length;if(t>n){var r=new e(Math.max(2*n,t));r.set(s),s=r}},m=l.f||0,S=l.p||0,U=l.b||0,M=l.l,D=l.d,A=l.m,C=l.n,P=8*u;do{if(!M){l.f=m=b(t,S,1);var B=b(t,S+1,3);if(S+=3,!B){var k=t[(W=((p=S)/8|0)+(7&p&&1)+4)-4]|t[W-3]<<8,F=W+k;if(F>u){f&&T(0);break}d&&g(U+k),s.set(t.subarray(W,F),U),l.b=U+=k,l.p=S=8*F;continue}if(1==B)M=y,D=_,A=9,C=5;else if(2==B){var I=b(t,S,31)+257,E=b(t,S+10,15)+4,R=I+b(t,S+5,31)+1;S+=14;for(var O=new e(R),G=new e(19),z=0;z<E;++z)G[a[z]]=b(t,S+3*z,7);S+=3*E;var L=x(G),N=(1<<L)-1,j=v(G,L,1);for(z=0;z<R;){var W,H=j[b(t,S,N)];if(S+=15&H,(W=H>>>4)<16)O[z++]=W;else{var V=0,q=0;for(16==W?(q=3+b(t,S,3),S+=2,V=O[z-1]):17==W?(q=3+b(t,S,7),S+=3):18==W&&(q=11+b(t,S,127),S+=7);q--;)O[z++]=V}}var X=O.subarray(0,I),Y=O.subarray(I);A=x(X),C=x(Y),M=v(X,A,1),D=v(Y,C,1)}else T(1);if(S>P){f&&T(0);break}}d&&g(U+131072);for(var $=(1<<A)-1,Z=(1<<C)-1,K=S;;K=S){var Q=(V=M[w(t,S)&$])>>>4;if((S+=15&V)>P){f&&T(0);break}if(V||T(2),Q<256)s[U++]=Q;else{if(256==Q){K=S,M=null;break}var J=Q-254;if(Q>264){var tt=i[z=Q-257];J=b(t,S,(1<<tt)-1)+c[z],S+=tt}var et=D[w(t,S)&Z],nt=et>>>4;if(et||T(3),S+=15&et,Y=h[nt],nt>3&&(tt=o[nt],Y+=w(t,S)&(1<<tt)-1,S+=tt),S>P){f&&T(0);break}d&&g(U+131072);for(var rt=U+J;U<rt;U+=4)s[U]=s[U-Y],s[U+1]=s[U+1-Y],s[U+2]=s[U+2-Y],s[U+3]=s[U+3-Y];U=rt}}l.l=M,l.p=K,l.b=U,M&&(m=1,l.m=A,l.d=D,l.n=C)}while(!m);return U==s.length?s:function(t,i,o){(null==i||i<0)&&(i=0),(null==o||o>t.length)&&(o=t.length);var a=new(t instanceof n?n:t instanceof r?r:e)(o-i);return a.set(t.subarray(i,o)),a}(s,0,U)},M=new e(0),D="undefined"!=typeof TextDecoder&&new TextDecoder;try{D.decode(M,{stream:!0})}catch(t){}return t.convert_streams=function(t){var e=new DataView(t),n=0;function r(){var t=e.getUint16(n);return n+=2,t}function i(){var t=e.getUint32(n);return n+=4,t}function o(t){m.setUint16(y,t),y+=2}function a(t){m.setUint32(y,t),y+=4}for(var s={signature:i(),flavor:i(),length:i(),numTables:r(),reserved:r(),totalSfntSize:i(),majorVersion:r(),minorVersion:r(),metaOffset:i(),metaLength:i(),metaOrigLength:i(),privOffset:i(),privLength:i()},l=0;Math.pow(2,l)<=s.numTables;)l++;l--;for(var c=16*Math.pow(2,l),u=16*s.numTables-c,h=12,d=[],f=0;f<s.numTables;f++)d.push({tag:i(),offset:i(),compLength:i(),origLength:i(),origChecksum:i()}),h+=16;var p,v=new Uint8Array(12+16*d.length+d.reduce((function(t,e){return t+e.origLength+4}),0)),g=v.buffer,m=new DataView(g),y=0;return a(s.flavor),o(s.numTables),o(c),o(l),o(u),d.forEach((function(t){a(t.tag),a(t.origChecksum),a(h),a(t.origLength),t.outOffset=h,(h+=t.origLength)%4!=0&&(h+=4-h%4)})),d.forEach((function(e){var n,r=t.slice(e.offset,e.offset+e.compLength);if(e.compLength!=e.origLength){var i=new Uint8Array(e.origLength);n=new Uint8Array(r,2),U(n,i)}else i=new Uint8Array(r);v.set(i,e.outOffset);var o=0;(h=e.outOffset+e.origLength)%4!=0&&(o=4-h%4),v.set(new Uint8Array(o).buffer,e.outOffset+e.origLength),p=h+o})),g.slice(0,p)},Object.defineProperty(t,"__esModule",{value:!0}),t}({}).convert_streams},function(t,e){const n={M:2,L:2,Q:4,C:6,Z:0},r={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},i=1,o=2,a=4,s=8,l=16,c=32;let u;function h(t){if(!u){const t={R:o,L:i,D:a,C:l,U:c,T:s};u=new Map;for(let e in r){let n=0;r[e].split(",").forEach((r=>{let[i,o]=r.split("+");i=parseInt(i,36),o=o?parseInt(o,36):0,u.set(n+=i,t[e]);for(let r=o;r--;)u.set(++n,t[e])}))}}return u.get(t)||c}const d=[null,"isol","init","fina","medi"];function f(t){const e=new Uint8Array(t.length);let n=c,r=1,u=-1;for(let d=0;d<t.length;d++){const f=t.codePointAt(d);let p=0|h(f),v=1;p&s||(n&(i|a|l)?p&(o|a|l)?(v=3,1!==r&&3!==r||e[u]++):p&(i|c)&&(2!==r&&4!==r||e[u]--):n&(o|c)&&(2!==r&&4!==r||e[u]--),r=e[d]=v,n=p,u=d,f>65535&&d++)}return e}function p(e,n){const r=e.GDEF&&e.GDEF.glyphClassDef;return r?t.U._getGlyphClass(n,r):0}function v(...t){for(let e=0;e<t.length;e++)if("number"==typeof t[e])return t[e]}return function(r){const i=new Uint8Array(r,0,4),o=t._bin.readASCII(i,0,4);if("wOFF"===o)r=e(r);else if("wOF2"===o)throw new Error("woff2 fonts not supported");return function(e){const r=Object.create(null),i=e["OS/2"],o=e.hhea,a=e.head.unitsPerEm,s=v(i&&i.sTypoAscender,o&&o.ascender,a),l={unitsPerEm:a,ascender:s,descender:v(i&&i.sTypoDescender,o&&o.descender,0),capHeight:v(i&&i.sCapHeight,s),xHeight:v(i&&i.sxHeight,s),lineGap:v(i&&i.sTypoLineGap,o&&o.lineGap),supportsCodePoint:n=>t.U.codeToGlyph(e,n)>0,forEachGlyph(i,o,a,s){let c=0;const u=1/l.unitsPerEm*o,h=function(e,n){const r=[];for(let i=0;i<n.length;i++){const o=n.codePointAt(i);o>65535&&i++,r.push(t.U.codeToGlyph(e,o))}const i=e.GSUB;if(i){const{lookupList:e,featureList:o}=i;let a;const s=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,l=[];o.forEach((i=>{if(s.test(i.tag))for(let o=0;o<i.tab.length;o++){if(l[i.tab[o]])continue;l[i.tab[o]]=!0;const s=e[i.tab[o]],c=/^(isol|init|fina|medi)$/.test(i.tag);c&&!a&&(a=f(n));for(let n=0;n<r.length;n++)a&&c&&d[a[n]]!==i.tag||t.U._applySubs(r,n,s,e)}}))}return r}(e,i);let v=0;const g=function(e,n){const r=new Int16Array(3*n.length);let i=0;for(;i<n.length;i++){const l=n[i];if(-1===l)continue;r[3*i+2]=e.hmtx.aWidth[l];const c=e.GPOS;if(c){const u=c.lookupList;for(let c=0;c<u.length;c++){const h=u[c];for(let c=0;c<h.tabs.length;c++){const u=h.tabs[c];if(1===h.ltype){if(-1!==t._lctf.coverageIndex(u.coverage,l)&&u.pos){s(u.pos,i);break}}else if(2===h.ltype){let e=null,r=o();if(-1!==r){const o=t._lctf.coverageIndex(u.coverage,n[r]);if(-1!==o){if(1===u.fmt){const t=u.pairsets[o];for(let n=0;n<t.length;n++)t[n].gid2===l&&(e=t[n])}else if(2===u.fmt){const i=t.U._getGlyphClass(n[r],u.classDef1),o=t.U._getGlyphClass(l,u.classDef2);e=u.matrix[i][o]}if(e){e.val1&&s(e.val1,r),e.val2&&s(e.val2,i);break}}}}else if(4===h.ltype){const e=t._lctf.coverageIndex(u.markCoverage,l);if(-1!==e){const s=o(a),l=-1===s?-1:t._lctf.coverageIndex(u.baseCoverage,n[s]);if(-1!==l){const t=u.markArray[e],n=u.baseArray[l][t.markClass];r[3*i]=n.x-t.x+r[3*s]-r[3*s+2],r[3*i+1]=n.y-t.y+r[3*s+1];break}}}else if(6===h.ltype){const a=t._lctf.coverageIndex(u.mark1Coverage,l);if(-1!==a){const s=o();if(-1!==s){const o=n[s];if(3===p(e,o)){const e=t._lctf.coverageIndex(u.mark2Coverage,o);if(-1!==e){const t=u.mark1Array[a],n=u.mark2Array[e][t.markClass];r[3*i]=n.x-t.x+r[3*s]-r[3*s+2],r[3*i+1]=n.y-t.y+r[3*s+1];break}}}}}}}}else if(e.kern&&!e.cff){const t=o();if(-1!==t){const i=e.kern.glyph1.indexOf(n[t]);if(-1!==i){const n=e.kern.rval[i].glyph2.indexOf(l);-1!==n&&(r[3*t+2]+=e.kern.rval[i].vals[n])}}}}return r;function o(t){for(let e=i-1;e>=0;e--)if(-1!==n[e]&&(!t||t(n[e])))return e;return-1}function a(t){return 1===p(e,t)}function s(t,e){for(let n=0;n<3;n++)r[3*e+n]+=t[n]||0}}(e,h);return h.forEach(((l,h)=>{if(-1!==l){let i=r[l];if(!i){const{cmds:o,crds:a}=t.U.glyphToPath(e,l);let s,c,u,h,d="",f=0;for(let t=0,e=o.length;t<e;t++){const e=n[o[t]];d+=o[t];for(let t=1;t<=e;t++)d+=(t>1?",":"")+a[f++]}if(a.length){s=c=1/0,u=h=-1/0;for(let t=0,e=a.length;t<e;t+=2){let e=a[t],n=a[t+1];e<s&&(s=e),n<c&&(c=n),e>u&&(u=e),n>h&&(h=n)}}else s=u=c=h=0;i=r[l]={index:l,advanceWidth:e.hmtx.aWidth[l],xMin:s,yMin:c,xMax:u,yMax:h,path:d}}s.call(null,i,c+g[3*h]*u,g[3*h+1]*u,v),c+=g[3*h+2]*u,a&&(c+=a*o)}v+=i.codePointAt(v)>65535?2:1})),c}};return l}(t.parse(r)[0])}}],init:(t,e,n)=>n(t(),e())}),
/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/
function(){return function(t){var e=function(){this.buckets=new Map};e.prototype.add=function(t){var e=t>>5;this.buckets.set(e,(this.buckets.get(e)||0)|1<<(31&t))},e.prototype.has=function(t){var e=this.buckets.get(t>>5);return void 0!==e&&0!=(e&1<<(31&t))},e.prototype.serialize=function(){var t=[];return this.buckets.forEach((function(e,n){t.push((+n).toString(36)+":"+e.toString(36))})),t.join(",")},e.prototype.deserialize=function(t){var e=this;this.buckets.clear(),t.split(",").forEach((function(t){var n=t.split(":");e.buckets.set(parseInt(n[0],36),parseInt(n[1],36))}))};var n=Math.pow(2,8),r=n-1,i=~r;function o(t){var e=function(t){return t&i}(t).toString(16),r=function(t){return(t&i)+n-1}(t).toString(16);return"codepoint-index/plane"+(t>>16)+"/"+e+"-"+r+".json"}function a(t,e){var n=t&r,i=e.codePointAt(n/6|0);return 0!=((i=(i||48)-48)&1<<n%6)}function s(t,e){!function(t,e){var n;(n=t,n.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(t){return t.split("-").map((function(t){return parseInt(t.trim(),16)}))}))).forEach((function(t){var n=t[0],r=t[1];void 0===r&&(r=n),e(n,r)}))}(t,(function(t,n){for(var r=t;r<=n;r++)e(r)}))}var l={},c={},u=new WeakMap,h="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(t){var n=u.get(t);return n||(n=new e,s(t.ranges,(function(t){return n.add(t)})),u.set(t,n)),n}var f,p=new Map;function v(t,e,n){return t[e]?e:t[n]?n:function(t){for(var e in t)return e}(t)}function g(t,e){var n=e;if(!t.includes(n)){n=1/0;for(var r=0;r<t.length;r++)Math.abs(t[r]-e)<Math.abs(n-e)&&(n=t[r])}return n}function m(t){return f||(f=new Set,s("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(t){f.add(t)}))),f.has(t)}return t.CodePointSet=e,t.clearCache=function(){l={},c={}},t.getFontsForString=function(t,e){void 0===e&&(e={});var n,r=e.lang;void 0===r&&(r=/\p{Script=Hangul}/u.test(n=t)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(n)?"ja":"en");var i=e.category;void 0===i&&(i="sans-serif");var s=e.style;void 0===s&&(s="normal");var u=e.weight;void 0===u&&(u=400);var f=(e.dataUrl||h).replace(/\/$/g,""),y=new Map,_=new Uint8Array(t.length),x={},b={},w=new Array(t.length),S=new Map,T=!1;function U(t){var e=p.get(t);return e||(e=fetch(f+"/"+t).then((function(t){if(!t.ok)throw new Error(t.statusText);return t.json().then((function(t){if(!Array.isArray(t)||1!==t[0])throw new Error("Incorrect schema version; need 1, got "+t[0]);return t[1]}))})).catch((function(e){if(f!==h)return T||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+f+'", trying default CDN. '+e.message),T=!0),f=h,p.delete(t),U(t);throw e})),p.set(t,e)),e}for(var M=function(e){var n=t.codePointAt(e),r=o(n);w[e]=r,l[r]||S.has(r)||S.set(r,U(r).then((function(t){l[r]=t}))),n>65535&&(e++,D=e)},D=0;D<t.length;D++)M(D);return Promise.all(S.values()).then((function(){S.clear();for(var e=function(e){var i=t.codePointAt(e),o=null,s=l[w[e]],u=void 0;for(var h in s){var d=b[h];if(void 0===d&&(d=b[h]=new RegExp(h).test(r||"en")),d){for(var f in u=h,s[h])if(a(i,s[h][f])){o=f;break}break}}if(!o)t:for(var p in s)if(p!==u)for(var v in s[p])if(a(i,s[p][v])){o=v;break t}o||(console.debug("No font coverage for U+"+i.toString(16)),o="latin"),w[e]=o,c[o]||S.has(o)||S.set(o,U("font-meta/"+o+".json").then((function(t){c[o]=t}))),i>65535&&(e++,n=e)},n=0;n<t.length;n++)e(n);return Promise.all(S.values())})).then((function(){for(var e,n=null,r=0;r<t.length;r++){var o=t.codePointAt(r);if(n&&(m(o)||d(n).has(o)))_[r]=_[r-1];else{n=c[w[r]];var a=x[n.id];if(!a){var l=n.typeforms,h=v(l,i,"sans-serif"),p=v(l[h],s,"normal"),b=g(null===(e=l[h])||void 0===e?void 0:e[p],u);a=x[n.id]=f+"/font-files/"+n.id+"/"+h+"."+p+"."+b+".woff"}var S=y.get(a);null==S&&(S=y.size,y.set(a,S)),_[r]=S}o>65535&&(r++,_[r]=_[r-1])}return{fontUrls:Array.from(y.keys()),chars:_}}))},Object.defineProperty(t,"__esModule",{value:!0}),t}({})}],init:(t,e,n)=>t(e,n())}),be=()=>(self.performance||Date).now(),we=ae();let Se;const Te=[];let Ue=0;function Me(){const t=be();for(;Te.length&&be()-t<5;)Te.shift()();Ue=Te.length?setTimeout(Me,0):0}const De=4,Ae=2e3,Ce={};let Pe=0;function Be(t,e,n,r,i,o,a,s,l,c){const u="TroikaTextSDFGenerator_JS_"+Pe++%De;let h=Ce[u];return h||(h=Ce[u]={workerModule:re({name:u,workerId:u,dependencies:[ae,be],init(t,e){const n=t().javascript.generate;return function(...t){const r=e();return{textureData:n(...t),timing:e()-r}}},getTransferables:t=>[t.textureData.buffer]}),requests:0,idleTimer:null}),h.requests++,clearTimeout(h.idleTimer),h.workerModule(t,e,n,r,i,o).then((({textureData:n,timing:r})=>{const i=be(),o=new Uint8Array(4*n.length);for(let t=0;t<n.length;t++)o[4*t+c]=n[t];return we.webglUtils.renderImageData(a,o,s,l,t,e,1<<3-c),r+=be()-i,0==--h.requests&&(h.idleTimer=setTimeout((()=>{!function(t){ee[t]&&ee[t].forEach((function(t){t()})),te[t]&&(te[t].terminate(),delete te[t])}(u)}),Ae)),{timing:r}}))}const ke=we.webglUtils.resizeWebGLCanvasWithoutClearing,Fe={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},Ie=new v;function Ee(){return(self.performance||Date).now()}const Re=Object.create(null);function Oe({path:t,atlasIndex:e,sdfViewBox:n},{sdfGlyphSize:r,sdfCanvas:i,contextLost:o},a){if(o)return Promise.resolve({timing:-1});const{textureWidth:s,sdfExponent:l}=Fe,c=Math.max(n[2]-n[0],n[3]-n[1]),u=Math.floor(e/4);return function(t,e,n,r,i,o,a,s,l,c,u=!0){return u?((...t)=>new Promise(((e,n)=>{Te.push((()=>{const r=be();try{we.webgl.generateIntoCanvas(...t),e({timing:be()-r})}catch(t){n(t)}})),Ue||(Ue=setTimeout(Me,0))})))(t,e,n,r,i,o,a,s,l,c).then(null,(u=>(Se||(console.warn("WebGL SDF generation failed, falling back to JS",u),Se=!0),Be(t,e,n,r,i,o,a,s,l,c)))):Be(t,e,n,r,i,o,a,s,l,c)}(r,r,t,n,c,l,i,u%(s/r)*r,Math.floor(u/(s/r))*r,e%4,a)}let Ge;function ze(t){return Ge||(Ge="undefined"==typeof document?{}:document.createElement("a")),Ge.href=t,Ge.href}function Le(t){if("function"!=typeof createImageBitmap){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:e,sdfTexture:n}=t,{width:r,height:i}=e,o=t.sdfCanvas.getContext("webgl");let a=n.image.data;a&&a.length===r*i*4||(a=new Uint8Array(r*i*4),n.image={width:r,height:i,data:a},n.flipY=!1,n.isDataTexture=!0),o.readPixels(0,0,r,i,o.RGBA,o.UNSIGNED_BYTE,a)}}const Ne=re({name:"Typesetter",dependencies:[function(t,e){const n=1/0,r=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,i="[^\\S\\u00A0]",o=new RegExp(`${i}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function a({text:a="",font:h,lang:d,sdfGlyphSize:f=64,fontSize:p=400,fontWeight:v=1,fontStyle:g="normal",letterSpacing:m=0,lineHeight:y="normal",maxWidth:_=n,direction:x,textAlign:b="left",textIndent:w=0,whiteSpace:S="normal",overflowWrap:T="normal",anchorX:U=0,anchorY:M=0,metricsOnly:D=!1,unicodeFontsURL:A,preResolvedFonts:C=null,includeCaretPositions:P=!1,chunkedBoundsSize:B=8192,colorRanges:k=null},F){const I=c(),E={fontLoad:0,typesetting:0};a.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),a=a.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),p=+p,m=+m,_=+_,y=y||"normal",w=+w,function({text:e,lang:n,fonts:r,style:i,weight:o,preResolvedFonts:a,unicodeFontsURL:s},l){const c=({chars:t,fonts:e})=>{let n,r;const i=[];for(let o=0;o<t.length;o++)t[o]!==r?(r=t[o],i.push(n={start:o,end:o,fontObj:e[t[o]]})):n.end=o;l(i)};a?c(a):t(e,c,{lang:n,fonts:r,style:i,weight:o,unicodeFontsURL:s})}({text:a,lang:d,style:g,weight:v,fonts:"string"==typeof h?[{src:h}]:h,unicodeFontsURL:A,preResolvedFonts:C},(t=>{E.fontLoad=c()-I;const h=isFinite(_);let d=null,f=null,v=null,g=null,A=null,C=null,R=null,O=null,G=0,z=0,L="nowrap"!==S;const N=new Map,j=c();let W=w,H=0,V=new u;const q=[V];t.forEach((t=>{const{fontObj:e}=t,{ascender:n,descender:s,unitsPerEm:l,lineGap:c,capHeight:d,xHeight:f}=e;let v=N.get(e);if(!v){const t=p/l,r="normal"===y?(n-s+c)*t:y*p,i=(r-(n-s)*t)/2,o=Math.min(r,(n-s)*t),a=(n+s)/2*t+o/2;v={index:N.size,src:e.src,fontObj:e,fontSizeMult:t,unitsPerEm:l,ascender:n*t,descender:s*t,capHeight:d*t,xHeight:f*t,lineHeight:r,baseline:-i-n*t,caretTop:(n+s)/2*t+o/2,caretBottom:a-o},N.set(e,v)}const{fontSizeMult:g}=v,x=a.slice(t.start,t.end+1);let b,S;e.forEachGlyph(x,p,m,((e,n,s,l)=>{n+=H,l+=t.start,b=n,S=e;const c=a.charAt(l),d=e.advanceWidth*g,f=V.count;let y;if("isEmpty"in e||(e.isWhitespace=!!c&&new RegExp(i).test(c),e.canBreakAfter=!!c&&o.test(c),e.isEmpty=e.xMin===e.xMax||e.yMin===e.yMax||r.test(c)),e.isWhitespace||e.isEmpty||z++,L&&h&&!e.isWhitespace&&n+d+W>_&&f){if(V.glyphAt(f-1).glyphObj.canBreakAfter)y=new u,W=-n;else for(let t=f;t--;){if(0===t&&"break-word"===T){y=new u,W=-n;break}if(V.glyphAt(t).glyphObj.canBreakAfter){y=V.splitAt(t+1);const e=y.glyphAt(0).x;W-=e;for(let t=y.count;t--;)y.glyphAt(t).x-=e;break}}y&&(V.isSoftWrapped=!0,V=y,q.push(V),G=_)}let x=V.glyphAt(V.count);x.glyphObj=e,x.x=n+W,x.y=s,x.width=d,x.charIndex=l,x.fontData=v,"\n"===c&&(V=new u,q.push(V),W=-(n+d+m*p)+w)})),H=b+S.advanceWidth*g+m*p}));let X=0;q.forEach((t=>{let e=!0;for(let n=t.count;n--;){const r=t.glyphAt(n);e&&!r.glyphObj.isWhitespace&&(t.width=r.x+r.width,t.width>G&&(G=t.width),e=!1);let{lineHeight:i,capHeight:o,xHeight:a,baseline:s}=r.fontData;i>t.lineHeight&&(t.lineHeight=i);const l=s-t.baseline;l<0&&(t.baseline+=l,t.cap+=l,t.ex+=l),t.cap=Math.max(t.cap,t.baseline+o),t.ex=Math.max(t.ex,t.baseline+a)}t.baseline-=X,t.cap-=X,t.ex-=X,X+=t.lineHeight}));let Y=0,$=0;if(U&&("number"==typeof U?Y=-U:"string"==typeof U&&(Y=-G*("left"===U?0:"center"===U?.5:"right"===U?1:s(U)))),M&&("number"==typeof M?$=-M:"string"==typeof M&&($="top"===M?0:"top-baseline"===M?-q[0].baseline:"top-cap"===M?-q[0].cap:"top-ex"===M?-q[0].ex:"middle"===M?X/2:"bottom"===M?X:"bottom-baseline"===M?q[q.length-1].baseline:s(M)*X)),!D){const t=e.getEmbeddingLevels(a,x);d=new Uint16Array(z),f=new Uint8Array(z),v=new Float32Array(2*z),g={},R=[n,n,-1/0,-1/0],O=[],P&&(C=new Float32Array(4*a.length)),k&&(A=new Uint8Array(3*z));let r,i,o=0,s=-1,c=-1;if(q.forEach(((u,h)=>{let{count:p,width:m}=u;if(p>0){let h=0;for(let t=p;t--&&u.glyphAt(t).glyphObj.isWhitespace;)h++;let y=0,_=0;if("center"===b)y=(G-m)/2;else if("right"===b)y=G-m;else if("justify"===b&&u.isSoftWrapped){let t=0;for(let e=p-h;e--;)u.glyphAt(e).glyphObj.isWhitespace&&t++;_=(G-m)/t}if(_||y){let t=0;for(let e=0;e<p;e++){let n=u.glyphAt(e);const r=n.glyphObj;n.x+=y+t,0!==_&&r.isWhitespace&&e<p-h&&(t+=_,n.width+=_)}}const x=e.getReorderSegments(a,t,u.glyphAt(0).charIndex,u.glyphAt(u.count-1).charIndex);for(let t=0;t<x.length;t++){const[e,n]=x[t];let r=1/0,i=-1/0;for(let t=0;t<p;t++)if(u.glyphAt(t).charIndex>=e){let e=t,o=t;for(;o<p;o++){let t=u.glyphAt(o);if(t.charIndex>n)break;o<p-h&&(r=Math.min(r,t.x),i=Math.max(i,t.x+t.width))}for(let t=e;t<o;t++){const e=u.glyphAt(t);e.x=i-(e.x+e.width-r)}break}}let w;const S=t=>w=t;for(let h=0;h<p;h++){const p=u.glyphAt(h);w=p.glyphObj;const m=w.index,y=1&t.levels[p.charIndex];if(y){const t=e.getMirroredCharacter(a[p.charIndex]);t&&p.fontData.fontObj.forEachGlyph(t,0,0,S)}if(P){const{charIndex:t,fontData:e}=p,n=p.x+Y,r=p.x+p.width+Y;C[4*t]=y?r:n,C[4*t+1]=y?n:r,C[4*t+2]=u.baseline+e.caretBottom+$,C[4*t+3]=u.baseline+e.caretTop+$;const i=t-s;i>1&&l(C,s,i),s=t}if(k){const{charIndex:t}=p;for(;t>c;)c++,k.hasOwnProperty(c)&&(i=k[c])}if(!w.isWhitespace&&!w.isEmpty){const t=o++,{fontSizeMult:e,src:a,index:s}=p.fontData,l=g[a]||(g[a]={});l[m]||(l[m]={path:w.path,pathBounds:[w.xMin,w.yMin,w.xMax,w.yMax]});const c=p.x+Y,h=p.y+u.baseline+$;v[2*t]=c,v[2*t+1]=h;const y=c+w.xMin*e,_=h+w.yMin*e,x=c+w.xMax*e,b=h+w.yMax*e;y<R[0]&&(R[0]=y),_<R[1]&&(R[1]=_),x>R[2]&&(R[2]=x),b>R[3]&&(R[3]=b),t%B==0&&(r={start:t,end:t,rect:[n,n,-1/0,-1/0]},O.push(r)),r.end++;const S=r.rect;if(y<S[0]&&(S[0]=y),_<S[1]&&(S[1]=_),x>S[2]&&(S[2]=x),b>S[3]&&(S[3]=b),d[t]=m,f[t]=s,k){const e=3*t;A[e]=i>>16&255,A[e+1]=i>>8&255,A[e+2]=255&i}}}}})),C){const t=a.length-s;t>1&&l(C,s,t)}}const Z=[];N.forEach((({index:t,src:e,unitsPerEm:n,ascender:r,descender:i,lineHeight:o,capHeight:a,xHeight:s})=>{Z[t]={src:e,unitsPerEm:n,ascender:r,descender:i,lineHeight:o,capHeight:a,xHeight:s}})),E.typesetting=c()-j,F({glyphIds:d,glyphFontIndices:f,glyphPositions:v,glyphData:g,fontData:Z,caretPositions:C,glyphColors:A,chunkedBounds:O,fontSize:p,topBaseline:$+q[0].baseline,blockBounds:[Y,$-X,Y+G,$],visibleBounds:R,timings:E})}))}function s(t){let e=t.match(/^([\d.]+)%$/),n=e?parseFloat(e[1]):NaN;return isNaN(n)?0:n/100}function l(t,e,n){const r=t[4*e],i=t[4*e+1],o=t[4*e+2],a=t[4*e+3],s=(i-r)/n;for(let i=0;i<n;i++){const n=4*(e+i);t[n]=r+s*i,t[n+1]=r+s*(i+1),t[n+2]=o,t[n+3]=a}}function c(){return(self.performance||Date).now()}function u(){this.data=[]}const h=["glyphObj","x","y","width","charIndex","fontData"];return u.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/h.length)},glyphAt(t){let e=u.flyweight;return e.data=this.data,e.index=t,e},splitAt(t){let e=new u;return e.data=this.data.splice(t*h.length),e}},u.flyweight=h.reduce(((t,e,n,r)=>(Object.defineProperty(t,e,{get(){return this.data[this.index*h.length+n]},set(t){this.data[this.index*h.length+n]=t}}),t)),{data:null,index:0}),{typeset:a,measure:function(t,e){a({...t,metricsOnly:!0},(t=>{const[n,r,i,o]=t.blockBounds;e({width:i-n,height:o-r})}))}}},xe,function(){return function(t){var e={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},n={},r={};n.L=1,r[1]="L",Object.keys(e).forEach((function(t,e){n[t]=1<<e+1,r[n[t]]=t})),Object.freeze(n);var i=n.LRI|n.RLI|n.FSI,o=n.L|n.R|n.AL,a=n.B|n.S|n.WS|n.ON|n.FSI|n.LRI|n.RLI|n.PDI,s=n.BN|n.RLE|n.LRE|n.RLO|n.LRO|n.PDF,l=n.S|n.WS|n.B|i|n.PDI|s,c=null;function u(t){return function(){if(!c){c=new Map;var t=function(t){if(e.hasOwnProperty(t)){var r=0;e[t].split(",").forEach((function(e){var i=e.split("+"),o=i[0],a=i[1];o=parseInt(o,36),a=a?parseInt(a,36):0,c.set(r+=o,n[t]);for(var s=0;s<a;s++)c.set(++r,n[t])}))}};for(var r in e)t(r)}}(),c.get(t.codePointAt(0))||n.L}var h,d,f,p={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function v(t,e){var n,r=0,i=new Map,o=e&&new Map;return t.split(",").forEach((function t(a){if(-1!==a.indexOf("+"))for(var s=+a;s--;)t(n);else{n=a;var l=a.split(">"),c=l[0],u=l[1];c=String.fromCodePoint(r+=parseInt(c,36)),u=String.fromCodePoint(r+=parseInt(u,36)),i.set(c,u),e&&o.set(u,c)}})),{map:i,reverseMap:o}}function g(){if(!h){var t=v(p.pairs,!0),e=t.map,n=t.reverseMap;h=e,d=n,f=v(p.canonical,!1).map}}function m(t){return g(),h.get(t)||null}function y(t){return g(),d.get(t)||null}function _(t){return g(),f.get(t)||null}var x,b=n.L,w=n.R,S=n.EN,T=n.ES,U=n.ET,M=n.AN,D=n.CS,A=n.B,C=n.S,P=n.ON,B=n.BN,k=n.NSM,F=n.AL,I=n.LRO,E=n.RLO,R=n.LRE,O=n.RLE,G=n.PDF,z=n.LRI,L=n.RLI,N=n.FSI,j=n.PDI;function W(t){return function(){if(!x){var t=v("14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1",!0),e=t.map;t.reverseMap.forEach((function(t,n){e.set(n,t)})),x=e}}(),x.get(t)||null}function H(t,e,n,r){var i=t.length;n=Math.max(0,null==n?0:+n),r=Math.min(i-1,null==r?i-1:+r);var o=[];return e.paragraphs.forEach((function(i){var a=Math.max(n,i.start),s=Math.min(r,i.end);if(a<s){for(var c=e.levels.slice(a,s+1),h=s;h>=a&&u(t[h])&l;h--)c[h]=i.level;for(var d=i.level,f=1/0,p=0;p<c.length;p++){var v=c[p];v>d&&(d=v),v<f&&(f=1|v)}for(var g=d;g>=f;g--)for(var m=0;m<c.length;m++)if(c[m]>=g){for(var y=m;m+1<c.length&&c[m+1]>=g;)m++;m>y&&o.push([y+a,m+a])}}})),o}function V(t,e,n,r){for(var i=H(t,e,n,r),o=[],a=0;a<t.length;a++)o[a]=a;return i.forEach((function(t){for(var e=t[0],n=t[1],r=o.slice(e,n+1),i=r.length;i--;)o[n-i]=r[i]})),o}return t.closingToOpeningBracket=y,t.getBidiCharType=u,t.getBidiCharTypeName=function(t){return r[u(t)]},t.getCanonicalBracket=_,t.getEmbeddingLevels=function(t,e){for(var n=new Uint32Array(t.length),r=0;r<t.length;r++)n[r]=u(t[r]);var c=new Map;function h(t,e){var r=n[t];n[t]=e,c.set(r,c.get(r)-1),r&a&&c.set(a,c.get(a)-1),c.set(e,(c.get(e)||0)+1),e&a&&c.set(a,(c.get(a)||0)+1)}for(var d=new Uint8Array(t.length),f=new Map,p=[],v=null,g=0;g<t.length;g++)v||p.push(v={start:g,end:t.length-1,level:"rtl"===e?1:"ltr"===e?0:Ne(g,!1)}),n[g]&A&&(v.end=g,v=null);for(var x=O|R|E|I|i|j|G|A,W=function(t){return t+(1&t?1:2)},H=function(t){return t+(1&t?2:1)},V=0;V<p.length;V++){var q=[{_level:(v=p[V]).level,_override:0,_isolate:0}],X=void 0,Y=0,$=0,Z=0;c.clear();for(var K=v.start;K<=v.end;K++){var Q=n[K];if(X=q[q.length-1],c.set(Q,(c.get(Q)||0)+1),Q&a&&c.set(a,(c.get(a)||0)+1),Q&x)if(Q&(O|R)){d[K]=X._level;var J=(Q===O?H:W)(X._level);J<=125&&!Y&&!$?q.push({_level:J,_override:0,_isolate:0}):Y||$++}else if(Q&(E|I)){d[K]=X._level;var tt=(Q===E?H:W)(X._level);tt<=125&&!Y&&!$?q.push({_level:tt,_override:Q&E?w:b,_isolate:0}):Y||$++}else if(Q&i){Q&N&&(Q=1===Ne(K+1,!0)?L:z),d[K]=X._level,X._override&&h(K,X._override);var et=(Q===L?H:W)(X._level);et<=125&&0===Y&&0===$?(Z++,q.push({_level:et,_override:0,_isolate:1,_isolInitIndex:K})):Y++}else if(Q&j){if(Y>0)Y--;else if(Z>0){for($=0;!q[q.length-1]._isolate;)q.pop();var nt=q[q.length-1]._isolInitIndex;null!=nt&&(f.set(nt,K),f.set(K,nt)),q.pop(),Z--}X=q[q.length-1],d[K]=X._level,X._override&&h(K,X._override)}else Q&G?(0===Y&&($>0?$--:!X._isolate&&q.length>1&&(q.pop(),X=q[q.length-1])),d[K]=X._level):Q&A&&(d[K]=v.level);else d[K]=X._level,X._override&&Q!==B&&h(K,X._override)}for(var rt=[],it=null,ot=v.start;ot<=v.end;ot++){var at=n[ot];if(!(at&s)){var st=d[ot],lt=at&i,ct=at===j;it&&st===it._level?(it._end=ot,it._endsWithIsolInit=lt):rt.push(it={_start:ot,_end:ot,_level:st,_startsWithPDI:ct,_endsWithIsolInit:lt})}}for(var ut=[],ht=0;ht<rt.length;ht++){var dt=rt[ht];if(!dt._startsWithPDI||dt._startsWithPDI&&!f.has(dt._start)){for(var ft=[it=dt],pt=void 0;it&&it._endsWithIsolInit&&null!=(pt=f.get(it._end));)for(var vt=ht+1;vt<rt.length;vt++)if(rt[vt]._start===pt){ft.push(it=rt[vt]);break}for(var gt=[],mt=0;mt<ft.length;mt++)for(var yt=ft[mt],_t=yt._start;_t<=yt._end;_t++)gt.push(_t);for(var xt=d[gt[0]],bt=v.level,wt=gt[0]-1;wt>=0;wt--)if(!(n[wt]&s)){bt=d[wt];break}var St=gt[gt.length-1],Tt=d[St],Ut=v.level;if(!(n[St]&i))for(var Mt=St+1;Mt<=v.end;Mt++)if(!(n[Mt]&s)){Ut=d[Mt];break}ut.push({_seqIndices:gt,_sosType:Math.max(bt,xt)%2?w:b,_eosType:Math.max(Ut,Tt)%2?w:b})}}for(var Dt=0;Dt<ut.length;Dt++){var At=ut[Dt],Ct=At._seqIndices,Pt=At._sosType,Bt=At._eosType,kt=1&d[Ct[0]]?w:b;if(c.get(k))for(var Ft=0;Ft<Ct.length;Ft++){var It=Ct[Ft];if(n[It]&k){for(var Et=Pt,Rt=Ft-1;Rt>=0;Rt--)if(!(n[Ct[Rt]]&s)){Et=n[Ct[Rt]];break}h(It,Et&(i|j)?P:Et)}}if(c.get(S))for(var Ot=0;Ot<Ct.length;Ot++){var Gt=Ct[Ot];if(n[Gt]&S)for(var zt=Ot-1;zt>=-1;zt--){var Lt=-1===zt?Pt:n[Ct[zt]];if(Lt&o){Lt===F&&h(Gt,M);break}}}if(c.get(F))for(var Nt=0;Nt<Ct.length;Nt++){var jt=Ct[Nt];n[jt]&F&&h(jt,w)}if(c.get(T)||c.get(D))for(var Wt=1;Wt<Ct.length-1;Wt++){var Ht=Ct[Wt];if(n[Ht]&(T|D)){for(var Vt=0,qt=0,Xt=Wt-1;Xt>=0&&(Vt=n[Ct[Xt]])&s;Xt--);for(var Yt=Wt+1;Yt<Ct.length&&(qt=n[Ct[Yt]])&s;Yt++);Vt===qt&&(n[Ht]===T?Vt===S:Vt&(S|M))&&h(Ht,Vt)}}if(c.get(S))for(var $t=0;$t<Ct.length;$t++){var Zt=Ct[$t];if(n[Zt]&S){for(var Kt=$t-1;Kt>=0&&n[Ct[Kt]]&(U|s);Kt--)h(Ct[Kt],S);for($t++;$t<Ct.length&&n[Ct[$t]]&(U|s|S);$t++)n[Ct[$t]]!==S&&h(Ct[$t],S)}}if(c.get(U)||c.get(T)||c.get(D))for(var Qt=0;Qt<Ct.length;Qt++){var Jt=Ct[Qt];if(n[Jt]&(U|T|D)){h(Jt,P);for(var te=Qt-1;te>=0&&n[Ct[te]]&s;te--)h(Ct[te],P);for(var ee=Qt+1;ee<Ct.length&&n[Ct[ee]]&s;ee++)h(Ct[ee],P)}}if(c.get(S))for(var ne=0,re=Pt;ne<Ct.length;ne++){var ie=Ct[ne],oe=n[ie];oe&S?re===b&&h(ie,b):oe&o&&(re=oe)}if(c.get(a)){for(var ae=w|S|M,se=ae|b,le=[],ce=[],ue=0;ue<Ct.length;ue++)if(n[Ct[ue]]&a){var he=t[Ct[ue]],de=void 0;if(null!==m(he)){if(!(ce.length<63))break;ce.push({char:he,seqIndex:ue})}else if(null!==(de=y(he)))for(var fe=ce.length-1;fe>=0;fe--){var pe=ce[fe].char;if(pe===de||pe===y(_(he))||m(_(pe))===he){le.push([ce[fe].seqIndex,ue]),ce.length=fe;break}}}le.sort((function(t,e){return t[0]-e[0]}));for(var ve=0;ve<le.length;ve++){for(var ge=le[ve],me=ge[0],ye=ge[1],_e=!1,xe=0,be=me+1;be<ye;be++){var we=Ct[be];if(n[we]&se){_e=!0;var Se=n[we]&ae?w:b;if(Se===kt){xe=Se;break}}}if(_e&&!xe){xe=Pt;for(var Te=me-1;Te>=0;Te--){var Ue=Ct[Te];if(n[Ue]&se){var Me=n[Ue]&ae?w:b;xe=Me!==kt?Me:kt;break}}}if(xe){if(n[Ct[me]]=n[Ct[ye]]=xe,xe!==kt)for(var De=me+1;De<Ct.length;De++)if(!(n[Ct[De]]&s)){u(t[Ct[De]])&k&&(n[Ct[De]]=xe);break}if(xe!==kt)for(var Ae=ye+1;Ae<Ct.length;Ae++)if(!(n[Ct[Ae]]&s)){u(t[Ct[Ae]])&k&&(n[Ct[Ae]]=xe);break}}}for(var Ce=0;Ce<Ct.length;Ce++)if(n[Ct[Ce]]&a){for(var Pe=Ce,Be=Ce,ke=Pt,Fe=Ce-1;Fe>=0;Fe--){if(!(n[Ct[Fe]]&s)){ke=n[Ct[Fe]]&ae?w:b;break}Pe=Fe}for(var Ie=Bt,Ee=Ce+1;Ee<Ct.length;Ee++){if(!(n[Ct[Ee]]&(a|s))){Ie=n[Ct[Ee]]&ae?w:b;break}Be=Ee}for(var Re=Pe;Re<=Be;Re++)n[Ct[Re]]=ke===Ie?ke:kt;Ce=Be}}}for(var Oe=v.start;Oe<=v.end;Oe++){var Ge=d[Oe],ze=n[Oe];if(1&Ge?ze&(b|S|M)&&d[Oe]++:ze&w?d[Oe]++:ze&(M|S)&&(d[Oe]+=2),ze&s&&(d[Oe]=0===Oe?v.level:d[Oe-1]),Oe===v.end||u(t[Oe])&(C|A))for(var Le=Oe;Le>=0&&u(t[Le])&l;Le--)d[Le]=v.level}}return{levels:d,paragraphs:p};function Ne(e,r){for(var o=e;o<t.length;o++){var a=n[o];if(a&(w|F))return 1;if(a&(A|b)||r&&a===j)return 0;if(a&i){var s=je(o);o=-1===s?t.length:s}}return 0}function je(e){for(var r=1,o=e+1;o<t.length;o++){var a=n[o];if(a&A)break;if(a&j){if(0==--r)return o}else a&i&&r++}return-1}},t.getMirroredCharacter=W,t.getMirroredCharactersMap=function(t,e,n,r){var i=t.length;n=Math.max(0,null==n?0:+n),r=Math.min(i-1,null==r?i-1:+r);for(var o=new Map,a=n;a<=r;a++)if(1&e[a]){var s=W(t[a]);null!==s&&o.set(a,s)}return o},t.getReorderSegments=H,t.getReorderedIndices=V,t.getReorderedString=function(t,e,n,r){var i=V(t,e,n,r),o=[].concat(t);return i.forEach((function(n,r){o[r]=(1&e.levels[n]?W(t[n]):null)||t[n]})),o.join("")},t.openingToClosingBracket=m,Object.defineProperty(t,"__esModule",{value:!0}),t}({})}],init:(t,e,n)=>t(e,n())}),je=re({name:"Typesetter",dependencies:[Ne],init:t=>function(e){return new Promise((n=>{t.typeset(e,n)}))},getTransferables(t){const e=[];for(let n in t)t[n]&&t[n].buffer&&e.push(t[n].buffer);return e}}),We={},He="aTroikaGlyphIndex";class Ve extends R{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new O,this.boundingBox=new G}computeBoundingSphere(){}computeBoundingBox(){}setSide(t){const e=this.getIndex().count;this.setDrawRange(t===z?e/2:0,t===L?e:e/2)}set detail(t){if(t!==this._detail){this._detail=t,("number"!=typeof t||t<1)&&(t=1);let e=function(t){let e=We[t];if(!e){const i=new _(1,1,t,t),o=i.clone(),a=i.attributes,s=o.attributes,l=new n,c=a.uv.count;for(let t=0;t<c;t++)s.position.array[3*t]*=-1,s.normal.array[3*t+2]*=-1;["position","normal","uv"].forEach((t=>{l.setAttribute(t,new r([...a[t].array,...s[t].array],a[t].itemSize))})),l.setIndex([...i.index.array,...o.index.array.map((t=>t+c))]),l.translate(.5,.5,0),e=We[t]=l}return e}(t);["position","normal","uv"].forEach((t=>{this.attributes[t]=e.attributes[t].clone()})),this.setIndex(e.getIndex().clone())}}get detail(){return this._detail}set curveRadius(t){t!==this._curveRadius&&(this._curveRadius=t,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(t,e,n,r,i){qe(this,"aTroikaGlyphBounds",t,4),qe(this,He,e,1),qe(this,"aTroikaGlyphColor",i,3),this._blockBounds=n,this._chunkedBounds=r,this.instanceCount=e.length,this._updateBounds()}_updateBounds(){const t=this._blockBounds;if(t){const{curveRadius:e,boundingBox:n}=this;if(e){const{PI:r,floor:i,min:o,max:a,sin:s,cos:l}=Math,c=r/2,u=2*r,h=Math.abs(e),d=t[0]/h,f=t[2]/h,p=i((d+c)/u)!==i((f+c)/u)?-h:o(s(d)*h,s(f)*h),v=i((d-c)/u)!==i((f-c)/u)?h:a(s(d)*h,s(f)*h),g=i((d+r)/u)!==i((f+r)/u)?2*h:a(h-l(d)*h,h-l(f)*h);n.min.set(p,t[1],e<0?-g:0),n.max.set(v,t[3],e<0?0:g)}else n.min.set(t[0],t[1],0),n.max.set(t[2],t[3],0);n.getBoundingSphere(this.boundingSphere)}}applyClipRect(t){let e=this.getAttribute(He).count,n=this._chunkedBounds;if(n)for(let r=n.length;r--;){e=n[r].end;let i=n[r].rect;if(i[1]<t.w&&i[3]>t.y&&i[0]<t.z&&i[2]>t.x)break}this.instanceCount=e}}function qe(t,e,n,r){const i=t.getAttribute(e);n?i&&i.array.length===n.length?(i.array.set(n),i.needsUpdate=!0):(t.setAttribute(e,new N(n,r)),delete t._maxInstanceCount,t.dispose()):i&&t.deleteAttribute(e)}const Xe=new s({color:16777215,side:L,transparent:!0}),Ye=8421504,$e=new H,Ze=new u,Ke=new u,Qe=[],Je=new u,tn="+x+y";function en(t){return Array.isArray(t)?t[0]:t}let nn=()=>{const t=new l(new _(1,1),Xe);return nn=()=>t,t},rn=()=>{const t=new l(new _(1,1,32,1),Xe);return rn=()=>t,t};const on={type:"syncstart"},an={type:"synccomplete"},sn=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],ln=sn.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class cn extends l{constructor(){super(new Ve,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=Ye,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=tn,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(t){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(t):(this._isSyncing=!0,this.dispatchEvent(on),function(t,e){t=function(t,e){for(let n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}({},t);const n=Ee(),{defaultFontURL:r}=Fe,i=[];if(r&&i.push({label:"default",src:ze(r)}),t.font&&i.push({label:"user",src:ze(t.font)}),t.font=i,t.text=""+t.text,t.sdfGlyphSize=t.sdfGlyphSize||Fe.sdfGlyphSize,t.unicodeFontsURL=t.unicodeFontsURL||Fe.unicodeFontsURL,null!=t.colorRanges){let e={};for(let n in t.colorRanges)if(t.colorRanges.hasOwnProperty(n)){let r=t.colorRanges[n];"number"!=typeof r&&(r=Ie.set(r).getHex()),e[n]=r}t.colorRanges=e}Object.freeze(t);const{textureWidth:o,sdfExponent:a}=Fe,{sdfGlyphSize:s}=t,l=o/s*4;let c=Re[s];if(!c){const t=document.createElement("canvas");t.width=o,t.height=256*s/l,c=Re[s]={glyphCount:0,sdfGlyphSize:s,sdfCanvas:t,sdfTexture:new I(t,void 0,void 0,void 0,E,E),contextLost:!1,glyphsByFont:new Map},c.sdfTexture.generateMipmaps=!1,function(t){const e=t.sdfCanvas;e.addEventListener("webglcontextlost",(e=>{console.log("Context Lost",e),e.preventDefault(),t.contextLost=!0})),e.addEventListener("webglcontextrestored",(e=>{console.log("Context Restored",e),t.contextLost=!1;const n=[];t.glyphsByFont.forEach((e=>{e.forEach((e=>{n.push(Oe(e,t,!0))}))})),Promise.all(n).then((()=>{Le(t),t.sdfTexture.needsUpdate=!0}))}))}(c)}const{sdfTexture:u,sdfCanvas:h}=c;je(t).then((r=>{const{glyphIds:i,glyphFontIndices:d,fontData:f,glyphPositions:p,fontSize:v,timings:g}=r,m=[],y=new Float32Array(4*i.length);let _=0,x=0;const b=Ee(),w=f.map((t=>{let e=c.glyphsByFont.get(t.src);return e||c.glyphsByFont.set(t.src,e=new Map),e}));i.forEach(((t,e)=>{const n=d[e],{src:o,unitsPerEm:a}=f[n];let l=w[n].get(t);if(!l){const{path:e,pathBounds:i}=r.glyphData[o][t],a=Math.max(i[2]-i[0],i[3]-i[1])/s*(Fe.sdfMargin*s+.5),u=c.glyphCount++,h=[i[0]-a,i[1]-a,i[2]+a,i[3]+a];w[n].set(t,l={path:e,atlasIndex:u,sdfViewBox:h}),m.push(l)}const{sdfViewBox:u}=l,h=p[x++],g=p[x++],b=v/a;y[_++]=h+u[0]*b,y[_++]=g+u[1]*b,y[_++]=h+u[2]*b,y[_++]=g+u[3]*b,i[e]=l.atlasIndex})),g.quads=(g.quads||0)+(Ee()-b);const S=Ee();g.sdf={};const T=h.height,U=Math.ceil(c.glyphCount/l),M=Math.pow(2,Math.ceil(Math.log2(U*s)));M>T&&(console.info(`Increasing SDF texture size ${T}->${M}`),ke(h,o,M),u.dispose()),Promise.all(m.map((e=>Oe(e,c,t.gpuAccelerateSDF).then((({timing:t})=>{g.sdf[e.atlasIndex]=t}))))).then((()=>{m.length&&!c.contextLost&&(Le(c),u.needsUpdate=!0),g.sdfTotal=Ee()-S,g.total=Ee()-n,e(Object.freeze({parameters:t,sdfTexture:u,sdfGlyphSize:s,sdfExponent:a,glyphBounds:y,glyphAtlasIndices:i,glyphColors:r.glyphColors,caretPositions:r.caretPositions,chunkedBounds:r.chunkedBounds,ascender:r.ascender,descender:r.descender,lineHeight:r.lineHeight,capHeight:r.capHeight,xHeight:r.xHeight,topBaseline:r.topBaseline,blockBounds:r.blockBounds,visibleBounds:r.visibleBounds,timings:r.timings}))}))})),Promise.resolve().then((()=>{var t;c.contextLost||(t=h)._warm||(we.webgl.isSupported(t),t._warm=!0)}))}({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},(e=>{this._isSyncing=!1,this._textRenderInfo=e,this.geometry.updateGlyphs(e.glyphBounds,e.glyphAtlasIndices,e.blockBounds,e.chunkedBounds,e.glyphColors);const n=this._queuedSyncs;n&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{n.forEach((t=>t&&t()))}))),this.dispatchEvent(an),t&&t()}))))}onBeforeRender(t,e,n,r,i,o){this.sync(),i.isTroikaTextMaterial&&this._prepareForRender(i),i._hadOwnSide=i.hasOwnProperty("side"),this.geometry.setSide(i._actualSide=i.side),i.side=F}onAfterRender(t,e,n,r,i,o){i._hadOwnSide?i.side=i._actualSide:delete i.side}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}get material(){let t=this._derivedMaterial;const e=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=Xe.clone());if(t&&t.baseMaterial===e||(t=this._derivedMaterial=function(t){const e=ve(t,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new f},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new j(0,0,0,0)},uTroikaClipRect:{value:new j(0,0,0,0)},uTroikaDistanceOffset:{value:0},uTroikaOutlineOpacity:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new f},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new v},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new W},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:"\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",vertexTransform:"\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",fragmentDefs:"\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaOutlineOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of exponential encoding in webgl-sdf-generator\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",fragmentColorTransform:"\nfloat aaDist = troikaGetAADist();\nfloat fragDistance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(fragDistance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  fragDistance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n",customRewriter({vertexShader:t,fragmentShader:e}){let n=/\buniform\s+vec3\s+diffuse\b/;return n.test(e)&&(e=e.replace(n,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),n.test(t)||(t=t.replace(se,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:t,fragmentShader:e}}});return e.transparent=!0,Object.defineProperties(e,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),e}(e),e.addEventListener("dispose",(function n(){e.removeEventListener("dispose",n),t.dispose()}))),this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY){let e=t._outlineMtl;return e||(e=t._outlineMtl=Object.create(t,{id:{value:t.id+.1}}),e.isTextOutlineMaterial=!0,e.depthWrite=!1,e.map=null,t.addEventListener("dispose",(function n(){t.removeEventListener("dispose",n),e.dispose()}))),[e,t]}return t}set material(t){t&&t.isTroikaTextMaterial?(this._derivedMaterial=t,this._baseMaterial=t.baseMaterial):this._baseMaterial=t}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(t){this.geometry.detail=t}get curveRadius(){return this.geometry.curveRadius}set curveRadius(t){this.geometry.curveRadius=t}get customDepthMaterial(){return en(this.material).getDepthMaterial()}get customDistanceMaterial(){return en(this.material).getDistanceMaterial()}_prepareForRender(t){const e=t.isTextOutlineMaterial,n=t.uniforms,r=this.textRenderInfo;if(r){const{sdfTexture:t,blockBounds:i}=r;n.uTroikaSDFTexture.value=t,n.uTroikaSDFTextureSize.value.set(t.image.width,t.image.height),n.uTroikaSDFGlyphSize.value=r.sdfGlyphSize,n.uTroikaSDFExponent.value=r.sdfExponent,n.uTroikaTotalBounds.value.fromArray(i),n.uTroikaUseGlyphColors.value=!e&&!!r.glyphColors;let o,a,s,l=0,c=0,u=0,h=0,d=0;if(e){let{outlineWidth:t,outlineOffsetX:e,outlineOffsetY:n,outlineBlur:r,outlineOpacity:i}=this;l=this._parsePercent(t)||0,c=Math.max(0,this._parsePercent(r)||0),o=i,h=this._parsePercent(e)||0,d=this._parsePercent(n)||0}else u=Math.max(0,this._parsePercent(this.strokeWidth)||0),u&&(s=this.strokeColor,n.uTroikaStrokeColor.value.set(null==s?Ye:s),a=this.strokeOpacity,null==a&&(a=1)),o=this.fillOpacity;n.uTroikaDistanceOffset.value=l,n.uTroikaPositionOffset.value.set(h,d),n.uTroikaBlurRadius.value=c,n.uTroikaStrokeWidth.value=u,n.uTroikaStrokeOpacity.value=a,n.uTroikaFillOpacity.value=null==o?1:o,n.uTroikaCurveRadius.value=this.curveRadius||0;let f=this.clipRect;if(f&&Array.isArray(f)&&4===f.length)n.uTroikaClipRect.value.fromArray(f);else{const t=100*(this.fontSize||.1);n.uTroikaClipRect.value.set(i[0]-t,i[1]-t,i[2]+t,i[3]+t)}this.geometry.applyClipRect(n.uTroikaClipRect.value)}n.uTroikaSDFDebug.value=!!this.debugSDF,t.polygonOffset=!!this.depthOffset,t.polygonOffsetFactor=t.polygonOffsetUnits=this.depthOffset||0;const i=e?this.outlineColor||0:this.color;if(null==i)delete t.color;else{const e=t.hasOwnProperty("color")?t.color:t.color=new v;i===e._input&&"object"!=typeof i||e.set(e._input=i)}let o=this.orientation||tn;if(o!==t._orientation){let e=n.uTroikaOrient.value;o=o.replace(/[^-+xyz]/g,"");let r=o!==tn&&o.match(/^([-+])([xyz])([-+])([xyz])$/);if(r){let[,t,n,i,o]=r;Ze.set(0,0,0)[n]="-"===t?1:-1,Ke.set(0,0,0)[o]="-"===i?-1:1,$e.lookAt(Je,Ze.cross(Ke),Ke),e.setFromMatrix4($e)}else e.identity();t._orientation=o}}_parsePercent(t){if("string"==typeof t){let e=t.match(/^(-?[\d.]+)%$/),n=e?parseFloat(e[1]):NaN;t=(isNaN(n)?0:n/100)*this.fontSize}return t}localPositionToTextCoords(t,e=new f){e.copy(t);const n=this.curveRadius;return n&&(e.x=Math.atan2(t.x,Math.abs(n)-Math.abs(t.z))*Math.abs(n)),e}worldPositionToTextCoords(t,e=new f){return Ze.copy(t),this.localPositionToTextCoords(this.worldToLocal(Ze),e)}raycast(t,e){const{textRenderInfo:n,curveRadius:r}=this;if(n){const i=n.blockBounds,o=r?rn():nn(),a=o.geometry,{position:s,uv:l}=a.attributes;for(let t=0;t<l.count;t++){let e=i[0]+l.getX(t)*(i[2]-i[0]);const n=i[1]+l.getY(t)*(i[3]-i[1]);let o=0;r&&(o=r-Math.cos(e/r)*r,e=Math.sin(e/r)*r),s.setXYZ(t,e,n,o)}a.boundingSphere=this.geometry.boundingSphere,a.boundingBox=this.geometry.boundingBox,o.matrixWorld=this.matrixWorld,o.material.side=this.material.side,Qe.length=0,o.raycast(t,Qe);for(let t=0;t<Qe.length;t++)Qe[t].object=this,e.push(Qe[t])}}copy(t){const e=this.geometry;return super.copy(t),this.geometry=e,ln.forEach((e=>{this[e]=t[e]})),this}clone(){return(new this.constructor).copy(this)}}sn.forEach((t=>{const e="_private_"+t;Object.defineProperty(cn.prototype,t,{get(){return this[e]},set(t){t!==this[e]&&(this[e]=t,this._needsSync=!0)}})}));class un extends dt{set text(t){this.setAttributes({text:t})}set anchorX(t){this.setAttributes({anchorX:t})}set anchorY(t){this.setAttributes({anchorY:t})}set curveRadius(t){this.setAttributes({curveRadius:t})}set direction(t){this.setAttributes({direction:t})}set font(t){this.setAttributes({font:t})}set fontSize(t){this.setAttributes({fontSize:t})}set fontWeight(t){this.setAttributes({fontWeight:t})}set fontStyle(t){this.setAttributes({fontStyle:t})}set letterSpacing(t){this.setAttributes({letterSpacing:t})}set lineHeight(t){this.setAttributes({lineHeight:t})}set maxWidth(t){this.setAttributes({maxWidth:t})}set overflowWrap(t){this.setAttributes({overflowWrap:t})}set whiteSpace(t){this.setAttributes({whiteSpace:t})}set textAlign(t){this.setAttributes({textAlign:t})}set textIndent(t){this.setAttributes({textIndent:t})}set color(t){this.setAttributes({color:t})}set outlineWidth(t){this.setAttributes({outlineWidth:t})}set outlineColor(t){this.setAttributes({outlineColor:t})}set outlineOpacity(t){this.setAttributes({outlineOpacity:t})}set outlineBlur(t){this.setAttributes({outlineBlur:t})}set outlineOffsetX(t){this.setAttributes({outlineOffsetX:t})}set outlineOffsetY(t){this.setAttributes({outlineOffsetY:t})}set strokeWidth(t){this.setAttributes({strokeWidth:t})}set strokeColor(t){this.setAttributes({strokeColor:t})}set strokeOpacity(t){this.setAttributes({strokeOpacity:t})}set fillOpacity(t){this.setAttributes({fillOpacity:t})}set depthOffset(t){this.setAttributes({depthOffset:t})}set clipRect(t){this.setAttributes({clipRect:t})}set material(t){this.setAttributes({material:t})}get material(){return this._object3D.material}constructor(t,e={}){super(t,e),this._initialize(e)}setAttributes(t){const{text:e,anchorX:n,anchorY:r,curveRadius:i,direction:o,font:a,fontSize:s,fontWeight:l,fontStyle:c,lang:u,letterSpacing:h,lineHeight:d,maxWidth:f,overflowWrap:p,textAlign:v,textIndent:g,whiteSpace:m,material:y,color:_,outlineWidth:x,outlineColor:b,outlineOpacity:w,outlineBlur:S,outlineOffsetX:T,outlineOffsetY:U,strokeWidth:M,strokeColor:D,strokeOpacity:A,fillOpacity:C,depthOffset:P,clipRect:B,orientation:k,glyphGeometryDetail:F,sdfGlyphSize:I,position:E,scale:R,rotation:O,quaternion:G}=t,{_object3D:z}=this;ft(E)&&z.position.copy(E),ft(R)&&z.scale.copy(R),ft(O)&&z.rotation.copy(O),ft(G)&&z.quaternion.copy(G),ft(e)&&(z.text=e),ft(n)&&(z.anchorX=n),ft(r)&&(z.anchorY=r),ft(i)&&(z.curveRadius=i),ft(o)&&(z.direction=o),ft(a)&&(z.font=a),ft(s)&&(z.fontSize=s),ft(l)&&(z.fontWeight=l),ft(c)&&(z.fontStyle=c),ft(u)&&(z.lang=u),ft(h)&&(z.letterSpacing=h),ft(d)&&(z.lineHeight=d),ft(f)&&(z.maxWidth=f),ft(p)&&(z.overflowWrap=p),ft(v)&&(z.textAlign=v),ft(g)&&(z.textIndent=g),ft(m)&&(z.whiteSpace=m),ft(y)&&(z.material=y),ft(_)&&(z.color=_),ft(x)&&(z.outlineWidth=x),ft(b)&&(z.outlineColor=b),ft(w)&&(z.outlineOpacity=w),ft(S)&&(z.outlineBlur=S),ft(T)&&(z.outlineOffsetX=T),ft(U)&&(z.outlineOffsetY=U),ft(M)&&(z.strokeWidth=M),ft(D)&&(z.strokeColor=D),ft(A)&&(z.strokeOpacity=A),ft(C)&&(z.fillOpacity=C),ft(P)&&(z.depthOffset=P),ft(B)&&(z.clipRect=B),ft(k)&&(z.orientation=k),ft(F)&&(z.glyphGeometryDetail=F),ft(I)&&(z.sdfGlyphSize=I),z.sync()}raycast(t){const{_object3D:e}=this;if(!ft(e)||!e.visible)return null;const n=[];return e.raycast(t,n),n.length>0?(n.sort(((t,e)=>t.distance-e.distance)),n[0]):null}_initialize(t){const e=this._object3D=new cn;e.renderOrder=this._renderOrder,e.addEventListener("synccomplete",(()=>{this._boundsUpdateFlag.flag=!0,this.emit({type:"synccomplete"})})),this.setAttributes(t),this.entity.transform.object3D.add(e)}_destroy(){this._object3D.dispose(),this._object3D=null}}Ft([At()],un.prototype,"text",null),Ft([At()],un.prototype,"anchorX",null),Ft([At()],un.prototype,"anchorY",null),Ft([At()],un.prototype,"curveRadius",null),Ft([At()],un.prototype,"direction",null),Ft([At()],un.prototype,"font",null),Ft([At()],un.prototype,"fontSize",null),Ft([At()],un.prototype,"fontWeight",null),Ft([At()],un.prototype,"fontStyle",null),Ft([At()],un.prototype,"letterSpacing",null),Ft([At()],un.prototype,"lineHeight",null),Ft([At()],un.prototype,"maxWidth",null),Ft([At()],un.prototype,"overflowWrap",null),Ft([At()],un.prototype,"whiteSpace",null),Ft([At()],un.prototype,"textAlign",null),Ft([At()],un.prototype,"textIndent",null),Ft([At()],un.prototype,"color",null),Ft([At()],un.prototype,"outlineWidth",null),Ft([At()],un.prototype,"outlineColor",null),Ft([At()],un.prototype,"outlineOpacity",null),Ft([At()],un.prototype,"outlineBlur",null),Ft([At()],un.prototype,"outlineOffsetX",null),Ft([At()],un.prototype,"outlineOffsetY",null),Ft([At()],un.prototype,"strokeWidth",null),Ft([At()],un.prototype,"strokeColor",null),Ft([At()],un.prototype,"strokeOpacity",null),Ft([At()],un.prototype,"fillOpacity",null),Ft([At()],un.prototype,"depthOffset",null),Ft([At()],un.prototype,"clipRect",null),Ft([At()],un.prototype,"material",null);class hn extends dt{constructor(t,e){super(t,e),this._initialize(e)}raycast(t){return null}_initialize(t){const{scene:e}=this,{engine:n}=e,{resourceManager:r,uniformsLib:i}=n,{min:o=new u(-1,0,-1),max:a=new u(1,1,1),noise:s}=t,c=new b({uniforms:{boxMin:{value:o},boxMax:{value:a},noiseTexture:{value:null},time:i.time,resolution:i.viewport,cameraType:i.cameraType,cameraNearFar:i.cameraNearFar,cameraWorldMatrix:i.cameraWorldMatrix,cameraProjectionMatrix:i.cameraProjectionMatrix,cameraProjectionMatrixInverse:i.cameraProjectionMatrixInverse,cameraDepthTexture:i.cameraDepthTexture},vertexShader:"#define GLSLIFY 1\nvarying vec2 vUv;void main(){vUv=uv;gl_Position=vec4(position,1.0);}",fragmentShader:"#define GLSLIFY 1\n#include <packing>\n#define EPSILON 1e-6\nconst float bottom=0.0;const float top=30.0;const float width=20.0;uniform vec3 boxMin;uniform vec3 boxMax;uniform int cameraType;uniform vec2 cameraNearFar;uniform mat4 cameraWorldMatrix;uniform mat4 cameraProjectionMatrix;uniform mat4 cameraProjectionMatrixInverse;uniform sampler2D cameraDepthTexture;uniform sampler2D noiseTexture;varying vec2 vUv;float getViewZ(const in float depth){if(cameraType>0){return perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);}else{return orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);}}vec3 getWorldPosition(const in vec2 screenPosition,const in float depth,const in float viewZ){float clipW=cameraProjectionMatrix[2][3]*viewZ+cameraProjectionMatrix[3][3];vec4 clipPosition=vec4((vec3(screenPosition,depth)-0.5)*2.0,1.0);clipPosition*=clipW;vec4 worldPosition=cameraProjectionMatrixInverse*clipPosition;return(cameraWorldMatrix*worldPosition).xyz;}vec2 rayBoxDst(vec3 boxMin,vec3 boxMax,vec3 rayOrigin,vec3 rayDir){vec3 t0=(boxMin-rayOrigin)/rayDir;vec3 t1=(boxMax-rayOrigin)/rayDir;vec3 tmin=min(t0,t1);vec3 tmax=max(t0,t1);float dstA=max(max(tmin.x,tmin.y),tmin.z);float dstB=min(min(tmax.x,tmax.y),tmax.z);float dstToBox=max(0.0,dstA);float dstInBox=max(0.0,dstB-dstToBox);return vec2(dstToBox,dstInBox);}void main(){float depth=texture2D(cameraDepthTexture,vUv).r;\n#ifdef LOG_DEPTH\nfloat d=pow(2.0,depth*log2(cameraNearFar.y+1.0))-1.0;float a=cameraNearFar.y/(cameraNearFar.y-cameraNearFar.x);float b=cameraNearFar.y*cameraNearFar.x/(cameraNearFar.x-cameraNearFar. y);depth=a+b/d;\n#endif\nvec3 worldPosition=getWorldPosition(vUv,depth,getViewZ(depth));float depthEyeLinear=distance(worldPosition,cameraPosition);vec3 rayDir=normalize(worldPosition-cameraPosition);vec2 rayBoxInfo=rayBoxDst(boxMin,boxMax,cameraPosition,rayDir);float dstToBox=rayBoxInfo.x;float dstInBox=rayBoxInfo.y;float dstLimit=min(depthEyeLinear-dstToBox,dstInBox);if(dstLimit<EPSILON){gl_FragColor=vec4(0.0,1.0,0.0,0.5);}else{gl_FragColor=vec4(0.0,0.0,1.0,0.5);}}",transparent:!0,lights:!1,fog:!1});r.loadTexture(s).then((t=>{const e=t.reference().texture;e.wrapS=V,e.wrapT=V,c.uniforms.noiseTexture.value=e,c.needsUpdate=!0}));const h=this._object3D=new l(Ct(),c);h.frustumCulled=!1,h.renderOrder=this._renderOrder,this.entity.transform.object3D.add(h),e.on(pt.BEFORE_CAMERA_DEPTH_RENDER,this._beforeCameraDepthRender,{target:this}),e.on(pt.AFTER_CAMERA_DEPTH_RENDER,this._afterCameraDepthRender,{target:this})}_beforeCameraDepthRender(){this._object3D.visible=!1}_afterCameraDepthRender(){this._object3D.visible=!0}_destroy(){}}class dn extends _t{constructor(t,e={}){super(t);const{speed:n=1,rotationIntensity:r=1,floatingIntensity:i=1,floatingRange:o=[-.1,.1]}=e;this.speed=n,this.rotationIntensity=r,this.floatingIntensity=i,this.floatingRange=o,this._offset=1e4*Math.random()}onUpdate(t,n){var r,i;const{entity:o,speed:a,rotationIntensity:s,floatingIntensity:l,floatingRange:c,_offset:u}=this,{transform:h}=o,{object3D:d}=h,f=u+n,p=Math.cos(f/4*a)/8*s,v=Math.sin(f/4*a)/8*s,g=Math.sin(f/4*a)/20*s;let m=Math.sin(f/4*a)/10;m=e.mapLinear(m,-.1,.1,null!==(r=null==c?void 0:c[0])&&void 0!==r?r:-.1,null!==(i=null==c?void 0:c[1])&&void 0!==i?i:.1),d.position.y=m*l,d.rotation.set(p,v,g),h.updateWorldMatrix()}}const fn=2,pn=1.25,vn=32,gn=65535,mn=Math.pow(2,-24),yn=Symbol("SKIP_GENERATION");function _n(t){return t.index?t.index.count:t.attributes.position.count}function xn(t){return _n(t)/3}function bn(t,e=ArrayBuffer){return t>65535?new Uint32Array(new e(4*t)):new Uint16Array(new e(2*t))}function wn(t){const e=xn(t),n=t.drawRange,r=n.start/3,i=(n.start+n.count)/3,o=Math.max(0,r),a=Math.min(e,i)-o;return[{offset:Math.floor(o),count:Math.floor(a)}]}function Sn(t){if(!t.groups||!t.groups.length)return wn(t);const e=[],n=new Set,r=t.drawRange,i=r.start/3,o=(r.start+r.count)/3;for(const e of t.groups){const t=e.start/3,r=(e.start+e.count)/3;n.add(Math.max(i,t)),n.add(Math.min(o,r))}const a=Array.from(n.values()).sort(((t,e)=>t-e));for(let t=0;t<a.length-1;t++){const n=a[t],r=a[t+1];e.push({offset:Math.floor(n),count:Math.floor(r-n)})}return e}function Tn(t,e,n,r,i){let o=1/0,a=1/0,s=1/0,l=-1/0,c=-1/0,u=-1/0,h=1/0,d=1/0,f=1/0,p=-1/0,v=-1/0,g=-1/0;for(let r=6*e,i=6*(e+n);r<i;r+=6){const e=t[r+0],n=t[r+1],i=e-n,m=e+n;i<o&&(o=i),m>l&&(l=m),e<h&&(h=e),e>p&&(p=e);const y=t[r+2],_=t[r+3],x=y-_,b=y+_;x<a&&(a=x),b>c&&(c=b),y<d&&(d=y),y>v&&(v=y);const w=t[r+4],S=t[r+5],T=w-S,U=w+S;T<s&&(s=T),U>u&&(u=U),w<f&&(f=w),w>g&&(g=w)}r[0]=o,r[1]=a,r[2]=s,r[3]=l,r[4]=c,r[5]=u,i[0]=h,i[1]=d,i[2]=f,i[3]=p,i[4]=v,i[5]=g}function Un(t,e,n){return n.min.x=e[t],n.min.y=e[t+1],n.min.z=e[t+2],n.max.x=e[t+3],n.max.y=e[t+4],n.max.z=e[t+5],n}function Mn(t){let e=-1,n=-1/0;for(let r=0;r<3;r++){const i=t[r+3]-t[r];i>n&&(n=i,e=r)}return e}function Dn(t,e){e.set(t)}function An(t,e,n){let r,i;for(let o=0;o<3;o++){const a=o+3;r=t[o],i=e[o],n[o]=r<i?r:i,r=t[a],i=e[a],n[a]=r>i?r:i}}function Cn(t,e,n){for(let r=0;r<3;r++){const i=e[t+2*r],o=e[t+2*r+1],a=i-o,s=i+o;a<n[r]&&(n[r]=a),s>n[r+3]&&(n[r+3]=s)}}function Pn(t){const e=t[3]-t[0],n=t[4]-t[1],r=t[5]-t[2];return 2*(e*n+n*r+r*e)}const Bn=(t,e)=>t.candidate-e.candidate,kn=new Array(32).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),Fn=new Float32Array(6);class In{constructor(){this.boundingData=new Float32Array(6)}}function En(t,e,n,r,i,o){let a=r,s=r+i-1;const l=o.pos,c=2*o.axis;for(;;){for(;a<=s&&n[6*a+c]<l;)a++;for(;a<=s&&n[6*s+c]>=l;)s--;if(!(a<s))return a;for(let t=0;t<3;t++){let n=e[3*a+t];e[3*a+t]=e[3*s+t],e[3*s+t]=n}for(let t=0;t<6;t++){let e=n[6*a+t];n[6*a+t]=n[6*s+t],n[6*s+t]=e}a++,s--}}function Rn(t,e,n,r,i,o){let a=r,s=r+i-1;const l=o.pos,c=2*o.axis;for(;;){for(;a<=s&&n[6*a+c]<l;)a++;for(;a<=s&&n[6*s+c]>=l;)s--;if(!(a<s))return a;{let e=t[a];t[a]=t[s],t[s]=e;for(let t=0;t<6;t++){let e=n[6*a+t];n[6*a+t]=n[6*s+t],n[6*s+t]=e}a++,s--}}}function On(t,e){return 65535===e[t+15]}function Gn(t,e){return e[t+6]}function zn(t,e){return e[t+14]}function Ln(t){return t+8}function Nn(t,e){return e[t+6]}function jn(t,e){return e[t+7]}let Wn,Hn,Vn,qn;const Xn=Math.pow(2,32);function Yn(t){return"count"in t?1:1+Yn(t.left)+Yn(t.right)}function $n(t,e,n){return Wn=new Float32Array(n),Hn=new Uint32Array(n),Vn=new Uint16Array(n),qn=new Uint8Array(n),Zn(t,e)}function Zn(t,e){const n=t/4,r=t/2,i="count"in e,o=e.boundingData;for(let t=0;t<6;t++)Wn[n+t]=o[t];if(i){if(e.buffer){const r=e.buffer;qn.set(new Uint8Array(r),t);for(let e=t,i=t+r.byteLength;e<i;e+=vn)On(e/2,Vn)||(Hn[e/4+6]+=n);return t+r.byteLength}{const i=e.offset,o=e.count;return Hn[n+6]=i,Vn[r+14]=o,Vn[r+15]=gn,t+vn}}{const r=e.left,i=e.right,o=e.splitAxis;let a;if(a=Zn(t+vn,r),a/4>Xn)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return Hn[n+6]=a/4,a=Zn(a,i),Hn[n+7]=o,a}}function Kn(t,e){const n=t.geometry;e.indirect&&(t._indirectBuffer=function(t,e){const n=(t.index?t.index.count:t.attributes.position.count)/3,r=n>65536,i=r?4:2,o=e?new SharedArrayBuffer(n*i):new ArrayBuffer(n*i),a=r?new Uint32Array(o):new Uint16Array(o);for(let t=0,e=a.length;t<e;t++)a[t]=t;return a}(n,e.useSharedArrayBuffer),function(t){if(0===t.groups.length)return!1;const e=xn(t),n=Sn(t).sort(((t,e)=>t.offset-e.offset)),r=n[n.length-1];r.count=Math.min(e-r.offset,r.count);let i=0;return n.forEach((({count:t})=>i+=t)),e!==i}(n)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),t._indirectBuffer||function(t,e){if(!t.index){const n=t.attributes.position.count,r=bn(n,e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);t.setIndex(new q(r,1));for(let t=0;t<n;t++)r[t]=t}}(n,e);const r=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=function(t,e=null,n=null,r=null){const i=t.attributes.position,o=t.index?t.index.array:null,a=xn(t),s=i.normalized;let l;null===e?(l=new Float32Array(6*a*4),n=0,r=a):(l=e,n=n||0,r=r||a);const c=i.array,u=i.offset||0;let h=3;i.isInterleavedBufferAttribute&&(h=i.data.stride);const d=["getX","getY","getZ"];for(let t=n;t<n+r;t++){const e=3*t,n=6*t;let r=e+0,a=e+1,f=e+2;o&&(r=o[r],a=o[a],f=o[f]),s||(r=r*h+u,a=a*h+u,f=f*h+u);for(let t=0;t<3;t++){let e,o,u;s?(e=i[d[t]](r),o=i[d[t]](a),u=i[d[t]](f)):(e=c[r+t],o=c[a+t],u=c[f+t]);let h=e;o<h&&(h=o),u<h&&(h=u);let p=e;o>p&&(p=o),u>p&&(p=u);const v=(p-h)/2,g=2*t;l[n+g+0]=h+v,l[n+g+1]=v+(Math.abs(h)+v)*mn}}return l}(n),o=e.indirect?wn(n):Sn(n);t._roots=o.map((n=>{const o=function(t,e,n,r,i){const{maxDepth:o,verbose:a,maxLeafTris:s,strategy:l,onProgress:c,indirect:u}=i,h=t._indirectBuffer,d=t.geometry,f=d.index?d.index.array:null,p=u?Rn:En,v=xn(d),g=new Float32Array(6);let m=!1;const y=new In;return Tn(e,n,r,y.boundingData,g),function t(n,r,i,c=null,u=0){if(!m&&u>=o&&(m=!0,a&&(console.warn(`MeshBVH: Max depth of ${o} reached when generating BVH. Consider increasing maxDepth.`),console.warn(d))),i<=s||u>=o)return _(r+i),n.offset=r,n.count=i,n;const v=function(t,e,n,r,i,o){let a=-1,s=0;if(0===o)a=Mn(e),-1!==a&&(s=(e[a]+e[a+3])/2);else if(1===o)a=Mn(t),-1!==a&&(s=function(t,e,n,r){let i=0;for(let o=e,a=e+n;o<a;o++)i+=t[6*o+2*r];return i/n}(n,r,i,a));else if(2===o){const o=Pn(t);let l=pn*i;const c=6*r,u=6*(r+i);for(let t=0;t<3;t++){const r=e[t],h=(e[t+3]-r)/32;if(i<8){const e=[...kn];e.length=i;let r=0;for(let i=c;i<u;i+=6,r++){const o=e[r];o.candidate=n[i+2*t],o.count=0;const{bounds:a,leftCacheBounds:s,rightCacheBounds:l}=o;for(let t=0;t<3;t++)l[t]=1/0,l[t+3]=-1/0,s[t]=1/0,s[t+3]=-1/0,a[t]=1/0,a[t+3]=-1/0;Cn(i,n,a)}e.sort(Bn);let h=i;for(let t=0;t<h;t++){const n=e[t];for(;t+1<h&&e[t+1].candidate===n.candidate;)e.splice(t+1,1),h--}for(let r=c;r<u;r+=6){const i=n[r+2*t];for(let t=0;t<h;t++){const o=e[t];i>=o.candidate?Cn(r,n,o.rightCacheBounds):(Cn(r,n,o.leftCacheBounds),o.count++)}}for(let n=0;n<h;n++){const r=e[n],c=r.count,u=i-r.count,h=r.leftCacheBounds,d=r.rightCacheBounds;let f=0;0!==c&&(f=Pn(h)/o);let p=0;0!==u&&(p=Pn(d)/o);const v=1+pn*(f*c+p*u);v<l&&(a=t,l=v,s=r.candidate)}}else{for(let t=0;t<32;t++){const e=kn[t];e.count=0,e.candidate=r+h+t*h;const n=e.bounds;for(let t=0;t<3;t++)n[t]=1/0,n[t+3]=-1/0}for(let e=c;e<u;e+=6){let i=~~((n[e+2*t]-r)/h);i>=32&&(i=31);const o=kn[i];o.count++,Cn(e,n,o.bounds)}const e=kn[31];Dn(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){const e=kn[t],n=kn[t+1];An(e.bounds,n.rightCacheBounds,e.rightCacheBounds)}let d=0;for(let e=0;e<31;e++){const n=kn[e],r=n.count,c=n.bounds,u=kn[e+1].rightCacheBounds;0!==r&&(0===d?Dn(c,Fn):An(c,Fn,Fn)),d+=r;let h=0,f=0;0!==d&&(h=Pn(Fn)/o);const p=i-d;0!==p&&(f=Pn(u)/o);const v=1+pn*(h*d+f*p);v<l&&(a=t,l=v,s=n.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${o} used.`);return{axis:a,pos:s}}(n.boundingData,c,e,r,i,l);if(-1===v.axis)return _(r+i),n.offset=r,n.count=i,n;const y=p(h,f,e,r,i,v);if(y===r||y===r+i)_(r+i),n.offset=r,n.count=i;else{n.splitAxis=v.axis;const o=new In,a=r,s=y-r;n.left=o,Tn(e,a,s,o.boundingData,g),t(o,a,s,g,u+1);const l=new In,c=y,h=i-s;n.right=l,Tn(e,c,h,l.boundingData,g),t(l,c,h,g,u+1)}return n}(y,n,r,g),y;function _(t){c&&c(t/v)}}(t,i,n.offset,n.count,e),a=Yn(o),s=new r(vn*a);return $n(0,o,s),s}))}class Qn{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let n=1/0,r=-1/0;for(let i=0,o=t.length;i<o;i++){const o=t[i][e];n=o<n?o:n,r=o>r?o:r}this.min=n,this.max=r}setFromPoints(t,e){let n=1/0,r=-1/0;for(let i=0,o=e.length;i<o;i++){const o=e[i],a=t.dot(o);n=a<n?a:n,r=a>r?a:r}this.min=n,this.max=r}isSeparated(t){return this.min>t.max||t.min>this.max}}Qn.prototype.setFromBox=function(){const t=new u;return function(e,n){const r=n.min,i=n.max;let o=1/0,a=-1/0;for(let n=0;n<=1;n++)for(let s=0;s<=1;s++)for(let l=0;l<=1;l++){t.x=r.x*n+i.x*(1-n),t.y=r.y*s+i.y*(1-s),t.z=r.z*l+i.z*(1-l);const c=e.dot(t);o=Math.min(c,o),a=Math.max(c,a)}this.min=o,this.max=a}}(),new Qn;const Jn=function(){const t=new u,e=new u,n=new u;return function(r,i,o){const a=r.start,s=t,l=i.start,c=e;n.subVectors(a,l),t.subVectors(r.end,r.start),e.subVectors(i.end,i.start);const u=n.dot(c),h=c.dot(s),d=c.dot(c),f=n.dot(s),p=s.dot(s)*d-h*h;let v,g;v=0!==p?(u*h-f*d)/p:0,g=(u+v*h)/d,o.x=v,o.y=g}}(),tr=function(){const t=new f,e=new u,n=new u;return function(r,i,o,a){Jn(r,i,t);let s=t.x,l=t.y;if(s>=0&&s<=1&&l>=0&&l<=1)return r.at(s,o),void i.at(l,a);if(s>=0&&s<=1)return l<0?i.at(0,a):i.at(1,a),void r.closestPointToPoint(a,!0,o);if(l>=0&&l<=1)return s<0?r.at(0,o):r.at(1,o),void i.closestPointToPoint(o,!0,a);{let t,c;t=s<0?r.start:r.end,c=l<0?i.start:i.end;const u=e,h=n;return r.closestPointToPoint(c,!0,e),i.closestPointToPoint(t,!0,n),u.distanceToSquared(c)<=h.distanceToSquared(t)?(o.copy(u),void a.copy(c)):(o.copy(t),void a.copy(h))}}}(),er=function(){const t=new u,e=new u,n=new c,r=new X;return function(i,o){const{radius:a,center:s}=i,{a:l,b:c,c:u}=o;if(r.start=l,r.end=c,r.closestPointToPoint(s,!0,t).distanceTo(s)<=a)return!0;if(r.start=l,r.end=u,r.closestPointToPoint(s,!0,t).distanceTo(s)<=a)return!0;if(r.start=c,r.end=u,r.closestPointToPoint(s,!0,t).distanceTo(s)<=a)return!0;const h=o.getPlane(n);if(Math.abs(h.distanceToPoint(s))<=a){const t=h.projectPoint(s,e);if(o.containsPoint(t))return!0}return!1}}();function nr(t){return Math.abs(t)<1e-15}class rr extends Y{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new u)),this.satBounds=new Array(4).fill().map((()=>new Qn)),this.points=[this.a,this.b,this.c],this.sphere=new O,this.plane=new c,this.needsUpdate=!0}intersectsSphere(t){return er(t,this)}update(){const t=this.a,e=this.b,n=this.c,r=this.points,i=this.satAxes,o=this.satBounds,a=i[0],s=o[0];this.getNormal(a),s.setFromPoints(a,r);const l=i[1],c=o[1];l.subVectors(t,e),c.setFromPoints(l,r);const u=i[2],h=o[2];u.subVectors(e,n),h.setFromPoints(u,r);const d=i[3],f=o[3];d.subVectors(n,t),f.setFromPoints(d,r),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,t),this.needsUpdate=!1}}rr.prototype.closestPointToSegment=function(){const t=new u,e=new u,n=new X;return function(r,i=null,o=null){const{start:a,end:s}=r,l=this.points;let c,u=1/0;for(let a=0;a<3;a++){const s=(a+1)%3;n.start.copy(l[a]),n.end.copy(l[s]),tr(n,r,t,e),c=t.distanceToSquared(e),c<u&&(u=c,i&&i.copy(t),o&&o.copy(e))}return this.closestPointToPoint(a,t),c=a.distanceToSquared(t),c<u&&(u=c,i&&i.copy(t),o&&o.copy(a)),this.closestPointToPoint(s,t),c=s.distanceToSquared(t),c<u&&(u=c,i&&i.copy(t),o&&o.copy(s)),Math.sqrt(u)}}(),rr.prototype.intersectsTriangle=function(){const t=new rr,e=new Array(3),n=new Array(3),r=new Qn,i=new Qn,o=new u,a=new u,s=new u,l=new u,c=new u,h=new X,d=new X,f=new X,p=new u;function v(t,e,n){const r=t.points;let i=0,o=-1;for(let t=0;t<3;t++){const{start:s,end:l}=h;s.copy(r[t]),l.copy(r[(t+1)%3]),h.delta(a);const c=nr(e.distanceToPoint(s));if(nr(e.normal.dot(a))&&c){n.copy(h),i=2;break}const u=e.intersectLine(h,p);if(!u&&c&&p.copy(s),(u||c)&&!nr(p.distanceTo(l))){if(i<=1)(1===i?n.start:n.end).copy(p),c&&(o=i);else if(i>=2){(1===o?n.start:n.end).copy(p),i=2;break}if(i++,2===i&&-1===o)break}}return i}return function(a,u=null,h=!1){this.needsUpdate&&this.update(),a.isExtendedTriangle?a.needsUpdate&&a.update():(t.copy(a),t.update(),a=t);const p=this.plane,g=a.plane;if(Math.abs(p.normal.dot(g.normal))>1-1e-10){const t=this.satBounds,s=this.satAxes;n[0]=a.a,n[1]=a.b,n[2]=a.c;for(let e=0;e<4;e++){const i=t[e],o=s[e];if(r.setFromPoints(o,n),i.isSeparated(r))return!1}const l=a.satBounds,c=a.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let t=0;t<4;t++){const n=l[t],i=c[t];if(r.setFromPoints(i,e),n.isSeparated(r))return!1}for(let t=0;t<4;t++){const a=s[t];for(let t=0;t<4;t++){const s=c[t];if(o.crossVectors(a,s),r.setFromPoints(o,e),i.setFromPoints(o,n),r.isSeparated(i))return!1}}return u&&(h||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),u.start.set(0,0,0),u.end.set(0,0,0)),!0}{const t=v(this,g,d);if(1===t&&a.containsPoint(d.end))return u&&(u.start.copy(d.end),u.end.copy(d.end)),!0;if(2!==t)return!1;const e=v(a,p,f);if(1===e&&this.containsPoint(f.end))return u&&(u.start.copy(f.end),u.end.copy(f.end)),!0;if(2!==e)return!1;if(d.delta(s),f.delta(l),s.dot(l)<0){let t=f.start;f.start=f.end,f.end=t}const n=d.start.dot(s),r=d.end.dot(s),i=f.start.dot(s),o=f.end.dot(s);return(n===o||i===r||r<i!=n<o)&&(u&&(c.subVectors(d.start,f.start),c.dot(s)>0?u.start.copy(d.start):u.start.copy(f.start),c.subVectors(d.end,f.end),c.dot(s)<0?u.end.copy(d.end):u.end.copy(f.end)),!0)}}}(),rr.prototype.distanceToPoint=function(){const t=new u;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),rr.prototype.distanceToTriangle=function(){const t=new u,e=new u,n=["a","b","c"],r=new X,i=new X;return function(o,a=null,s=null){const l=a||s?r:null;if(this.intersectsTriangle(o,l))return(a||s)&&(a&&l.getCenter(a),s&&l.getCenter(s)),0;let c=1/0;for(let e=0;e<3;e++){let r;const i=n[e],l=o[i];this.closestPointToPoint(l,t),r=l.distanceToSquared(t),r<c&&(c=r,a&&a.copy(t),s&&s.copy(l));const u=this[i];o.closestPointToPoint(u,t),r=u.distanceToSquared(t),r<c&&(c=r,a&&a.copy(u),s&&s.copy(t))}for(let l=0;l<3;l++){const u=n[l],h=n[(l+1)%3];r.set(this[u],this[h]);for(let l=0;l<3;l++){const u=n[l],h=n[(l+1)%3];i.set(o[u],o[h]),tr(r,i,t,e);const d=t.distanceToSquared(e);d<c&&(c=d,a&&a.copy(t),s&&s.copy(e))}}return Math.sqrt(c)}}();class ir{constructor(t,e,n){this.isOrientedBox=!0,this.min=new u,this.max=new u,this.matrix=new H,this.invMatrix=new H,this.points=new Array(8).fill().map((()=>new u)),this.satAxes=new Array(3).fill().map((()=>new u)),this.satBounds=new Array(3).fill().map((()=>new Qn)),this.alignedSatBounds=new Array(3).fill().map((()=>new Qn)),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),n&&this.matrix.copy(n)}set(t,e,n){this.min.copy(t),this.max.copy(e),this.matrix.copy(n),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}ir.prototype.update=function(){const t=this.matrix,e=this.min,n=this.max,r=this.points;for(let i=0;i<=1;i++)for(let o=0;o<=1;o++)for(let a=0;a<=1;a++){const s=r[1*i|2*o|4*a];s.x=i?n.x:e.x,s.y=o?n.y:e.y,s.z=a?n.z:e.z,s.applyMatrix4(t)}const i=this.satBounds,o=this.satAxes,a=r[0];for(let t=0;t<3;t++){const e=o[t],n=i[t],s=r[1<<t];e.subVectors(a,s),n.setFromPoints(e,r)}const s=this.alignedSatBounds;s[0].setFromPointsField(r,"x"),s[1].setFromPointsField(r,"y"),s[2].setFromPointsField(r,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},ir.prototype.intersectsBox=function(){const t=new Qn;return function(e){this.needsUpdate&&this.update();const n=e.min,r=e.max,i=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(t.min=n.x,t.max=r.x,a[0].isSeparated(t))return!1;if(t.min=n.y,t.max=r.y,a[1].isSeparated(t))return!1;if(t.min=n.z,t.max=r.z,a[2].isSeparated(t))return!1;for(let n=0;n<3;n++){const r=o[n],a=i[n];if(t.setFromBox(r,e),a.isSeparated(t))return!1}return!0}}(),ir.prototype.intersectsTriangle=function(){const t=new rr,e=new Array(3),n=new Qn,r=new Qn,i=new u;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(t.copy(o),t.update(),o=t);const a=this.satBounds,s=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let t=0;t<3;t++){const r=a[t],i=s[t];if(n.setFromPoints(i,e),r.isSeparated(n))return!1}const l=o.satBounds,c=o.satAxes,u=this.points;for(let t=0;t<3;t++){const e=l[t],r=c[t];if(n.setFromPoints(r,u),e.isSeparated(n))return!1}for(let t=0;t<3;t++){const o=s[t];for(let t=0;t<4;t++){const a=c[t];if(i.crossVectors(o,a),n.setFromPoints(i,e),r.setFromPoints(i,u),n.isSeparated(r))return!1}}return!0}}(),ir.prototype.closestPointToPoint=function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e},ir.prototype.distanceToPoint=function(){const t=new u;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),ir.prototype.distanceToBox=function(){const t=["x","y","z"],e=new Array(12).fill().map((()=>new X)),n=new Array(12).fill().map((()=>new X)),r=new u,i=new u;return function(o,a=0,s=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(s||l)&&(o.getCenter(i),this.closestPointToPoint(i,r),o.closestPointToPoint(r,i),s&&s.copy(r),l&&l.copy(i)),0;const c=a*a,u=o.min,h=o.max,d=this.points;let f=1/0;for(let t=0;t<8;t++){const e=d[t];i.copy(e).clamp(u,h);const n=e.distanceToSquared(i);if(n<f&&(f=n,s&&s.copy(e),l&&l.copy(i),n<c))return Math.sqrt(n)}let p=0;for(let r=0;r<3;r++)for(let i=0;i<=1;i++)for(let o=0;o<=1;o++){const a=(r+1)%3,s=(r+2)%3,l=1<<r|i<<a|o<<s,c=d[i<<a|o<<s],f=d[l];e[p].set(c,f);const v=t[r],g=t[a],m=t[s],y=n[p],_=y.start,x=y.end;_[v]=u[v],_[g]=i?u[g]:h[g],_[m]=o?u[m]:h[g],x[v]=h[v],x[g]=i?u[g]:h[g],x[m]=o?u[m]:h[g],p++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let n=0;n<=1;n++){i.x=t?h.x:u.x,i.y=e?h.y:u.y,i.z=n?h.z:u.z,this.closestPointToPoint(i,r);const o=i.distanceToSquared(r);if(o<f&&(f=o,s&&s.copy(r),l&&l.copy(i),o<c))return Math.sqrt(o)}for(let t=0;t<12;t++){const o=e[t];for(let t=0;t<12;t++){const e=n[t];tr(o,e,r,i);const a=r.distanceToSquared(i);if(a<f&&(f=a,s&&s.copy(r),l&&l.copy(i),a<c))return Math.sqrt(a)}}return Math.sqrt(f)}}();class or{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class ar extends or{constructor(){super((()=>new rr))}}const sr=new ar,lr=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=n=>{e&&t.push(e),e=n,this.float32Array=new Float32Array(n),this.uint16Array=new Uint16Array(n),this.uint32Array=new Uint32Array(n)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==t.length&&this.setBuffer(t.pop())}}};let cr,ur;const hr=[],dr=new or((()=>new G));function fr(t,e,n,r,i,o){cr=dr.getPrimitive(),ur=dr.getPrimitive(),hr.push(cr,ur),lr.setBuffer(t._roots[e]);const a=pr(0,t.geometry,n,r,i,o);lr.clearBuffer(),dr.releasePrimitive(cr),dr.releasePrimitive(ur),hr.pop(),hr.pop();const s=hr.length;return s>0&&(ur=hr[s-1],cr=hr[s-2]),a}function pr(t,e,n,r,i=null,o=0,a=0){const{float32Array:s,uint16Array:l,uint32Array:c}=lr;let u=2*t;if(On(u,l)){const h=Gn(t,c),d=zn(u,l);return Un(t,s,cr),r(h,d,!1,a,o+t,cr)}{const f=Ln(t),p=Nn(t,c);let v,g,m,y,_=f,x=p;if(i&&(m=cr,y=ur,Un(_,s,m),Un(x,s,y),v=i(m),g=i(y),g<v)){_=p,x=f;const D=v;v=g,g=D,m=y}m||(m=cr,Un(_,s,m));const b=n(m,On(2*_,l),v,a+1,o+_);let w;if(b===fn){const A=U(_);w=r(A,M(_)-A,!0,a+1,o+_,m)}else w=b&&pr(_,e,n,r,i,o,a+1);if(w)return!0;y=ur,Un(x,s,y);const S=n(y,On(2*x,l),g,a+1,o+x);let T;if(S===fn){const C=U(x);T=r(C,M(x)-C,!0,a+1,o+x,y)}else T=S&&pr(x,e,n,r,i,o,a+1);return!!T;function U(t){const{uint16Array:e,uint32Array:n}=lr;let r=2*t;for(;!On(r,e);)r=2*(t=Ln(t));return Gn(t,n)}function M(t){const{uint16Array:e,uint32Array:n}=lr;let r=2*t;for(;!On(r,e);)r=2*(t=Nn(t,n));return Gn(t,n)+zn(r,e)}}}const vr=new u,gr=new u,mr=new u,yr=new u,_r=new u,xr=new f,br=new f,wr=new f,Sr=new u,Tr=new u,Ur=new u,Mr=new u;function Dr(t,e,n,r,i){const o=3*r;let a=o+0,s=o+1,l=o+2;const c=t.index;t.index&&(a=c.getX(a),s=c.getX(s),l=c.getX(l));const{position:h,normal:d,uv:p,uv1:v}=t.attributes,g=function(t,e,n,r,i,o,a,s,l){mr.fromBufferAttribute(e,o),yr.fromBufferAttribute(e,a),_r.fromBufferAttribute(e,s);const c=function(t,e,n,r,i,o){let a;return a=o===z?t.intersectTriangle(r,n,e,!0,i):t.intersectTriangle(e,n,r,o!==L,i),null===a?null:{distance:t.origin.distanceTo(i),point:i.clone()}}(t,mr,yr,_r,Mr,l);if(c){r&&(xr.fromBufferAttribute(r,o),br.fromBufferAttribute(r,a),wr.fromBufferAttribute(r,s),c.uv=Y.getInterpolation(Mr,mr,yr,_r,xr,br,wr,new f)),i&&(xr.fromBufferAttribute(i,o),br.fromBufferAttribute(i,a),wr.fromBufferAttribute(i,s),c.uv1=Y.getInterpolation(Mr,mr,yr,_r,xr,br,wr,new f)),n&&(Sr.fromBufferAttribute(n,o),Tr.fromBufferAttribute(n,a),Ur.fromBufferAttribute(n,s),c.normal=Y.getInterpolation(Mr,mr,yr,_r,Sr,Tr,Ur,new u),c.normal.dot(t.direction)>0&&c.normal.multiplyScalar(-1));const e={a:o,b:a,c:s,normal:new u,materialIndex:0};Y.getNormal(mr,yr,_r,e.normal),c.face=e,c.faceIndex=o}return c}(n,h,d,p,v,a,s,l,e);return g?(g.faceIndex=r,i&&i.push(g),g):null}function Ar(t,e,n,r){const i=t.a,o=t.b,a=t.c;let s=e,l=e+1,c=e+2;n&&(s=n.getX(s),l=n.getX(l),c=n.getX(c)),i.x=r.getX(s),i.y=r.getY(s),i.z=r.getZ(s),o.x=r.getX(l),o.y=r.getY(l),o.z=r.getZ(l),a.x=r.getX(c),a.y=r.getY(c),a.z=r.getZ(c)}function Cr(t,e,n,r,i,o,a){const{geometry:s}=n,{index:l}=s,c=s.attributes.position;for(let n=t,s=e+t;n<s;n++){let t;if(t=n,Ar(a,3*t,l,c),a.needsUpdate=!0,r(a,t,i,o))return!0}return!1}function Pr(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const n=t.geometry,r=n.index?n.index.array:null,i=n.attributes.position;let o,a,s,l,c=0;const u=t._roots;for(let t=0,e=u.length;t<e;t++)o=u[t],a=new Uint32Array(o),s=new Uint16Array(o),l=new Float32Array(o),h(0,c),c+=o.byteLength;function h(t,n,o=!1){const c=2*t;if(s[c+15]===gn){const e=a[t+6];let n=1/0,o=1/0,u=1/0,h=-1/0,d=-1/0,f=-1/0;for(let t=3*e,a=3*(e+s[c+14]);t<a;t++){let e=r[t];const a=i.getX(e),s=i.getY(e),l=i.getZ(e);a<n&&(n=a),a>h&&(h=a),s<o&&(o=s),s>d&&(d=s),l<u&&(u=l),l>f&&(f=l)}return(l[t+0]!==n||l[t+1]!==o||l[t+2]!==u||l[t+3]!==h||l[t+4]!==d||l[t+5]!==f)&&(l[t+0]=n,l[t+1]=o,l[t+2]=u,l[t+3]=h,l[t+4]=d,l[t+5]=f,!0)}{const r=t+8,i=a[t+6],s=r+n,c=i+n;let u=o,d=!1,f=!1;e?u||(d=e.has(s),f=e.has(c),u=!d&&!f):(d=!0,f=!0);const p=u||f;let v=!1;(u||d)&&(v=h(r,n,u));let g=!1;p&&(g=h(i,n,u));const m=v||g;if(m)for(let e=0;e<3;e++){const n=r+e,o=i+e,a=l[n],s=l[n+3],c=l[o],u=l[o+3];l[t+e]=a<c?a:c,l[t+e+3]=s>u?s:u}return m}}}const Br=new G;function kr(t,e,n,r){return Un(t,e,Br),n.intersectBox(Br,r)}function Fr(t,e,n,r,i,o,a){const{geometry:s}=n,{index:l}=s,c=s.attributes.position;for(let s=t,u=e+t;s<u;s++){let t;if(t=n.resolveTriangleIndex(s),Ar(a,3*t,l,c),a.needsUpdate=!0,r(a,t,i,o))return!0}return!1}const Ir=new u;function Er(t,e,n,r,i){lr.setBuffer(t._roots[e]),Rr(0,t,n,r,i),lr.clearBuffer()}function Rr(t,e,n,r,i){const{float32Array:o,uint16Array:a,uint32Array:s}=lr,l=2*t;if(On(l,a))!function(t,e,n,r,i,o){const{geometry:a,_indirectBuffer:s}=t;for(let t=r,s=r+i;t<s;t++)Dr(a,e,n,t,o)}(e,n,r,Gn(t,s),zn(l,a),i);else{const a=Ln(t);kr(a,o,r,Ir)&&Rr(a,e,n,r,i);const l=Nn(t,s);kr(l,o,r,Ir)&&Rr(l,e,n,r,i)}}const Or=new u,Gr=["x","y","z"];function zr(t,e,n,r){lr.setBuffer(t._roots[e]);const i=Lr(0,t,n,r);return lr.clearBuffer(),i}function Lr(t,e,n,r){const{float32Array:i,uint16Array:o,uint32Array:a}=lr;let s=2*t;if(On(s,o))return function(t,e,n,r,i){const{geometry:o,_indirectBuffer:a}=t;let s=1/0,l=null;for(let t=r,a=r+i;t<a;t++){let r;r=Dr(o,e,n,t),r&&r.distance<s&&(l=r,s=r.distance)}return l}(e,n,r,Gn(t,a),zn(s,o));{const o=jn(t,a),s=Gr[o],l=r.direction[s]>=0;let c,u;l?(c=Ln(t),u=Nn(t,a)):(c=Nn(t,a),u=Ln(t));const h=kr(c,i,r,Or)?Lr(c,e,n,r):null;if(h){const t=h.point[s];if(l?t<=i[u+o]:t>=i[u+o+3])return h}const d=kr(u,i,r,Or)?Lr(u,e,n,r):null;return h&&d?h.distance<=d.distance?h:d:h||d||null}}const Nr=new G,jr=new rr,Wr=new rr,Hr=new H,Vr=new ir,qr=new ir;function Xr(t,e,n,r){lr.setBuffer(t._roots[e]);const i=Yr(0,t,n,r);return lr.clearBuffer(),i}function Yr(t,e,n,r,i=null){const{float32Array:o,uint16Array:a,uint32Array:s}=lr;let l=2*t;if(null===i&&(n.boundingBox||n.computeBoundingBox(),Vr.set(n.boundingBox.min,n.boundingBox.max,r),i=Vr),!On(l,a)){const a=t+8,l=s[t+6];return Un(a,o,Nr),!!(i.intersectsBox(Nr)&&Yr(a,e,n,r,i)||(Un(l,o,Nr),i.intersectsBox(Nr)&&Yr(l,e,n,r,i)))}{const i=e.geometry,c=i.index,u=i.attributes.position,h=n.index,d=n.attributes.position,f=Gn(t,s),p=zn(l,a);if(Hr.copy(r).invert(),n.boundsTree)return Un(t,o,qr),qr.matrix.copy(Hr),qr.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:t=>qr.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(r),t.b.applyMatrix4(r),t.c.applyMatrix4(r),t.needsUpdate=!0;for(let e=3*f,n=3*(p+f);e<n;e+=3)if(Ar(Wr,e,c,u),Wr.needsUpdate=!0,t.intersectsTriangle(Wr))return!0;return!1}});for(let t=3*f,e=3*(p+f);t<e;t+=3){Ar(jr,t,c,u),jr.a.applyMatrix4(Hr),jr.b.applyMatrix4(Hr),jr.c.applyMatrix4(Hr),jr.needsUpdate=!0;for(let t=0,e=h.count;t<e;t+=3)if(Ar(Wr,t,h,d),Wr.needsUpdate=!0,jr.intersectsTriangle(Wr))return!0}}}const $r=new H,Zr=new ir,Kr=new ir,Qr=new u,Jr=new u,ti=new u,ei=new u;function ni(t,e,n,r={},i={},o=0,a=1/0){e.boundingBox||e.computeBoundingBox(),Zr.set(e.boundingBox.min,e.boundingBox.max,n),Zr.needsUpdate=!0;const s=t.geometry,l=s.attributes.position,c=s.index,u=e.attributes.position,h=e.index,d=sr.getPrimitive(),f=sr.getPrimitive();let p=Qr,v=Jr,g=null,m=null;i&&(g=ti,m=ei);let y=1/0,_=null,x=null;return $r.copy(n).invert(),Kr.matrix.copy($r),t.shapecast({boundsTraverseOrder:t=>Zr.distanceToBox(t),intersectsBounds:(t,e,n)=>n<y&&n<a&&(e&&(Kr.min.copy(t.min),Kr.max.copy(t.max),Kr.needsUpdate=!0),!0),intersectsRange:(t,r)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:t=>Kr.distanceToBox(t),intersectsBounds:(t,e,n)=>n<y&&n<a,intersectsRange:(e,i)=>{for(let a=e,s=e+i;a<s;a++){Ar(f,3*a,h,u),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let e=t,n=t+r;e<n;e++){Ar(d,3*e,c,l),d.needsUpdate=!0;const t=d.distanceToTriangle(f,p,g);if(t<y&&(v.copy(p),m&&m.copy(g),y=t,_=e,x=a),t<o)return!0}}}});for(let i=0,a=xn(e);i<a;i++){Ar(f,3*i,h,u),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let e=t,n=t+r;e<n;e++){Ar(d,3*e,c,l),d.needsUpdate=!0;const t=d.distanceToTriangle(f,p,g);if(t<y&&(v.copy(p),m&&m.copy(g),y=t,_=e,x=i),t<o)return!0}}}}),sr.releasePrimitive(d),sr.releasePrimitive(f),y===1/0?null:(r.point?r.point.copy(v):r.point=v.clone(),r.distance=y,r.faceIndex=_,i&&(i.point?i.point.copy(m):i.point=m.clone(),i.point.applyMatrix4($r),v.applyMatrix4($r),i.distance=v.sub(i.point).length(),i.faceIndex=x),r)}function ri(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const n=t.geometry,r=n.index?n.index.array:null,i=n.attributes.position;let o,a,s,l,c=0;const u=t._roots;for(let t=0,e=u.length;t<e;t++)o=u[t],a=new Uint32Array(o),s=new Uint16Array(o),l=new Float32Array(o),h(0,c),c+=o.byteLength;function h(n,o,c=!1){const u=2*n;if(s[u+15]===gn){const e=a[n+6];let o=1/0,c=1/0,h=1/0,d=-1/0,f=-1/0,p=-1/0;for(let n=e,a=e+s[u+14];n<a;n++){const e=3*t.resolveTriangleIndex(n);for(let t=0;t<3;t++){let n=e+t;n=r?r[n]:n;const a=i.getX(n),s=i.getY(n),l=i.getZ(n);a<o&&(o=a),a>d&&(d=a),s<c&&(c=s),s>f&&(f=s),l<h&&(h=l),l>p&&(p=l)}}return(l[n+0]!==o||l[n+1]!==c||l[n+2]!==h||l[n+3]!==d||l[n+4]!==f||l[n+5]!==p)&&(l[n+0]=o,l[n+1]=c,l[n+2]=h,l[n+3]=d,l[n+4]=f,l[n+5]=p,!0)}{const t=n+8,r=a[n+6],i=t+o,s=r+o;let u=c,d=!1,f=!1;e?u||(d=e.has(i),f=e.has(s),u=!d&&!f):(d=!0,f=!0);const p=u||f;let v=!1;(u||d)&&(v=h(t,o,u));let g=!1;p&&(g=h(r,o,u));const m=v||g;if(m)for(let e=0;e<3;e++){const i=t+e,o=r+e,a=l[i],s=l[i+3],c=l[o],u=l[o+3];l[n+e]=a<c?a:c,l[n+e+3]=s>u?s:u}return m}}}const ii=new u;function oi(t,e,n,r,i){lr.setBuffer(t._roots[e]),ai(0,t,n,r,i),lr.clearBuffer()}function ai(t,e,n,r,i){const{float32Array:o,uint16Array:a,uint32Array:s}=lr,l=2*t;if(On(l,a))!function(t,e,n,r,i,o){const{geometry:a,_indirectBuffer:s}=t;for(let t=r,l=r+i;t<l;t++)Dr(a,e,n,s?s[t]:t,o)}(e,n,r,Gn(t,s),zn(l,a),i);else{const a=Ln(t);kr(a,o,r,ii)&&ai(a,e,n,r,i);const l=Nn(t,s);kr(l,o,r,ii)&&ai(l,e,n,r,i)}}const si=new u,li=["x","y","z"];function ci(t,e,n,r){lr.setBuffer(t._roots[e]);const i=ui(0,t,n,r);return lr.clearBuffer(),i}function ui(t,e,n,r){const{float32Array:i,uint16Array:o,uint32Array:a}=lr;let s=2*t;if(On(s,o))return function(t,e,n,r,i){const{geometry:o,_indirectBuffer:a}=t;let s=1/0,l=null;for(let t=r,c=r+i;t<c;t++){let r;r=Dr(o,e,n,a?a[t]:t),r&&r.distance<s&&(l=r,s=r.distance)}return l}(e,n,r,Gn(t,a),zn(s,o));{const o=jn(t,a),s=li[o],l=r.direction[s]>=0;let c,u;l?(c=Ln(t),u=Nn(t,a)):(c=Nn(t,a),u=Ln(t));const h=kr(c,i,r,si)?ui(c,e,n,r):null;if(h){const t=h.point[s];if(l?t<=i[u+o]:t>=i[u+o+3])return h}const d=kr(u,i,r,si)?ui(u,e,n,r):null;return h&&d?h.distance<=d.distance?h:d:h||d||null}}const hi=new G,di=new rr,fi=new rr,pi=new H,vi=new ir,gi=new ir;function mi(t,e,n,r){lr.setBuffer(t._roots[e]);const i=yi(0,t,n,r);return lr.clearBuffer(),i}function yi(t,e,n,r,i=null){const{float32Array:o,uint16Array:a,uint32Array:s}=lr;let l=2*t;if(null===i&&(n.boundingBox||n.computeBoundingBox(),vi.set(n.boundingBox.min,n.boundingBox.max,r),i=vi),!On(l,a)){const a=t+8,l=s[t+6];return Un(a,o,hi),!!(i.intersectsBox(hi)&&yi(a,e,n,r,i)||(Un(l,o,hi),i.intersectsBox(hi)&&yi(l,e,n,r,i)))}{const i=e.geometry,c=i.index,u=i.attributes.position,h=n.index,d=n.attributes.position,f=Gn(t,s),p=zn(l,a);if(pi.copy(r).invert(),n.boundsTree)return Un(t,o,gi),gi.matrix.copy(pi),gi.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:t=>gi.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(r),t.b.applyMatrix4(r),t.c.applyMatrix4(r),t.needsUpdate=!0;for(let n=f,r=p+f;n<r;n++)if(Ar(fi,3*e.resolveTriangleIndex(n),c,u),fi.needsUpdate=!0,t.intersectsTriangle(fi))return!0;return!1}});for(let t=f,n=p+f;t<n;t++){const n=e.resolveTriangleIndex(t);Ar(di,3*n,c,u),di.a.applyMatrix4(pi),di.b.applyMatrix4(pi),di.c.applyMatrix4(pi),di.needsUpdate=!0;for(let t=0,e=h.count;t<e;t+=3)if(Ar(fi,t,h,d),fi.needsUpdate=!0,di.intersectsTriangle(fi))return!0}}}const _i=new H,xi=new ir,bi=new ir,wi=new u,Si=new u,Ti=new u,Ui=new u;function Mi(t,e,n,r={},i={},o=0,a=1/0){e.boundingBox||e.computeBoundingBox(),xi.set(e.boundingBox.min,e.boundingBox.max,n),xi.needsUpdate=!0;const s=t.geometry,l=s.attributes.position,c=s.index,u=e.attributes.position,h=e.index,d=sr.getPrimitive(),f=sr.getPrimitive();let p=wi,v=Si,g=null,m=null;i&&(g=Ti,m=Ui);let y=1/0,_=null,x=null;return _i.copy(n).invert(),bi.matrix.copy(_i),t.shapecast({boundsTraverseOrder:t=>xi.distanceToBox(t),intersectsBounds:(t,e,n)=>n<y&&n<a&&(e&&(bi.min.copy(t.min),bi.max.copy(t.max),bi.needsUpdate=!0),!0),intersectsRange:(r,i)=>{if(e.boundsTree){const s=e.boundsTree;return s.shapecast({boundsTraverseOrder:t=>bi.distanceToBox(t),intersectsBounds:(t,e,n)=>n<y&&n<a,intersectsRange:(e,a)=>{for(let b=e,w=e+a;b<w;b++){const e=s.resolveTriangleIndex(b);Ar(f,3*e,h,u),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let e=r,n=r+i;e<n;e++){const n=t.resolveTriangleIndex(e);Ar(d,3*n,c,l),d.needsUpdate=!0;const r=d.distanceToTriangle(f,p,g);if(r<y&&(v.copy(p),m&&m.copy(g),y=r,_=e,x=b),r<o)return!0}}}})}for(let a=0,s=xn(e);a<s;a++){Ar(f,3*a,h,u),f.a.applyMatrix4(n),f.b.applyMatrix4(n),f.c.applyMatrix4(n),f.needsUpdate=!0;for(let e=r,n=r+i;e<n;e++){const n=t.resolveTriangleIndex(e);Ar(d,3*n,c,l),d.needsUpdate=!0;const r=d.distanceToTriangle(f,p,g);if(r<y&&(v.copy(p),m&&m.copy(g),y=r,_=e,x=a),r<o)return!0}}}}),sr.releasePrimitive(d),sr.releasePrimitive(f),y===1/0?null:(r.point?r.point.copy(v):r.point=v.clone(),r.distance=y,r.faceIndex=_,i&&(i.point?i.point.copy(m):i.point=m.clone(),i.point.applyMatrix4(_i),v.applyMatrix4(_i),i.distance=v.sub(i.point).length(),i.faceIndex=x),r)}const Di=new lr.constructor,Ai=new lr.constructor,Ci=new or((()=>new G)),Pi=new G,Bi=new G,ki=new G,Fi=new G;let Ii=!1;function Ei(t,e,n,r,i,o=0,a=0,s=0,l=0,c=null,u=!1){let h,d;u?(h=Ai,d=Di):(h=Di,d=Ai);const f=h.float32Array,p=h.uint32Array,v=h.uint16Array,g=d.float32Array,m=d.uint32Array,y=d.uint16Array,_=2*e,x=On(2*t,v),b=On(_,y);let w=!1;if(b&&x)w=u?i(Gn(e,m),zn(2*e,y),Gn(t,p),zn(2*t,v),l,a+e,s,o+t):i(Gn(t,p),zn(2*t,v),Gn(e,m),zn(2*e,y),s,o+t,l,a+e);else if(b){const c=Ci.getPrimitive();Un(e,g,c),c.applyMatrix4(n);const h=Ln(t),d=Nn(t,p);Un(h,f,Pi),Un(d,f,Bi);const v=c.intersectsBox(Pi),m=c.intersectsBox(Bi);w=v&&Ei(e,h,r,n,i,a,o,l,s+1,c,!u)||m&&Ei(e,d,r,n,i,a,o,l,s+1,c,!u),Ci.releasePrimitive(c)}else{const h=Ln(e),d=Nn(e,m);Un(h,g,ki),Un(d,g,Fi);const v=c.intersectsBox(ki),y=c.intersectsBox(Fi);if(v&&y)w=Ei(t,h,n,r,i,o,a,s,l+1,c,u)||Ei(t,d,n,r,i,o,a,s,l+1,c,u);else if(v)if(x)w=Ei(t,h,n,r,i,o,a,s,l+1,c,u);else{const e=Ci.getPrimitive();e.copy(ki).applyMatrix4(n);const c=Ln(t),d=Nn(t,p);Un(c,f,Pi),Un(d,f,Bi);const v=e.intersectsBox(Pi),g=e.intersectsBox(Bi);w=v&&Ei(h,c,r,n,i,a,o,l,s+1,e,!u)||g&&Ei(h,d,r,n,i,a,o,l,s+1,e,!u),Ci.releasePrimitive(e)}else if(y)if(x)w=Ei(t,d,n,r,i,o,a,s,l+1,c,u);else{const e=Ci.getPrimitive();e.copy(Fi).applyMatrix4(n);const c=Ln(t),h=Nn(t,p);Un(c,f,Pi),Un(h,f,Bi);const v=e.intersectsBox(Pi),g=e.intersectsBox(Bi);w=v&&Ei(d,c,r,n,i,a,o,l,s+1,e,!u)||g&&Ei(d,h,r,n,i,a,o,l,s+1,e,!u),Ci.releasePrimitive(e)}}return w}const Ri=new ir,Oi=new G,Gi={strategy:0,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0};class zi{static serialize(t,e={}){e={cloneBuffers:!0,...e};const n=t.geometry,r=t._roots,i=t._indirectBuffer,o=n.getIndex();let a;return a=e.cloneBuffers?{roots:r.map((t=>t.slice())),index:o.array.slice(),indirectBuffer:i?i.slice():null}:{roots:r,index:o.array,indirectBuffer:i},a}static deserialize(t,e,n={}){n={setIndex:!0,indirect:Boolean(t.indirectBuffer),...n};const{index:r,roots:i,indirectBuffer:o}=t,a=new zi(e,{...n,[yn]:!0});if(a._roots=i,a._indirectBuffer=o||null,n.setIndex){const n=e.getIndex();if(null===n){const n=new q(t.index,1,!1);e.setIndex(n)}else n.array!==r&&(n.array.set(r),n.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((e=Object.assign({...Gi,[yn]:!1},e)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[yn]||(Kn(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new G)));const{_indirectBuffer:n}=this;this.resolveTriangleIndex=e.indirect?t=>n[t]:t=>t}refit(t=null){return(this.indirect?ri:Pr)(this,t)}traverse(t,e=0){const n=this._roots[e],r=new Uint32Array(n),i=new Uint16Array(n);!function e(o,a=0){const s=2*o,l=i[s+15]===gn;if(l){const e=r[o+6],c=i[s+14];t(a,l,new Float32Array(n,4*o,6),e,c)}else{const i=o+vn/4,s=r[o+6],c=r[o+7];t(a,l,new Float32Array(n,4*o,6),c)||(e(i,a+1),e(s,a+1))}}(0)}raycast(t,e=F){const n=this._roots,r=this.geometry,i=[],o=e.isMaterial,a=Array.isArray(e),s=r.groups,l=o?e.side:e,c=this.indirect?oi:Er;for(let r=0,o=n.length;r<o;r++){const n=a?e[s[r].materialIndex].side:l,o=i.length;if(c(this,r,n,t,i),a){const t=s[r].materialIndex;for(let e=o,n=i.length;e<n;e++)i[e].face.materialIndex=t}}return i}raycastFirst(t,e=F){const n=this._roots,r=this.geometry,i=e.isMaterial,o=Array.isArray(e);let a=null;const s=r.groups,l=i?e.side:e,c=this.indirect?ci:zr;for(let r=0,i=n.length;r<i;r++){const n=c(this,r,o?e[s[r].materialIndex].side:l,t);null!=n&&(null==a||n.distance<a.distance)&&(a=n,o&&(n.face.materialIndex=s[r].materialIndex))}return a}intersectsGeometry(t,e){let n=!1;const r=this._roots,i=this.indirect?mi:Xr;for(let o=0,a=r.length;o<a&&(n=i(this,o,t,e),!n);o++);return n}shapecast(t){const e=sr.getPrimitive(),n=this.indirect?Fr:Cr;let{boundsTraverseOrder:r,intersectsBounds:i,intersectsRange:o,intersectsTriangle:a}=t;if(o&&a){const t=o;o=(r,i,o,s,l)=>!!t(r,i,o,s,l)||n(r,i,this,a,o,s,e)}else o||(o=a?(t,r,i,o)=>n(t,r,this,a,i,o,e):(t,e,n)=>n);let s=!1,l=0;const c=this._roots;for(let t=0,e=c.length;t<e;t++){const e=c[t];if(s=fr(this,t,i,o,r,l),s)break;l+=e.byteLength}return sr.releasePrimitive(e),s}bvhcast(t,e,n){let{intersectsRanges:r,intersectsTriangles:i}=n;const o=sr.getPrimitive(),a=this.geometry.index,s=this.geometry.attributes.position,l=this.indirect?t=>{const e=this.resolveTriangleIndex(t);Ar(o,3*e,a,s)}:t=>{Ar(o,3*t,a,s)},c=sr.getPrimitive(),u=t.geometry.index,h=t.geometry.attributes.position,d=t.indirect?e=>{const n=t.resolveTriangleIndex(e);Ar(c,3*n,u,h)}:t=>{Ar(c,3*t,u,h)};if(i){const t=(t,n,r,a,s,u,h,f)=>{for(let p=r,v=r+a;p<v;p++){d(p),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let e=t,r=t+n;e<r;e++)if(l(e),o.needsUpdate=!0,i(o,c,e,p,s,u,h,f))return!0}return!1};if(r){const e=r;r=function(n,r,i,o,a,s,l,c){return!!e(n,r,i,o,a,s,l,c)||t(n,r,i,o,a,s,l,c)}}else r=t}return function(t,e,n,r){if(Ii)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Ii=!0;const i=t._roots,o=e._roots;let a,s=0,l=0;const c=(new H).copy(n).invert();for(let t=0,e=i.length;t<e;t++){Di.setBuffer(i[t]),l=0;const e=Ci.getPrimitive();Un(0,Di.float32Array,e),e.applyMatrix4(c);for(let i=0,u=o.length;i<u&&(Ai.setBuffer(o[t]),a=Ei(0,0,n,c,r,s,l,0,0,e),Ai.clearBuffer(),l+=o[i].length,!a);i++);if(Ci.releasePrimitive(e),Di.clearBuffer(),s+=i[t].length,a)break}return Ii=!1,a}(this,t,e,r)}intersectsBox(t,e){return Ri.set(t.min,t.max,e),Ri.needsUpdate=!0,this.shapecast({intersectsBounds:t=>Ri.intersectsBox(t),intersectsTriangle:t=>Ri.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,n={},r={},i=0,o=1/0){return(this.indirect?Mi:ni)(this,t,e,n,r,i,o)}closestPointToPoint(t,e={},n=0,r=1/0){return function(t,e,n={},r=0,i=1/0){const o=r*r,a=i*i;let s=1/0,l=null;if(t.shapecast({boundsTraverseOrder:t=>(vr.copy(e).clamp(t.min,t.max),vr.distanceToSquared(e)),intersectsBounds:(t,e,n)=>n<s&&n<a,intersectsTriangle:(t,n)=>{t.closestPointToPoint(e,vr);const r=e.distanceToSquared(vr);return r<s&&(gr.copy(vr),s=r,l=n),r<o}}),s===1/0)return null;const c=Math.sqrt(s);return n.point?n.point.copy(gr):n.point=gr.clone(),n.distance=c,n.faceIndex=l,n}(this,t,e,n,r)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach((e=>{Un(0,new Float32Array(e),Oi),t.union(Oi)})),t}}function Li(t){switch(t){case 1:return st;case 2:return at;case 3:case 4:return rt}}class Ni extends Z{constructor(){super(),this.minFilter=U,this.magFilter=U,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(t){const e=this.overrideItemSize,n=t.itemSize,r=t.count;if(null!==e){if(n*r%e!=0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");t.itemSize=e,t.count=r*n/e}const i=t.itemSize,o=t.count,a=t.normalized,s=t.array.constructor,l=s.BYTES_PER_ELEMENT;let c,u,h,d,f=this._forcedType,p=i;if(null===f)switch(s){case Float32Array:f=T;break;case Uint8Array:case Uint16Array:case Uint32Array:f=$;break;case Int8Array:case Int16Array:case Int32Array:f=K}let v=function(t){switch(t){case 1:return"R";case 2:return"RG";case 3:case 4:return"RGBA"}throw new Error}(i);switch(f){case T:h=1,u=function(t){switch(t){case 1:return ot;case 2:return it;case 3:case 4:return nt}}(i),a&&1===l?(d=s,v+="8",s===Uint8Array?c=Q:(c=tt,v+="_SNORM")):(d=Float32Array,v+="32F",c=T);break;case K:v+=8*l+"I",h=a?Math.pow(2,8*s.BYTES_PER_ELEMENT-1):1,u=Li(i),1===l?(d=Int8Array,c=tt):2===l?(d=Int16Array,c=et):(d=Int32Array,c=K);break;case $:v+=8*l+"UI",h=a?Math.pow(2,8*s.BYTES_PER_ELEMENT-1):1,u=Li(i),1===l?(d=Uint8Array,c=Q):2===l?(d=Uint16Array,c=J):(d=Uint32Array,c=$)}3!==p||u!==nt&&u!==rt||(p=4);const g=Math.ceil(Math.sqrt(o))||1,m=new d(p*g*g),y=t.normalized;t.normalized=!1;for(let e=0;e<o;e++){const n=p*e;m[n]=t.getX(e)/h,i>=2&&(m[n+1]=t.getY(e)/h),i>=3&&(m[n+2]=t.getZ(e)/h,4===p&&(m[n+3]=1)),i>=4&&(m[n+3]=t.getW(e)/h)}t.normalized=y,this.internalFormat=v,this.format=u,this.type=c,this.image.width=g,this.image.height=g,this.image.data=m,this.needsUpdate=!0,this.dispose(),t.itemSize=n,t.count=r}}class ji extends Ni{constructor(){super(),this._forcedType=$}}class Wi extends Ni{constructor(){super(),this._forcedType=T}}class Hi{constructor(){this.index=new ji,this.position=new Wi,this.bvhBounds=new Z,this.bvhContents=new Z,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(t){const{geometry:e}=t;if(function(t,e,n){const r=t._roots;if(1!==r.length)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const i=r[0],o=new Uint16Array(i),a=new Uint32Array(i),s=new Float32Array(i),l=i.byteLength/vn,c=2*Math.ceil(Math.sqrt(l/2)),u=new Float32Array(4*c*c),h=Math.ceil(Math.sqrt(l)),d=new Uint32Array(2*h*h);for(let t=0;t<l;t++){const e=t*vn/4,n=2*e,r=e;for(let e=0;e<3;e++)u[8*t+0+e]=s[r+0+e],u[8*t+4+e]=s[r+3+e];if(On(n,o)){const r=zn(n,o),i=Gn(e,a),s=4294901760|r;d[2*t+0]=s,d[2*t+1]=i}else{const n=4*Nn(e,a)/vn,r=jn(e,a);d[2*t+0]=r,d[2*t+1]=n}}e.image.data=u,e.image.width=c,e.image.height=c,e.format=nt,e.type=T,e.internalFormat="RGBA32F",e.minFilter=U,e.magFilter=U,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),n.image.data=d,n.image.width=h,n.image.height=h,n.format=at,n.type=$,n.internalFormat="RG32UI",n.minFilter=U,n.magFilter=U,n.generateMipmaps=!1,n.needsUpdate=!0,n.dispose()}(t,this.bvhBounds,this.bvhContents),this.position.updateFrom(e.attributes.position),t.indirect){const n=t._indirectBuffer;if(null===this._cachedIndexAttr||this._cachedIndexAttr.count!==n.length)if(e.index)this._cachedIndexAttr=e.index.clone();else{const t=bn(_n(e));this._cachedIndexAttr=new q(t,1,!1)}!function(t,e,n){const r=n.array,i=t.index?t.index.array:null;for(let t=0,n=e.length;t<n;t++){const n=3*t,o=3*e[t];for(let t=0;t<3;t++)r[n+t]=i?i[o+t]:o+t}}(e,n,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(e.index)}dispose(){const{index:t,position:e,bvhBounds:n,bvhContents:r}=this;t&&t.dispose(),e&&e.dispose(),n&&n.dispose(),r&&r.dispose()}}class Vi extends b{set envMap(t){var e,n;this.uniforms.envMap.value=t;const r=qi(t),i=(null!==(n=r?null===(e=t.image[0])||void 0===e?void 0:e.width:t.image.width)&&void 0!==n?n:1024)/4,o=Math.floor(Math.log2(i)),a=Math.pow(2,o),s=3*Math.max(a,112),l=4*a;r?this.defines.ENVMAP_TYPE_CUBEM="":delete this.defines.ENVMAP_TYPE_CUBEM,this.defines.CUBEUV_TEXEL_WIDTH=""+1/s,this.defines.CUBEUV_TEXEL_HEIGHT=""+1/l,this.defines.CUBEUV_MAX_MIP=`${o}.0`,this.needsUpdate=!0}get envMap(){return this.uniforms.envMap.value}set bounces(t){this.uniforms.bounces.value=t}get bounces(){return this.uniforms.bounces.value}set ior(t){this.uniforms.ior.value=t}get ior(){return this.uniforms.ior.value}set fresnel(t){this.uniforms.fresnel.value=t}get fresnel(){return this.uniforms.fresnel.value}set aberrationStrength(t){this.uniforms.aberrationStrength.value=t,t>0?this.defines.CHROMATIC_ABERRATIONS="":delete this.defines.CHROMATIC_ABERRATIONS,this.needsUpdate=!0}get aberrationStrength(){return this.uniforms.aberrationStrength.value}set color(t){this.uniforms.color.value.set(t)}get color(){return this.uniforms.color.value}constructor(t,e){const{resolution:n,cameraWorldMatrix:r,cameraProjectionMatrixInverse:i}=t.uniformsLib,{envMap:o,geometry:a,bounces:s=3,ior:l=2.4,fresnel:c=0,aberrationStrength:u=.01,color:h="#ffffff",fastChroma:d=!0}=e,f=new Hi;f.updateFrom(new zi(a.clone().toNonIndexed(),{lazyGeneration:!1,strategy:2})),super({uniforms:{envMap:{value:null},bounces:{value:s},ior:{value:l},fresnel:{value:c},aberrationStrength:{value:0},color:{value:new v(h)},correctMips:{value:!0},bvh:{value:f},resolution:n,viewMatrixInverse:r,projectionMatrixInverse:i},vertexShader:"    \n            uniform mat4 viewMatrixInverse;\n\n            varying vec3 vWorldPosition;  \n            varying vec3 vNormal;\n            varying mat4 vModelMatrixInverse;\n        \n            #ifdef USE_INSTANCING_COLOR\n                varying vec3 vInstanceColor;\n            #endif\n        \n            void main() {        \n                vec4 transformedNormal = vec4(normal, 0.0);\n                vec4 transformedPosition = vec4(position, 1.0);\n                #ifdef USE_INSTANCING\n                    transformedNormal = instanceMatrix * transformedNormal;\n                    transformedPosition = instanceMatrix * transformedPosition;\n                #endif\n            \n                #ifdef USE_INSTANCING\n                    vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);\n                #else\n                    vModelMatrixInverse = inverse(modelMatrix);\n                #endif\n            \n                #ifdef USE_INSTANCING_COLOR\n                    vInstanceColor = instanceColor.rgb;\n                #endif\n            \n                vWorldPosition = (modelMatrix * transformedPosition).xyz;\n                vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);\n                gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;\n            }",fragmentShader:"  \n            #define ENVMAP_TYPE_CUBE_UV\n            precision highp isampler2D;\n            precision highp usampler2D;\n            varying vec3 vWorldPosition;\n            varying vec3 vNormal;\n            varying mat4 vModelMatrixInverse;\n        \n            #ifdef USE_INSTANCING_COLOR\n                varying vec3 vInstanceColor;\n            #endif\n            \n            #ifdef ENVMAP_TYPE_CUBEM\n                uniform samplerCube envMap;\n            #else\n                uniform sampler2D envMap;\n            #endif\n            \n            uniform float bounces;\n            \nstruct BVH {\n\n\tusampler2D index;\n\tsampler2D position;\n\n\tsampler2D bvhBounds;\n\tusampler2D bvhContents;\n\n};\n\n            \n\t\n\n// A stack of uint32 indices can can store the indices for\n// a perfectly balanced tree with a depth up to 31. Lower stack\n// depth gets higher performance.\n//\n// However not all trees are balanced. Best value to set this to\n// is the trees max depth.\n#ifndef BVH_STACK_DEPTH\n#define BVH_STACK_DEPTH 60\n#endif\n\n#ifndef INFINITY\n#define INFINITY 1e20\n#endif\n\n// Utilities\nuvec4 uTexelFetch1D( usampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nivec4 iTexelFetch1D( isampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 texelFetch1D( sampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {\n\n\treturn\n\t\tbarycoord.x * texelFetch1D( tex, faceIndices.x ) +\n\t\tbarycoord.y * texelFetch1D( tex, faceIndices.y ) +\n\t\tbarycoord.z * texelFetch1D( tex, faceIndices.z );\n\n}\n\nvoid ndcToCameraRay(\n\tvec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,\n\tout vec3 rayOrigin, out vec3 rayDirection\n) {\n\n\t// get camera look direction and near plane for camera clipping\n\tvec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );\n\tvec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );\n\tfloat near = abs( nearVector.z / nearVector.w );\n\n\t// get the camera direction and position from camera matrices\n\tvec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );\n\tdirection /= direction.w;\n\tdirection = cameraWorld * direction - origin;\n\n\t// slide the origin along the ray until it sits at the near clip plane position\n\torigin.xyz += direction.xyz * near / dot( direction, lookDirection );\n\n\trayOrigin = origin.xyz;\n\trayDirection = direction.xyz;\n\n}\n\n\t\n\n#ifndef TRI_INTERSECT_EPSILON\n#define TRI_INTERSECT_EPSILON 1e-5\n#endif\n\n// Raycasting\nbool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {\n\n\t// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/\n\t// https://tavianator.com/2011/ray_box.html\n\tvec3 invDir = 1.0 / rayDirection;\n\n\t// find intersection distances for each plane\n\tvec3 tMinPlane = invDir * ( boundsMin - rayOrigin );\n\tvec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );\n\n\t// get the min and max distances from each intersection\n\tvec3 tMinHit = min( tMaxPlane, tMinPlane );\n\tvec3 tMaxHit = max( tMaxPlane, tMinPlane );\n\n\t// get the furthest hit distance\n\tvec2 t = max( tMinHit.xx, tMinHit.yz );\n\tfloat t0 = max( t.x, t.y );\n\n\t// get the minimum hit distance\n\tt = min( tMaxHit.xx, tMaxHit.yz );\n\tfloat t1 = min( t.x, t.y );\n\n\t// set distance to 0.0 if the ray starts inside the box\n\tdist = max( t0, 0.0 );\n\n\treturn t1 >= dist;\n\n}\n\nbool intersectsTriangle(\n\tvec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,\n\tout vec3 barycoord, out vec3 norm, out float dist, out float side\n) {\n\n\t// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d\n\tvec3 edge1 = b - a;\n\tvec3 edge2 = c - a;\n\tnorm = cross( edge1, edge2 );\n\n\tfloat det = - dot( rayDirection, norm );\n\tfloat invdet = 1.0 / det;\n\n\tvec3 AO = rayOrigin - a;\n\tvec3 DAO = cross( AO, rayDirection );\n\n\tvec4 uvt;\n\tuvt.x = dot( edge2, DAO ) * invdet;\n\tuvt.y = - dot( edge1, DAO ) * invdet;\n\tuvt.z = dot( AO, norm ) * invdet;\n\tuvt.w = 1.0 - uvt.x - uvt.y;\n\n\t// set the hit information\n\tbarycoord = uvt.wxy; // arranged in A, B, C order\n\tdist = uvt.z;\n\tside = sign( det );\n\tnorm = side * normalize( norm );\n\n\t// add an epsilon to avoid misses between triangles\n\tuvt += vec4( TRI_INTERSECT_EPSILON );\n\n\treturn all( greaterThanEqual( uvt, vec4( 0.0 ) ) );\n\n}\n\nbool intersectTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// outputs\n\tinout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord, localNormal;\n\tfloat localDist, localSide;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\tif (\n\t\t\tintersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )\n\t\t\t&& localDist < minDistance\n\t\t) {\n\n\t\t\tfound = true;\n\t\t\tminDistance = localDist;\n\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = localNormal;\n\n\t\t\tside = localSide;\n\t\t\tbarycoord = localBarycoord;\n\t\t\tdist = localDist;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\nbool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhIntersectFirstHit(\t\tbvh,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\t_bvhIntersectFirstHit(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\n\nbool _bvhIntersectFirstHit(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// output variables split into separate variables due to output precision\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat triangleDistance = INFINITY;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance;\n\t\tif (\n\t\t\t! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )\n\t\t\t|| boundsHitDistance > triangleDistance\n\t\t) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\n\t\t\tfound = intersectTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count,\n\t\t\t\trayOrigin, rayDirection, triangleDistance,\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, dist\n\t\t\t) || found;\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\n\t\t\tbool leftToRight = rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\n\n            uniform BVH bvh;\n            uniform float ior;\n            uniform bool correctMips;\n            uniform vec2 resolution;\n            uniform float fresnel;\n            uniform mat4 modelMatrix;\n            uniform mat4 projectionMatrixInverse;\n            uniform mat4 viewMatrixInverse;\n            uniform float aberrationStrength;\n            uniform vec3 color;\n        \n            float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {\n                return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );\n            }\n            \n            vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {\n                vec3 rayOrigin = ro;\n                vec3 rayDirection = rd;\n                rayDirection = refract(rayDirection, normal, 1.0 / ior);\n                rayOrigin = vWorldPosition + rayDirection * 0.001;\n                rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;\n                rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);\n                for(float i = 0.0; i < bounces; i++) {\n                    uvec4 faceIndices = uvec4( 0u );\n                    vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );\n                    vec3 barycoord = vec3( 0.0 );\n                    float side = 1.0;\n                    float dist = 0.0;\n                    bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );\n                    vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);      \n                    vec3 tempDir = refract(rayDirection, faceNormal, ior);\n                    if (length(tempDir) != 0.0) {\n                    rayDirection = tempDir;\n                    break;\n                    }\n                    rayDirection = reflect(rayDirection, faceNormal);\n                    rayOrigin = hitPos + rayDirection * 0.01;\n                }\n                rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);\n                return rayDirection;\n            }\n            \n            #include <common>\n            #include <cube_uv_reflection_fragment>\n            \n            #ifdef ENVMAP_TYPE_CUBEM\n                vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {\n                    return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));\n                }\n            #else\n                vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {\n                    vec2 uvv = equirectUv( rayDirection );\n                    vec2 smoothUv = equirectUv( directionCamPerfect );\n                    return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));\n                }\n            #endif\n        \n            void main() {\n                vec2 uv = gl_FragCoord.xy / resolution;\n                vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;\n                directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;\n                directionCamPerfect = normalize(directionCamPerfect);\n                vec3 normal = vNormal;\n                vec3 rayOrigin = cameraPosition;\n                vec3 rayDirection = normalize(vWorldPosition - cameraPosition);\n                vec3 finalColor;\n                #ifdef CHROMATIC_ABERRATIONS\n                    vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);\n                    #ifdef FAST_CHROMA \n                    vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));\n                    vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));\n                    #else\n                    vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);\n                    vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);\n                    #endif\n                    float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;\n                    float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;\n                    float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;\n                    finalColor = vec3(finalColorR, finalColorG, finalColorB);\n                #else\n                    rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);\n                    finalColor = textureGradient(envMap, rayDirection, directionCamPerfect).rgb;    \n                #endif\n            \n                finalColor *= color;\n                #ifdef USE_INSTANCING_COLOR\n                    finalColor *= vInstanceColor;\n                #endif\n            \n                vec3 viewDirection = normalize(vWorldPosition - cameraPosition);\n                float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;\n                gl_FragColor = vec4(mix(finalColor, vec3(1.0), nFresnel), 1.0);      \n                #include <tonemapping_fragment>\n                #include <colorspace_fragment>\n            }",fog:!1,lights:!1}),this.envMap=o,this.aberrationStrength=u,d&&(this.defines.FAST_CHROMA="")}}const qi=t=>t&&t.isCubeTexture;export{kt as CameraHelper,Nt as ContactShadows,It as DirectionalLightHelper,Wt as DiscardMaterial,dn as Floating,jt as Lightformer,Xt as MeshReflectorMaterial,Vi as MeshRefractionMaterial,Lt as OrbitController,Et as PointLightHelper,qt as ProgressiveShadows,Rt as RectAreaLightHelper,Yt as ReflectivePlane,Ot as SpotLightHelper,un as Text,hn as VolumetricCloud};
